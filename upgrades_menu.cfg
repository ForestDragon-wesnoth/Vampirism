#textdomain wesnoth-vampirism

#define ADD_VAMPIRE_UPGRADE_TO_LIST ID MIN_LEVEL SKILL_COST NAME DESCR ICON OTHER_PARAMS
    #this is the GLOBAL upgrade list, the "what upgrades has a specific vampire unlocked" data should be stored in unit variables instead
    [set_variables]
        name=vampirism_upgrades_list
        mode=append
        [value]
            id={ID}
            icon={ICON}
            name={NAME}
            descr={DESCR}
            full_descr="<span color='#ffff99'>"+{NAME}+"</span>: "+{DESCR}+$tmp_extra_note|
            #different text highlighting for unavailable upgrades
            full_descr_greyed="<span color='#999999'>"+{NAME}+"</span>: "+{DESCR}+$tmp_extra_note|
            skillpoint_cost={SKILL_COST}
            min_level={MIN_LEVEL}
            {OTHER_PARAMS}
        [/value]
    [/set_variables]
#enddef

#define HOPLITE_CREATE_CURRENT_UPGRADES_DIALOG_OPTIONS UNITVAR
    [foreach]
        array=vampirism_upgrades_list
        index_var=i
        [do]
            {IF_VAR {UNITVAR}.variables.vampire_upgrade_$this_item.id|_unlocked equals yes (
                [then]
                    [set_variables]
                        name=vampirism_currentupgrades_options
                        mode=append
                        [value]
                            image=$this_item.icon|
                            description=$this_item.full_descr|
                            [command]
                            [/command]
                        [/value]
                    [/set_variables]
                [/then]
            )}
        [/do]
    [/foreach]
#enddef

#define VAMPIRISM_GET_UPGRADE_NAME ID
    [foreach]
        array=vampirism_upgrades_list
        variable=this_item_get_upgrade
        index_var=i
        [do]
            [if]
                {VARIABLE_CONDITIONAL this_item_get_upgrade.id equals {ID}}
                [then]
                    {VARIABLE tmp_vampire_upgradename $this_item_get_upgrade.name}
                [/then]
            [/if]
        [/do]
    [/foreach]
#enddef

#define HOPLITE_CREATE_AVAILABLE_UPGRADES_DIALOG_OPTIONS UNITVAR
    [foreach]
        array=vampirism_upgrades_list
        index_var=i
        [do]
            {VARIABLE tmp_vampire_upgrade_greyedout no}
            {VARIABLE tmp_vampire_upgrade_greyedout_reason ""}

            {IF_VAR this_item.required_upgrades not_equals $emptyvar (
                [then]
                    #      [chat]
                    #         message="upgrade has requirements"
                    #      [/chat]
                    [set_variables]
                        name=tmp_required_upgrades_list
                        [split]
                            list=$this_item.required_upgrades
                            key=id
                            separator=,
                        [/split]
                    [/set_variables]

                    [foreach]
                        array=tmp_required_upgrades_list
                        index_var=e
                        [do]
                            #      [chat]
                            #         message="requirement id: $this_item.id|"
                            #      [/chat]

                            {IF_VAR {UNITVAR}.variables.vampire_upgrade_$this_item.id|_unlocked not_equals yes (
                                [then]
                                    {VARIABLE_OP tmp_missing_upgrades add 1}
                                [/then]
                            )}
                        [/do]
                    [/foreach]

                    {IF_VAR tmp_missing_upgrades greater_than 0 (
                        [then]

                            [foreach]
                                array=tmp_required_upgrades_list
                                index_var=e
                                [do]

                                    {IF_VAR tmp_requiredupgrades_text equals "" (
                                        [else]
                                            {VARIABLE tmp_requiredupgrades_text "$tmp_requiredupgrades_text|,"}
                                        [/else]
                                    )}

                                    {VAMPIRISM_GET_UPGRADE_NAME $this_item.id}

                                    {IF_VAR {UNITVAR}.variables.vampire_upgrade_$this_item.id|_unlocked equals yes (
                                        [then]
                                            {VARIABLE tmp_requiredupgrades_text _"$tmp_requiredupgrades_text|<span color='#99ff66'>$tmp_vampire_upgradename|</span>"}
                                        [/then]
                                        [else]
                                            {VARIABLE tmp_requiredupgrades_text _"$tmp_requiredupgrades_text|<span color='#ff6666'>$tmp_vampire_upgradename|</span>"}
                                        [/else]
                                    )}

                                    {CLEAR_VARIABLE tmp_vampire_upgradename}
                                [/do]
                            [/foreach]

                            {VARIABLE tmp_vampire_upgrade_greyedout yes}
                            {VARIABLE tmp_vampire_upgrade_greyedout_reason _"this upgrade requires the following upgrades: $tmp_requiredupgrades_text|"}
                [/then]
                )}
                {CLEAR_VARIABLE tmp_requiredupgrades_text}
                {CLEAR_VARIABLE tmp_required_upgrades_list}
                {CLEAR_VARIABLE tmp_missing_upgrades}
            [/then]
            )}

            {IF_VAR this_item.min_level greater_than ${UNITVAR}.variables.vampirism_level (
            [then]
                {VARIABLE tmp_vampire_upgrade_greyedout yes}
                {VARIABLE tmp_vampire_upgrade_greyedout_reason _"<span color='#ff9999'>You need a higher vampire level to buy this upgrade</span>"}
            [/then]
            )}

            {IF_VAR {UNITVAR}.variables.vampire_upgrade_$this_item.id|_unlocked not_equals yes (
                [then]


                {IF_VAR tmp_vampire_upgrade_greyedout equals yes (
                [then]
                    {IF_VAR vampirism_show_greyed_upgrades_for_side$side_number equals yes (
                    [then]
                    [set_variables]
                        name=vampirism_available_upgrades_options
                        mode=append
                        [value]
                            image=$this_item.icon|+"~GS()"
                            description=$this_item.full_descr_greyed|+_"            
Costs <span color='#ffff99'>$this_item.skillpoint_cost|</span> skill points, requires vampire level <span color='#ffff99'>$this_item.min_level|</span> or above
"+$tmp_vampire_upgrade_greyedout_reason|
                            [command]
                            [/command]
                        [/value]
                    [/set_variables]
                    [/then]
                    )}
                [/then]
                [else]
                    [set_variables]
                        name=vampirism_available_upgrades_options
                        mode=append
                        [value]
                            image=$this_item.icon|
                            description=$this_item.full_descr|+_"            
Costs <span color='#ffff99'>$this_item.skillpoint_cost|</span> skill points, requires vampire level <span color='#ffff99'>$this_item.min_level|</span> or above"
                            [command]
#                            	[chat]
#                            		message=_"applying upgrade $this_item.id| to id ${UNITVAR}.id|"
#                            	[/chat]
								{IF_VAR {UNITVAR}.variables.vampirism_skillpoints greater_than_equal_to $this_item.skillpoint_cost (
								[then]
    							[modify_unit]
    							    [filter]
    							        id=${UNITVAR}.id
    							    [/filter]
    							    #unlock the upgrade and spend the skillpoints
    							    {VARIABLE vampire_upgrade_$this_item.id|_unlocked yes}
	         						{VARIABLE_OP vampirism_skillpoints sub $this_item.skillpoint_cost}
    							[/modify_unit]
                                {VARIABLE tmp_vampire_current_upgrade_id $this_item.id}
                                {VARIABLE tmp_vampire_unit_id ${UNITVAR}.id}
                                [fire_event]
                                    id=vampire_upgrade_effect_event
                                [/fire_event]
								[/then]
								[else]
						            [message]
						                speaker=narrator
						                caption=_"Vampirism Menu"
						                side_for=$side_number
						                message=_"Not enough skill points for this upgrade!"
						            [/message]
								[/else]
								)}

                            [/command]
                        [/value]
                    [/set_variables]
                [/else]
                )}

                [/then]
            )}
            {CLEAR_VARIABLE tmp_vampire_upgrade_greyedout}
            {CLEAR_VARIABLE tmp_vampire_upgrade_greyedout_reason}
        [/do]
    [/foreach]
#enddef

#define VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM ID
    [modify_unit]
        [filter]
            id=$tmp_vampire_unit_id
        [/filter]
        {VARIABLE vampirism_can_use_power_in_batform_{ID} yes}
    [/modify_unit]
#enddef

#define VAMPIRE_UPGRADE_ALLOW_POWER_IN_SLUMBER ID
    [modify_unit]
        [filter]
            id=$tmp_vampire_unit_id
        [/filter]
        {VARIABLE vampirism_can_use_power_in_slumber_{ID} yes}
    [/modify_unit]
#enddef


[event]
    name=prestart
    id=vampirism_set_variables
    first_time_only=no
    #reset the upgrade list every scenario
    {CLEAR_VARIABLE vampirism_upgrades_list}
#for campaigns, these variables only need to be defined once
#    {ADD_VAMPIRE_UPGRADE_TO_LIST ID 1 1 NAME DESCR ICON (
#        required_upgrades=
#    )}

#general blood upgrades are at the top

    {ADD_VAMPIRE_UPGRADE_TO_LIST blood_capacity1 2 1 _"Blood Capacity I" _"Passive: +<span color='#ff0000'>10</span> max Blood." icons/blood-magic-1.png ()}
    {ADD_VAMPIRE_UPGRADE_TO_LIST blood_capacity2 5 2 _"Blood Capacity II" _"Passive: +<span color='#ff0000'>10</span> max Blood." icons/blood-magic-2.png (
        required_upgrades=blood_capacity1
    )}
    {ADD_VAMPIRE_UPGRADE_TO_LIST blood_capacity3 8 3 _"Blood Capacity III" _"Passive: +<span color='#ff0000'>15</span> max Blood." icons/blood-magic-3.png (
        required_upgrades=blood_capacity2
    )}
    {ADD_VAMPIRE_UPGRADE_TO_LIST blood_capacity4 10 4 _"Blood Capacity IV" _"Passive: +<span color='#ff0000'>20</span> max Blood." icons/blood-magic-3.png (
        required_upgrades=blood_capacity3
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST predator1 3 1 _"Predator I" _"Passive: gain 8 blood per turn in villages instead of 6, Great Feast gives 48 blood instead of 36." icons/horror-red-1.png ()}
    {ADD_VAMPIRE_UPGRADE_TO_LIST predator2 6 2 _"Predator II" _"Passive: gain 10 blood per turn in villages instead of 8, Great Feast gives 60 blood instead of 48." icons/horror-redalt-2.png (
        required_upgrades=predator1
    )}
    {ADD_VAMPIRE_UPGRADE_TO_LIST predator3 8 3 _"Predator III" _"Passive: gain 12 blood per turn in villages instead of 8, Great Feast gives 72 blood instead of 60." icons/horror-redalt-3.png (
        required_upgrades=predator2
    )}

#vampire strength has been rebalanced, so instead of the old "+10% stats every levelup" system, now it's "+5% stats every levelup, and you need to spend stats"
    {ADD_VAMPIRE_UPGRADE_TO_LIST strength1 1 1 _"Vampiric Strength" _"Passive: gain +2 vampire strength
(every 1 vampire strength gives +5% HP/damage, stacks additively)
you also already have 1 vampire strength per 1 vampire level)
every 10 vampire strength gives you +1 normal level" "attacks/fist.png" ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST strength2 4 2 _"Vampiric Strength II" _"Passive: gain +3 vampire strength
(every 1 vampire strength gives +5% HP/damage, stacks additively)
you also already have 1 vampire strength per 1 vampire level)
every 10 vampire strength gives you +1 normal level" "attacks/fist.png" (
        required_upgrades=strength1
    )}
    {ADD_VAMPIRE_UPGRADE_TO_LIST strength3 8 3 _"Vampiric Strength III" _"Passive: gain +5 vampire strength
(every 1 vampire strength gives +5% HP/damage, stacks additively)
you also already have 1 vampire strength per 1 vampire level)
every 10 vampire strength gives you +1 normal level" "attacks/fist.png" (
        required_upgrades=strength2
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST refined_taste 3 2 _"Refined Taste" _"Passive: 
every time you kill a living enemy leader with a drain attack
you gain additional Vampire XP equal to 24 times the enemy level
And your max Blood is increased by 2" icons/fangs-vampire.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST thrill_of_battle 5 1 _"Thrill of Battle" _"Passive: gain more vampire xp from kills
(for normal kills, you now get 12 per level instead of 8 per level)
(for drain kills, you now get 16 per level instead of 12 per level)" attacks/sword-steel.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST blood_reaper 6 3 _"Blood Reaper" _"Passive: when hitting an enemy with a non-drain attack
Gain Blood equal to 20% of the damage dealt" icons/scimitar-blood.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST drain_minions 3 2 _"Drain Minions" _"Passive:
if you are standing next to at least 3 living units of your side
gain Blood at the start of the turn
as if you were standing in a village
(does NOT stack with blood from villages)" icons/fangs-vampire.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST batform 3 2 _"Bat Form" _"Power: transform into a bat until manually toggled off. 
bat type depends on unit level (not vampire level)
Costs <span color='#ff0000'>10</span> Blood." icons/haste-fire-3.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST bat_strength 4 1 _"Bat Strength" _"Passive: when in bat form:
+20% fangs damage and +15% HP." icons/haste-fire-2.png (
        required_upgrades=batform
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST bat_strength2 7 2 _"Bat Strength II" _"Passive: when in bat form:
+20% fangs damage, +1 MP and +15% HP
(stacks with previous Bat Strength upgrades)" icons/haste-fire-3.png (
        required_upgrades=bat_strength
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST bat_skirmisher 5 2 _"Bat Maneuvers" _"Passive: when in bat form:
gain skirmisher ability" icons/haste-fire-2.png (
        required_upgrades=batform
    )}

#TODO: update the list of bat powers I/II/III as new powers get added, keep it within reasonable limits of what a bat could do on powers I, while more open powers II/III.
    {ADD_VAMPIRE_UPGRADE_TO_LIST batpowers1 4 1 _"Bat Powers I" _"Passive: Can use the following powers in bat form: 
Blood Surge, Blood Shield, Frenzy, Unnatural Sprint, Bat Swarm, Cloak of Darkness, Predator Vision" icons/haste-royal-1.png (
        required_upgrades=batform
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST batpowers2 6 1 _"Bat Powers II" _"Passive: Can use the following powers in bat form: 
Curse of Misfortune, Blood Bolt, Terrify, Corrupt, Raise Undead, Bind Soul" icons/haste-royal-2.png (
        required_upgrades=batpowers1
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST batpowers3 8 2 _"Bat Powers III" _"Passive: Can use the following powers in bat form: 
Carnage, Flesh Crafting, Bone Guard, Great Feast, Horror, Siring" icons/haste-royal-3.png (
        required_upgrades=batpowers2
    )}

#used to be 1-cost, but bumped it up to 2-cost to not be an early autopick
    {ADD_VAMPIRE_UPGRADE_TO_LIST agility 2 2 _"Vampiric Agility" _"Passive: +1 MP" icons/haste-fire-1.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST bloodsurge 1 1 _"Blood Surge" _"Power: Gain +33% damage to all attacks until your next turn. 
Costs <span color='#ff0000'>8</span> Blood." icons/wild-blood-3.png ()}

#now that Bat Form got nerfed to not be instantly available of lvl1, this new power basically fills the early game mobility Power niche, and useful for turns when you don't want to switch to batform
    {ADD_VAMPIRE_UPGRADE_TO_LIST unnatural_sprint 1 1 _"Unnatural Sprint" _"Power: Gain +2 MP until the end of your turn. 
(can be used even after attacking, to move away)
Costs <span color='#ff0000'>8</span> Blood." icons/boots_elven.png ()}

#extra tier of unnatural speed, to make it a bit more competitive with Bat Form
    {ADD_VAMPIRE_UPGRADE_TO_LIST unnatural_sprint2 5 2 _"Unnatural Sprint II" _"Unnatural Sprint power now gives +3 MP instead of +2" icons/boots_elven.png (
        required_upgrades=unnatural_sprint
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST unnatural_sprint3 8 3 _"Unnatural Sprint III" _"Unnatural Sprint power now gives +4 MP instead of +3" icons/boots_elven.png (
        required_upgrades=unnatural_sprint2
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST bloodshield 2 1 _"Blood Shield" _"Power: Gain +20% to most resistances (except arcane) until your next turn. 
Costs <span color='#ff0000'>8</span> Blood." icons/protect-red-1.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST bloodshield2 4 1 _"Blood Shield II" _"Blood Shield now also increases arcane resistance by 20%
And reduces sunlight damage by 35%
(while the Power is active)" icons/protect-red-2.png (
        required_upgrades=bloodshield
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST sun_resistance 3 2 _"Sunlight Resistance" _"Passive: takes 25% less damage from sunlight
(resistance stacks multiplicatively with Blood Shield II)" icons/protect-sky-2.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST sun_resistance2 6 3 _"Sunlight Resistance II" _"Passive: Sunlight resistance is now 50% instead of 25%
Sunlight damage can no longer kill (now it can only reduce HP to 1, like poison)
(resistance stacks multiplicatively with Blood Shield II)" icons/protect-sky-2.png (
        required_upgrades=sun_resistance
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST sun_resistance3 8 4 _"Daywalker" _"Passive: Sunlight resistance is now 66% instead of 50%
You no longer have the 25% damage penalty at daylight from being a vampire
(however, this does not remove the normal Chaotic alignment damage penalty)
you can now use Great Feast at daytime
and you now gain full blood when drinking blood from villages at daytime
(resistance stacks multiplicatively with Blood Shield II)" icons/protect-sky-3.png (
        required_upgrades=sun_resistance2
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST frenzy 1 1 _"Frenzy" _"Power: Spend <span color='#ff0000'>ALL remaining</span> Blood
This activates Hunger (like when running out of Blood normally)
which allows you to have Berserk on your bite attack 
but also has major downsides (in the 'hungry' ability), until you gain enough Blood again" "icons/horror-redalt-2.png" ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST frenzy2 4 2 _"Controlled Rage" _"Passive: when you are Hungry
instead of having -66% damage to all non-drain attacks
the penalty is now only -25%" "icons/wild-blood-3.png" (
        required_upgrades=frenzy
    )}

#BLOODHEAL IS AN UNUSED POWER FOR NOW, I TEMPORARILY COMMENTED OUT THE UPGRADE in the upgrade file!!!
#(the code works, it's just that I decided to make players need drain or Slumber heal well, and bloodheal messes with that balance)
#    {ADD_VAMPIRE_UPGRADE_TO_LIST bloodheal 1 1 _"Blood Heal" _"Power: Spend as much Blood as possible to heal yourself
#at a cost of 1 Blood per 1 hitpoint.
#(for example, if you are at 10/50 HP and have 10 blood, you will spend all 10 blood and be healed to 20 HP, if you have 45/50 HP and have 10 blood, you will spend 5 blood to heal 5 HP)" icons/potion_red_medium.png ()}


#this upgrade is specifically normal-form-only, otherwise Bat Strength would be either OP or redundant
    {ADD_VAMPIRE_UPGRADE_TO_LIST bite_damage 4 2 _"Powerful Bite" _"Passive: bite attack gains +25% damage
(does NOT apply to Bat Form)" attacks/fangs.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST bite_chancetohit 3 1 _"Quick Bite" _"Passive: bite attack gains +10% accuracy
(applies both to normal form and bat form)" attacks/fangs.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST bite_plague 4 1 _"Raise the Drained" _"Passive: bite attack gains plague special
(applies both to normal form and bat form)" attacks/fangs.png ()}

#I changed the upgrade description to "a lot of blood" since otherwise I'd have to rewrite code for proper variable substitution. The actual power menu still shows the correct blood amount
    {ADD_VAMPIRE_UPGRADE_TO_LIST greatfeast 6 3 _"Great Feast" _"Power: permanently destroy the village you are standing on 
to gain a lot of Blood and heal 25 HP.
(cannot feast during daytime unless you have Daywalker upgrade)" icons/horror-redalt-3.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST carnage 8 4 _"Carnage" _"Attack 1 more time this turn
attacks only consume 4 MP instead of all MP until the end of the turn
Gain skirmisher until the end of the turn
Costs <span color='#ff0000'>35</span> Blood." "icons/astralblade-red.png" ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST ultimate_carnage 10 5 _"Ultimate Carnage" _"Passive: while Carnage is active
killing an enemy allows using Carnage again, and restores 2 MP." "icons/astralblade-red.png" (
        required_upgrades=carnage
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST predatorvision 1 1 _"Predator Vision" _"Power: In a 10-tile radius, reveal invisible enemies and clear fog/shroud
(works even through walls)
Costs <span color='#ff0000'>8</span> Blood." "icons/evil-eye-eerie-1.png" ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST predatorvision2 5 2 _"Predator Vision II" _"Predator Vision radius increased from 10 to 15 tiles" "icons/evil-eye-eerie-2.png" (
        required_upgrades=predatorvision
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST predatorvision3 8 3 _"Predator Vision III" _"Predator Vision radius increased from 15 to 22 tiles" "icons/evil-eye-eerie-3.png" (
        required_upgrades=predatorvision2
    )}

#blood magic upgrades:

    {ADD_VAMPIRE_UPGRADE_TO_LIST blood_bolt 2 1 _"Blood Bolt" _"Power: gain a magical fire ranged attack until the end of the turn
(Blood Bolt gains bonus damage if you already have a ranged attack with the 'magical' special
EXCEPT for other vampire magical attacks)
Costs <span color='#ff0000'>10</span> Blood." "icons/blood-explosion.png" ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST drain_attack 3 2 _"Drain Life" _"Passive: gains a ranged magical cold attack with drain." icons/blood-magic-2.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST drain_aura 6 2 _"Drain Aura" _"Passive: gain 'drain aura' ability
(every turn, deal damage equal to your vampire level to all adjacent enemies
then gain Blood and heal HP equal to 50% of the total damage dealt)

also gain 25% more damage on the Drain Life attack" icons/blood-magic-3.png (
        required_upgrades=drain_attack
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST crimson_lightning 8 4 _"Crimson Lightning" _"Power: deal heavy damage to a target
range: 4 tiles
damage scales with unit level and vampire level
can only be used if you can still attack this turn
Costs <span color='#ff0000'>30</span> Blood." "icons/blood-lightning.png" ()}

#fleshcrafting upgrades:

    {ADD_VAMPIRE_UPGRADE_TO_LIST fleshcrafting 6 3 _"Flesh Crafting" _"Power: permanently modify an adjacent allied unit
you can choose various modifications from a list
each modification has upsides and downsides
only works on living units
Blood cost depends on the option" "icons/fleshcrafting.png" ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST fleshcrafting_undead 7 1 _"Shape Dead Flesh" _"Passive: Flesh Crafting power now can be used on vampires
it can now also be used on self
and it can be used on fleshy undead (Walking Corpses, Ghouls, and their advancements)

Passive: can recruit Ghouls if this vampire is a leader" "icons/fleshcrafting.png" (
        required_upgrades=fleshcrafting
    )}

#summon upgrades:

    #blood cost formulas are based on original gold costs but multiplied (group summons often have a discount, some powerful-but-cheap units like Revenant got an increased cost instead, etc.)

    #price multiplier relative to gold: 0.9
    {ADD_VAMPIRE_UPGRADE_TO_LIST raiseundead 1 1 _"Raise Undead" _"Power: Summon 2 Walking Corpses. Costs <span color='#ff0000'>14</span> Blood.

Passive: can recruit Walking Corpses if this vampire is a leader" attacks/touch-zombie.png ()}

    #price multiplier relative to gold: 1
    {ADD_VAMPIRE_UPGRADE_TO_LIST summonghost 3 1 _"Bind Soul" _"Power: Summon a Ghost. Costs <span color='#ff0000'>19</span> Blood.

Passive: can recruit Ghosts if this vampire is a leader" attacks/wail.png (
        required_upgrades=raiseundead
    )}

#bone guard stays at 3 point cost due to being a rather powerful skill

#price multiplier relative to gold: 1.2 (intentionally pricier since they are quite a strong summon compared to corpses/bats due to their physical resistances and starting at lvl2)
    {ADD_VAMPIRE_UPGRADE_TO_LIST summon_boneguard 6 3 _"Bone Guard" _"Power: Summon a Revenant. Costs <span color='#ff0000'>33</span> Blood.
additional Power: Summon a Bone Shooter. Costs <span color='#ff0000'>29</span> Blood.

Passive: can recruit Skeletons and Skeleton Archers if this vampire is a leader" attacks/axe-undead.png (
        required_upgrades=raiseundead
    )}

    #TODO: maybe redesign this upgrade to be more interesting

    #price multiplier relative to gold: 0.8

    {ADD_VAMPIRE_UPGRADE_TO_LIST summonundeadhorde 8 4 _"Undead Horde" _"Power: Summon 2 Soulless, 2 Skeletons, and 2 Skeleton Archers.
Costs <span color='#ff0000'>65</span> Blood.

Passive: can recruit Soulless if this vampire is a leader" attacks/fist-skeletal.png (
        required_upgrades=raiseundead
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST summonundeadlvl3 10 5 _"Champion of Undeath" _"Power: Summon either a Draug, Banebow, Spectre, Nightgaunt or Death Knight.
If you have the Flesh Crafting upgrade, you can also summon a Ghast
Blood Cost depends on the chosen unit." attacks/baneblade.png (
        required_upgrades=summon_boneguard,summonghost
    )}

    #price multiplier relative to gold: 0.65

    {ADD_VAMPIRE_UPGRADE_TO_LIST batswarm 3 1 _"Bat Swarm" _"Power: Summon 3 Vampire Bats. Costs <span color='#ff0000'>25</span> Blood.

Passive: can recruit Vampire Bats if this vampire is a leader" attacks/fangs-animal.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST cloakofdarkness 4 2 _"Cloak of Darkness" _"Power: gain nightstalk and skirmisher until your next turn. 
Costs <span color='#ff0000'>10</span> Blood." icons/fog-magenta-1.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST concealment 3 1 _"The Masquerade" _"Passive: gains <span color='#ffff99'>concealment</span> ability.
(applies to bat form too)" icons/cloak_leather_brown.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST darkens 8 4 _"Engulf in Darkness" _"Power: gain darkens ability until your next turn.
Costs <span color='#ff0000'>30</span> Blood." icons/vampire-darken-aura.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST curseofmisfortune 1 1 _"Curse of Misfortune" _"Power: Select an enemy in a 2-tile range
Target has 10% less defense and chance to hit until the end of their next turn
Can be used multiple times per turn
Costs <span color='#ff0000'>5</span> Blood." icons/horror-eerie-1.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST corrupt 3 1 _"Corrupt" _"Power: make an adjacent ally Chaotic permanently
Costs <span color='#ff0000'>20</span> Blood." icons/evil-eye-eerie-2.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST terrify 4 2 _"Terrify" _"Power: Select an enemy in a 2-tile range
Target's attacks become defend-only until the end of their next turn
AI-controlled targets will run away
Can only target enemies of a lower level than you
Cannot target fearless or most non-living units
Costs <span color='#ff0000'>8</span> Blood multiplied by enemy level (4 for level 0 enemies)." icons/horror-eerie-2.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST horror 8 4 _"Horror" _"Power: Terrify nearby enemies in a 2-tile radius
Terrified unit attacks become defend-only until the end of their next turn
AI-controlled enemies will run away
Only works on enemies who are level 2 or lower
Cannot affect fearless or most non-living units
Costs <span color='#ff0000'>35</span> Blood" icons/horror-eerie-3.png (
        required_upgrades=terrify
    )}

#TODO: maybe add some bonus effect if the unit already had leadership? (the leadership object should still apply, just in case the unit levels up into a non-leadership unit)
#UPD: though tbf, same can be argued about concealment
#UPD: maybe instead have a "concealment/leadership upgrades simply don't show up if you already have those abilities"
#UPD: I decided to keep it as is, since "gain the ability in bat form" is a pretty big upside anyway
    {ADD_VAMPIRE_UPGRADE_TO_LIST leadership 5 2 _"Leadership" _"Passive: gains <span color='#ffff99'>leadership</span> ability.
(applies to bat form too)" icons/evil-eye-red-2.png ()}

    {ADD_VAMPIRE_UPGRADE_TO_LIST enthrall 8 4 _"Enthrall" _"Power: Turn an adjacent enemy to your side
(does not work on leaders)
Costs <span color='#ff0000'>30</span> Blood multiplied by enemy level (15 for level 0 enemies)." icons/evil-eye-red-3.png ()}

#TODO: implement this
#    {ADD_VAMPIRE_UPGRADE_TO_LIST enthrall 10 5 _"Ruler of Mortals" _"Passive:
#
#
#
#
#if you Enthrall the same unit type at least 7 times with this vampire
#then this vampire becomes able to recruit that unit type
#(Enthralled enemies from before taking this upgrade are still counted)
#
#if it was a non-leader this unit becomes a leader (able to recruit)" icons/evil-eye-red-3.png (
#        required_upgrades=enthrall,leadership
#    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST siring 5 2 _"Siring" _"Power: turn an adjacent ally into a vampire
Costs <span color='#ff0000'>50</span> Blood." icons/fangs-vampire.png ()}

#siring upgrades are intentionally cheaper than normal:

    {ADD_VAMPIRE_UPGRADE_TO_LIST siring2 7 1 _"Siring II" _"Passive: vampires sired by you start at level 2" icons/fangs-vampire.png (
        required_upgrades=siring
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST siring3 9 2 _"Siring III" _"Passive: vampires sired by you start at level 3" icons/fangs-vampire.png (
        required_upgrades=siring2
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST siring4 10 3 _"Siring IV" _"Passive: vampires sired by you start at level 4" icons/fangs-vampire.png (
        required_upgrades=siring3
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST mentor 6 2 _"Mentor" _"Passive: adjacent allied vampires gain 4 Vampire XP every turn
only works if the adjacent vampire's vampire level is lower than the mentor's
having multiple Mentors next to one vampire does NOT stack, only the best Mentor matters" icons/book2.png (
        required_upgrades=siring
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST mentor2 8 3 _"Mentor II" _"Passive: Mentor gives 6 Vampire XP per turn instead of 3.
Additionally, any adjacent allies get 2 normal XP per turn
(units receive the 2 normal XP even if they are not vampires, as long as the unit's level (normal level, not vampire level) is lower than this unit's level)" icons/book2.png (
        required_upgrades=mentor
    )}

    {ADD_VAMPIRE_UPGRADE_TO_LIST mentor3 10 4 _"Mentor III" _"Passive: Mentor gives 9 Vampire XP per turn instead of 6.
And 3 normal XP instead of 2" icons/book2.png (
        required_upgrades=mentor2
    )}
[/event]

#define VAMPIRISM_BATFORM_REMOVE_EXCLUSIVE_UPGRADES ID
    [remove_object]
        id={ID}
        object_id=vampire_batform_effect_bat_strength
    [/remove_object]
    [remove_object]
        id={ID}
        object_id=vampire_batform_effect_bat_strength2
    [/remove_object]
    [remove_object]
        id={ID}
        object_id=vampire_batform_effect_bat_skirmisher
    [/remove_object]
#enddef

#define VAMPIRISM_BATFORM_APPLY_EXCLUSIVE_UPGRADES ID
    {VAMPIRISM_BATFORM_REMOVE_EXCLUSIVE_UPGRADES {ID}}
    [object]
        silent=yes
        duration=forever
        id=vampire_batform_effect_bat_strength
        take_only_once=no
        [filter]
            id={ID}
            [and]
                ability=vampirism_dummy_bat_strength
            [/and]
            [and]
                ability=vampire_batform
            [/and]
        [/filter]
#bat strength 1 has been nerfed a bit, to not give MP, now that Unnatural Sprint exists
#        [effect]
#            apply_to=movement
#            increase=1
#        [/effect]
        [effect]
            apply_to=hitpoints
            increase=15%
            increase_total=15%
        [/effect]
        [effect]
            apply_to=attack
            name=batform_fangs
            increase_damage=20%
        [/effect]
    [/object]
    [object]
        silent=yes
        duration=forever
        id=vampire_batform_effect_bat_strength2
        take_only_once=no
        [filter]
            id={ID}
            [and]
                ability=vampirism_dummy_bat_strength2
            [/and]
            [and]
                ability=vampire_batform
            [/and]
        [/filter]
        [effect]
            apply_to=movement
            increase=1
        [/effect]
        [effect]
            apply_to=hitpoints
            increase=15%
            increase_total=15%
        [/effect]
        [effect]
            apply_to=attack
            name=batform_fangs
            increase_damage=20%
        [/effect]
    [/object]
    [object]
        silent=yes
        duration=forever
        id=vampire_batform_effect_bat_skirmisher
        take_only_once=no
        [filter]
            id={ID}
            [and]
                ability=vampirism_dummy_bat_skirmisher
            [/and]
            [and]
                ability=vampire_batform
            [/and]
        [/filter]
        [effect]
            apply_to=new_ability
            [abilities]
                {ABILITY_SKIRMISHER}
            [/abilities]
        [/effect]
    [/object]
#enddef


[event]
    id=vampire_upgrade_effect_event
    first_time_only=no
    [switch]
        variable=tmp_vampire_current_upgrade_id
        [case]
            value=blood_capacity1
    		[modify_unit]
    		    [filter]
    		        id=$tmp_vampire_unit_id
    		    [/filter]
    		    {VARIABLE_OP vampirism_max_blood add 10}
    		[/modify_unit]
        [/case]
        [case]
            value=blood_capacity2
    		[modify_unit]
    		    [filter]
    		        id=$tmp_vampire_unit_id
    		    [/filter]
    		    {VARIABLE_OP vampirism_max_blood add 10}
    		[/modify_unit]
        [/case]
        [case]
            value=blood_capacity3
    		[modify_unit]
    		    [filter]
    		        id=$tmp_vampire_unit_id
    		    [/filter]
    		    {VARIABLE_OP vampirism_max_blood add 15}
    		[/modify_unit]
        [/case]
        [case]
            value=blood_capacity4
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                {VARIABLE_OP vampirism_max_blood add 20}
            [/modify_unit]
        [/case]
        [case]
            value=predator1
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                {VARIABLE_OP vampirism_blood_from_village add 2}
                {VARIABLE_OP vampirism_blood_from_village_greatfeast add 12}
            [/modify_unit]
        [/case]
        [case]
            value=predator2
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                {VARIABLE_OP vampirism_blood_from_village add 2}
                {VARIABLE_OP vampirism_blood_from_village_greatfeast add 12}
            [/modify_unit]
        [/case]
        [case]
            value=predator3
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                {VARIABLE_OP vampirism_blood_from_village add 2}
                {VARIABLE_OP vampirism_blood_from_village_greatfeast add 12}
            [/modify_unit]
        [/case]
        [case]
            value=leadership
            [object]
                silent=yes
                duration=forever
                id=vampire_leadership
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_LEADERSHIP}
                    [/abilities]
                [/effect]
            [/object]
        [/case]
        [case]
            value=agility
            [object]
                silent=yes
                duration=forever
                id=vampire_agility
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=movement
                    increase=1
                [/effect]
            [/object]
        [/case]
        [case]
            value=bloodshield
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                {VARIABLE vampirism_bloodshield_effects_description _"Gain +20% to most resistances (except arcane) until your next turn."}
            [/modify_unit]
        [/case]
        [case]
            value=bloodshield2
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                {VARIABLE vampirism_bloodshield_effects_description _"Gain +20% to most resistances until your next turn.
take 35% less damage from sunlight until next turn
(stacks multiplicatively with Sunlight Resistance)"}
            [/modify_unit]
        [/case]
        [case]
            value=sun_resistance
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                {VARIABLE vampirism_sunlight_resistance_damagemult 0.75}
            [/modify_unit]
            [object]
                silent=yes
                duration=forever
                id=vampire_sun_resistance
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=vampire_sun_resistance#filtered by sunlight_damage, to check whether the vampirism_sunlight_resistance_damagemult variable should be used at all
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
        [/case]
        [case]
            value=sun_resistance2
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                {VARIABLE vampirism_sunlight_resistance_damagemult 0.5}
                {VARIABLE vampirism_sunlight_resistance_nokill yes}
            [/modify_unit]
        [/case]
        [case]
            value=sun_resistance3
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                {VARIABLE vampirism_sunlight_resistance_damagemult 0.33}
            [/modify_unit]
            [object]
                silent=yes
                duration=forever
                id=vampire_sun_resistance3
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=vampire_daywalker#filtered by the "reduce vampire damage by 25% at day" ability
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
        [/case]
        [case]
            value=frenzy2
            [object]
                silent=yes
                duration=forever
                id=vampire_frenzy2
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=vampirism_frenzy2#filtered by the hungry ability
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
        [/case]
        [case]
            value=refined_taste
            [object]
                silent=yes
                duration=forever
                id=vampire_refined_taste
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=vampirism_refined_taste#filtered by events
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
        [/case]
        [case]
            value=thrill_of_battle
            [object]
                silent=yes
                duration=forever
                id=vampire_thrill_of_battle
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=vampirism_thrill_of_battle#filtered by events
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
        [/case]
        [case]
            value=blood_reaper
            [object]
                silent=yes
                duration=forever
                id=vampire_blood_reaper
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=vampirism_blood_reaper#filtered by events
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
        [/case]
        [case]
            value=drain_minions
            [object]
                silent=yes
                duration=forever
                id=vampire_drain_minions
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=vampirism_drain_minions#filtered by events
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
        [/case]
        [case]
            value=batpowers1
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM bloodsurge}
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM bloodshield}
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM frenzy}
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM batswarm}
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM cloakofdarkness}
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM predatorvision}
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM unnatural_sprint}
        [/case]
        [case]
            value=batpowers2
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM curseofmisfortune}
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM terrify}
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM corrupt}
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM raiseundead}
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM summonghost}
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM blood_bolt}
        [/case]
        [case]
            value=batpowers3
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM carnage}
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM fleshcrafting}
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM summon_boneguard}
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM greatfeast}
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM horror}
            {VAMPIRE_UPGRADE_ALLOW_POWER_IN_BATFORM siring}
        [/case]
        [case]
            value=bat_strength
            [object]
                silent=yes
                duration=forever
                id=vampire_bat_strength
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=vampirism_dummy_bat_strength
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
            {VAMPIRISM_BATFORM_APPLY_EXCLUSIVE_UPGRADES $tmp_vampire_unit_id}
        [/case]
        [case]
            value=bat_strength2
            [object]
                silent=yes
                duration=forever
                id=vampire_bat_strength2
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=vampirism_dummy_bat_strength2
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
            {VAMPIRISM_BATFORM_APPLY_EXCLUSIVE_UPGRADES $tmp_vampire_unit_id}
        [/case]
        [case]
            value=bat_skirmisher
            [object]
                silent=yes
                duration=forever
                id=vampire_bat_strength2
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=vampirism_dummy_bat_skirmisher
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
            {VAMPIRISM_BATFORM_APPLY_EXCLUSIVE_UPGRADES $tmp_vampire_unit_id}
        [/case]
        [case]
            value=unnatural_sprint
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                {VARIABLE vampirism_unnatural_sprint_mp 2}
            [/modify_unit]
        [/case]
        [case]
            value=unnatural_sprint2
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                {VARIABLE vampirism_unnatural_sprint_mp 3}
            [/modify_unit]
        [/case]
        [case]
            value=unnatural_sprint3
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                {VARIABLE vampirism_unnatural_sprint_mp 4}
            [/modify_unit]
        [/case]
        [case]
            value=concealment
            [object]
                silent=yes
                duration=forever
                id=vampire_concealment
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_CONCEALMENT}
                    [/abilities]
                [/effect]
            [/object]
        [/case]
        [case]
            value=predatorvision
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                {VARIABLE vampirism_predatorvision_range 10}
            [/modify_unit]
        [/case]
        [case]
            value=predatorvision2
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                {VARIABLE vampirism_predatorvision_range 15}
            [/modify_unit]
        [/case]
        [case]
            value=predatorvision3
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                {VARIABLE vampirism_predatorvision_range 22}
            [/modify_unit]
        [/case]
        [case]
            value=drain_attack
            {VAMPIRISM_UPDATE_RESET_LEVEL_BEFORE_UPGRADE $tmp_vampire_unit_id}
            [object]
                silent=yes
                duration=forever
                id=vampire_drainlife
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=new_attack
                    name=vampire_drainlife#to avoid overlap with any existing attacks
                    description=_"drain life"
                    icon=icons/blood-magic-2.png
                    type=cold
                    range=ranged
                    damage=2
                    number=3
                    [specials]
                        {WEAPON_SPECIAL_MAGICAL}
                        {WEAPON_SPECIAL_DRAIN}
                    [/specials]
                    attack_weight=2#make the draining attack used/recommended more often, since blood is very important for vampires
                [/effect]
                [effect]
                    apply_to=attack
                    name=vampire_drainlife
                    increase_damage=2
                    times=per level
                [/effect]
                [effect]
                    apply_to=new_animation
                    [attack_anim]
                        [filter_attack]
                            name=vampire_drainlife
                        [/filter_attack]
                
                        start_time=-300
                        missile_start_time=-300
                
                        [if]
                        hits=yes
                        [missile_frame]
                            image="projectiles/drain-[1~9].png:100"
                            image_diagonal="projectiles/drain-ne-[1~9].png:100"
                            offset=0.5
                            sound=magic-faeriefire.ogg
                        [/missile_frame]
                        [/if]
                        [else]
                        [missile_frame]
                            image="projectiles/drain-[7~9].png:300"
                            image_diagonal="projectiles/drain-ne-[7~9].png:300"
                            offset=0.5
                        [/missile_frame]
                        [/else]
                
                        [frame]
                            duration=300
                        [/frame]
                
                        {SOUND:HIT_AND_MISS magic-dark.ogg magic-dark-miss.ogg -100}
                    [/attack_anim]
                [/effect]
            [/object]
            {VAMPIRISM_UPDATE_ACTUAL_LEVEL $tmp_vampire_unit_id}
            #update strength bonus after adding the drain attack
            {APPLY_VAMPIRE_STRENGTH_BONUS id=$tmp_vampire_unit_id}
        [/case]
        [case]
            value=drain_aura
            [object]
                silent=yes
                duration=forever
                id=vampire_drainaura
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=vampire_drainaura
                            name=_"drain aura"
                            description=_"Every turn, deal damage equal to your vampire level to all adjacent enemies, then gain Blood and heal HP equal to 50% of the total damage dealt."
                        [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=new_animation
                    [extra_anim]
                        flag=drain_anim
                        start_time=-300
                        missile_start_time=-300
                
                        [missile_frame]
                            image="projectiles/drain-[1~9].png:100"
                            image_diagonal="projectiles/drain-ne-[1~9].png:100"
                            offset=0.5
                            sound=magic-faeriefire.ogg
                        [/missile_frame]
                
                        [frame]
                            duration=300
                        [/frame]
                
                        {SOUND:HIT_AND_MISS magic-dark.ogg magic-dark-miss.ogg -100}
                    [/extra_anim]
                [/effect]
                #percentile buff to the drain life attack, since it's thematically fitting for the drain branch of upgrades
                [effect]
                    apply_to=attack
                    name=vampire_drainlife
                    increase_damage=25%
                [/effect]
            [/object]
            #update strength bonus after buffing the drain attack
            {APPLY_VAMPIRE_STRENGTH_BONUS id=$tmp_vampire_unit_id}
        [/case]
        [case]
            value=strength1
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                #increase the stat strength level
                {VARIABLE_OP vampirism_strength_bonus_level add 2}
            [/modify_unit]
            #update strength bonus
            {APPLY_VAMPIRE_STRENGTH_BONUS id=$tmp_vampire_unit_id}
        [/case]
        [case]
            value=strength2
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                #increase the stat strength level
                {VARIABLE_OP vampirism_strength_bonus_level add 3}
            [/modify_unit]
            #update strength bonus
            {APPLY_VAMPIRE_STRENGTH_BONUS id=$tmp_vampire_unit_id}
        [/case]
        [case]
            value=strength3
            [modify_unit]
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                #increase the stat strength level
                {VARIABLE_OP vampirism_strength_bonus_level add 5}
            [/modify_unit]
            #update strength bonus
            {APPLY_VAMPIRE_STRENGTH_BONUS id=$tmp_vampire_unit_id}
        [/case]
        [case]
            value=bite_damage
            [object]
                silent=yes
                duration=forever
                id=vampire_bite_damage
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=attack
#this upgrade is specifically normal-form-only, otherwise Bat Strength would be either OP or redundant
#                    name=vampire_bite,batform_fangs
                    name=vampire_bite
                    increase_damage=25%
                [/effect]
            [/object]
        [/case]
        [case]
            value=bite_chancetohit
            [object]
                silent=yes
                duration=forever
                id=vampire_bite_chancetohit
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=attack
                    name=vampire_bite,batform_fangs
                    increase_accuracy=10
                [/effect]
            [/object]
        [/case]
        [case]
            value=bite_plague
            [object]
                silent=yes
                duration=forever
                id=vampire_bite_chancetohit
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=attack
                    name=vampire_bite,batform_fangs
                    [set_specials]
                        mode=append
                        {WEAPON_SPECIAL_PLAGUE}
                    [/set_specials]
                [/effect]
            [/object]
        [/case]
        [case]
            value=raiseundead
            [allow_extra_recruit]
                id=$tmp_vampire_unit_id
                extra_recruit=Walking Corpse
            [/allow_extra_recruit]
        [/case]
        [case]
            value=summonghost
            [allow_extra_recruit]
                id=$tmp_vampire_unit_id
                extra_recruit=Ghost
            [/allow_extra_recruit]
        [/case]
        [case]
            value=summon_boneguard
            [allow_extra_recruit]
                id=$tmp_vampire_unit_id
                extra_recruit=Skeleton,Skeleton Archer
            [/allow_extra_recruit]
        [/case]
        [case]
            value=summonundeadhorde
            [allow_extra_recruit]
                id=$tmp_vampire_unit_id
                extra_recruit=Soulless
            [/allow_extra_recruit]
        [/case]
        [case]
            value=batswarm
            [allow_extra_recruit]
                id=$tmp_vampire_unit_id
                extra_recruit=Vampire Bat
            [/allow_extra_recruit]
        [/case]
        [case]
            value=fleshcrafting_undead
            [allow_extra_recruit]
                id=$tmp_vampire_unit_id
                extra_recruit=Ghoul
            [/allow_extra_recruit]
        [/case]
        [case]
            value=mentor
            [object]
                silent=yes
                duration=forever
                id=vampire_mentor
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                    [dummy]
                        id=vampirism_mentor_dummy
                    [/dummy]
                    [dummy]
                        id=vampirism_mentor1
                        name=_"mentor"
                        description=_"Every turn, adjacent allied vampires gain 4 Vampire XP
only works if the adjacent vampire's vampire level is lower than the mentor's
having multiple Mentors next to one student does NOT stack, only the best Mentor matters"
                    [/dummy]    
                    [/abilities]
                [/effect]
            [/object]
        [/case]
        [case]
            value=mentor2
            [object]
                silent=yes
                duration=forever
                id=vampire_mentor2
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=remove_ability
                    [abilities]
                    [dummy]
                        id=vampirism_mentor1
                    [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=new_ability
                    [abilities]
                    [dummy]
                        id=vampirism_mentor2
                        name=_"mentor"
                        description=_"Every turn, adjacent allied vampires gain 6 Vampire XP
only works if the adjacent vampire's vampire level is lower than the mentor's

Additionally, any adjacent allies get 2 normal XP per turn
(units receive the 2 normal XP even if they are not vampires, as long as the unit's level (normal level, not vampire level) is lower than this unit's level)

having multiple Mentors next to one student does NOT stack, only the best Mentor matters"
                    [/dummy]
                    [/abilities]
                [/effect]
            [/object]
        [/case]
        [case]
            value=mentor3
            [object]
                silent=yes
                duration=forever
                id=vampire_mentor3
                take_only_once=no
                [filter]
                    id=$tmp_vampire_unit_id
                [/filter]
                [effect]
                    apply_to=remove_ability
                    [abilities]
                    [dummy]
                        id=vampirism_mentor2
                    [/dummy]
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=new_ability
                    [abilities]
                    [dummy]
                        id=vampirism_mentor3
                        name=_"mentor"
                        description=_"Every turn, adjacent allied vampires gain 9 Vampire XP
only works if the adjacent vampire's vampire level is lower than the mentor's

Additionally, any adjacent allies get 3 normal XP per turn
(units receive the 3 normal XP even if they are not vampires, as long as the unit's level (normal level, not vampire level) is lower than this unit's level)

having multiple Mentors next to one student does NOT stack, only the best Mentor matters"
                    [/dummy]
                    [/abilities]
                [/effect]
            [/object]
        [/case]
    [/switch]
    {CLEAR_VARIABLE tmp_vampire_current_upgrade_id}
    {CLEAR_VARIABLE tmp_vampire_unit_id}
[/event]

#define VAMPIRISM_CURRENT_UPGRADES_SUBMENU
	{HOPLITE_CREATE_CURRENT_UPGRADES_DIALOG_OPTIONS this_vampire}
	[message]
		speaker=narrator
		message=_"Current upgrades:"
       	[option]
       	    image="attacks/blank-attack.png"
       	    description=_"Return to menu"
       	    [command]
#       	        {CLEAR_VARIABLE vampirism_menu_active}
       	    [/command]
       	[/option]
        [insert_tag]
            name=option
            variable=vampirism_currentupgrades_options
        [/insert_tag]
	[/message]
	{CLEAR_VARIABLE vampirism_currentupgrades_options}
#enddef

#define VAMPIRISM_UPGRADE_SUBMENU
    {VARIABLE vampirism_menu_upgrade_active yes}
    [while]
        [variable]
            name=vampirism_menu_upgrade_active
            equals=yes
        [/variable]
        [do]
    #this_vampire variable is repeatedly cleared and stored again so that blood/upgrade values stay up-to-date
    {CLEAR_VARIABLE this_vampire}
    [store_unit]
        [filter]
            x,y=$x1,$y1
        [/filter]
        variable=this_vampire
        kill=no
    [/store_unit]
	{HOPLITE_CREATE_CURRENT_UPGRADES_DIALOG_OPTIONS this_vampire}
	{HOPLITE_CREATE_AVAILABLE_UPGRADES_DIALOG_OPTIONS this_vampire}
	[message]
		speaker=narrator
        caption=_"Vampire Upgrade Menu"
		message=_"Vampire level: <span color='#ff0000'>$this_vampire.variables.vampirism_level|</span>
Vampire skill points: <span color='#ff0000'>$this_vampire.variables.vampirism_skillpoints|</span>

Select an upgrade."
       	[option]
       	    image="attacks/blank-attack.png"
       	    description=_"Return to menu"
       	    [command]
                {CLEAR_VARIABLE vampirism_menu_upgrade_active}
       	    [/command]
       	[/option]
        [option]
            image="icons/evil-eye-red-2.png~GS()"
            description=_"Show unavailable upgrades
(Ones that you need a higher vampire level for, or ones that require other upgrades first)"
            [show_if]
                {VARIABLE_CONDITIONAL vampirism_show_greyed_upgrades_for_side$side_number not_equals yes}
            [/show_if]
            [command]
                {VARIABLE vampirism_show_greyed_upgrades_for_side$side_number yes}
#                   {CLEAR_VARIABLE vampirism_menu_active}
            [/command]
        [/option]
        [option]
            image="icons/evil-eye-red-2.png~GS()"
            description=_"Hide unavailable upgrades"
            [show_if]
                {VARIABLE_CONDITIONAL vampirism_show_greyed_upgrades_for_side$side_number equals yes}
            [/show_if]
            [command]
                {CLEAR_VARIABLE vampirism_show_greyed_upgrades_for_side$side_number}
#                   {CLEAR_VARIABLE vampirism_menu_active}
            [/command]
        [/option]
        [insert_tag]
            name=option
            variable=vampirism_available_upgrades_options
        [/insert_tag]
	[/message]
	{CLEAR_VARIABLE vampirism_available_upgrades_options}
	{CLEAR_VARIABLE vampirism_currentupgrades_options}
        [/do]
    [/while]
#enddef

#define ADD_FLESHCRAFTING_OPTION_TO_LIST ID BLOOD_COST NAME DESCR_UPSIDES DESCR_DOWNSIDES ICON OTHER_PARAMS
    #this is the GLOBAL upgrade list, the "what upgrades has a specific vampire unlocked" data should be stored in unit variables instead
    [set_variables]
        name=vampirism_fleshcrafting_options_list
        mode=append
        [value]
            id={ID}
            icon={ICON}
            name={NAME}
            descr={DESCR_UPSIDES}+"
"+{DESCR_DOWNSIDES}
            full_descr="<span color='#ffff99'>"+{NAME}+"</span>: <span color='#99ff99'>"+{DESCR_UPSIDES}+"</span>
<span color='#ff9999'>"+{DESCR_DOWNSIDES}+_"</span>
Costs <span color='#ff0000'>"+{BLOOD_COST}+_"</span> Blood"+$tmp_extra_note|
            #different text highlighting for unavailable upgrades
            full_descr_greyed="<span color='#999999'>"+{NAME}+"</span>: <span color='#999999'>"+{DESCR_UPSIDES}+"
"+{DESCR_DOWNSIDES}+"</span>"+$tmp_extra_note|
            blood_cost={BLOOD_COST}
            {OTHER_PARAMS}
        [/value]
    [/set_variables]
#enddef

#define HOPLITE_CREATE_FLESHCRAFT_DIALOG_OPTIONS VAMPIRE_UNITVAR TARGET_UNITVAR
    [foreach]
        array=vampirism_fleshcrafting_options_list
        index_var=i
        [do]
            {VARIABLE tmp_vampire_fleshcraft_option_greyedout no}
            {VARIABLE tmp_vampire_fleshcraft_option_greyedout_reason ""}

            [if]
            [have_unit]
                id=${TARGET_UNITVAR}.id
                race=$this_item.incompatible_races|
            [/have_unit]
            [then]
            {VARIABLE tmp_vampire_fleshcraft_option_greyedout yes}
            {VARIABLE tmp_vampire_fleshcraft_option_greyedout_reason _"<span color='#ff9999'>This option is unavailable for the selected unit's race</span>"}
            [/then]
            [/if]

            {IF_VAR this_item.incompatible_fleshcrafts not_equals $emptyvar (
                [then]
                    [set_variables]
                        name=tmp_incompatible_fleshcrafts_list
                        [split]
                            list=$this_item.incompatible_fleshcrafts
                            key=id
                            separator=,
                        [/split]
                    [/set_variables]

                    [foreach]
                        array=tmp_incompatible_fleshcrafts_list
                        index_var=e
                        [do]
                            [if]
                            [have_unit]
                                id=${TARGET_UNITVAR}.id
                                ability=fleshcrafting_dummy_$this_item.id|
                            [/have_unit]
                            [then]
                                {VARIABLE_OP tmp_incompatible_fleshcrafts_count add 1}
                            [/then]
                            [/if]
                        [/do]
                    [/foreach]

                    {IF_VAR tmp_incompatible_fleshcrafts_count greater_than 0 (
                        [then]

                        {VARIABLE tmp_vampire_fleshcraft_option_greyedout yes}
                        {VARIABLE tmp_vampire_fleshcraft_option_greyedout_reason _"<span color='#ff9999'>"+$this_item.incompatible_fleshcrafts_reason|+"</span>"}
                    [/then]
                    )}
                {CLEAR_VARIABLE tmp_incompatible_fleshcrafts_list}
                {CLEAR_VARIABLE tmp_incompatible_fleshcrafts_count}
            [/then]
            )}

                {IF_VAR tmp_vampire_fleshcraft_option_greyedout equals yes (
                [then]
                    [set_variables]
                        name=vampirism_available_fleshcraft_options
                        mode=append
                        [value]
                            image=$this_item.icon|+"~GS()"
                            description=$this_item.full_descr_greyed|+_" 
"+$tmp_vampire_fleshcraft_option_greyedout_reason|
                            [show_if]
                                [have_unit]
                                    id=${TARGET_UNITVAR}.id
                                    [not]
                                        ability=fleshcrafting_dummy_$this_item.id|
                                    [/not]
                                [/have_unit]
                            [/show_if]
                            [command]
                            [/command]
                        [/value]
                    [/set_variables]
                [/then]
                [else]
                    [set_variables]
                        name=vampirism_available_fleshcraft_options
                        mode=append
                        [value]
                            image=$this_item.icon|
                            description=$this_item.full_descr|
                            [show_if]
                                [have_unit]
                                    id=${TARGET_UNITVAR}.id
                                    [not]
                                        ability=fleshcrafting_dummy_$this_item.id|
                                    [/not]
                                [/have_unit]
                            [/show_if]
                            [command]
                                {VAMPIRE_SPEND_BLOOD_ON_POWER $this_item.blood_cost (
                                    [sound]
                                        name=magic-dark-big.ogg
                                    [/sound]
    
                                    [floating_text]
                                       x,y=$tmp_power_target_x,$tmp_power_target_y
                                       text=_"<span color='#ff00ff'>Fleshcrafting</span>"
                                    [/floating_text]
                                    {VARIABLE tmp_current_fleshcrafting_option_id $this_item.id}
                                    {VARIABLE tmp_fleshcrafted_unit_id ${TARGET_UNITVAR}.id}
                                    [fire_event]
                                        id=vampire_fleshcrafting_effect_event
                                    [/fire_event]
    
                                    {CLEAR_VARIABLE vampirism_menu_active}
                                )}
                            [/command]
                        [/value]
                    [/set_variables]
                [/else]
                )}

#            {IF_VAR {UNITVAR}.variables.vampire_upgrade_$this_item.id|_unlocked equals yes (
#                [then]
#                [/then]
#            )}

            {CLEAR_VARIABLE tmp_vampire_fleshcraft_option_greyedout}
            {CLEAR_VARIABLE tmp_vampire_fleshcraft_option_greyedout_reason}
        [/do]
    [/foreach]
#enddef

#define VAMPIRISM_FLESHCRAFT_SUBMENU
    {VARIABLE vampirism_menu_fleshcraft_active yes}
    [while]
        [variable]
            name=vampirism_menu_fleshcraft_active
            equals=yes
        [/variable]
        [do]
    #this_vampire variable is repeatedly cleared and stored again so that blood/upgrade values stay up-to-date
    {CLEAR_VARIABLE this_vampire}
    [store_unit]
        [filter]
            x,y=$x1,$y1
        [/filter]
        variable=this_vampire
        kill=no
    [/store_unit]

    #update the fleshcraft target variables just in case

    [store_unit]
        [filter]
            id=$vamp_fleshcraft_target.id
        [/filter]
        variable=vamp_fleshcraft_target
        kill=no
        mode=replace
    [/store_unit]

    {HOPLITE_CREATE_FLESHCRAFT_DIALOG_OPTIONS this_vampire vamp_fleshcraft_target}
    [message]
        speaker=narrator
        caption=_"Vampire Fleshcrafting Menu"
        message=_"Choose how to modify the flesh of this unit."
        [option]
            image="attacks/blank-attack.png"
            description=_"Return to menu"
            [command]
                {CLEAR_VARIABLE vampirism_menu_fleshcraft_active}
            [/command]
        [/option]
        [insert_tag]
            name=option
            variable=vampirism_available_fleshcraft_options
        [/insert_tag]
    [/message]
    {CLEAR_VARIABLE vampirism_available_fleshcraft_options}
        [/do]
    [/while]
#enddef

#define FLESHCRAFT_ADD_DUMMY_ABILITY ID
    [effect]
        apply_to=new_ability
        [abilities]
            [dummy]
                id=fleshcrafting_dummy_{ID}
            [/dummy]
        [/abilities]
    [/effect]
#enddef

#TODO: make the defense reduction from Reckless Aggression and various other fleshcrafts stack more consistently with Aquatic Body instead of order mattering? (otherwise taking Aggression first then Aquatic body could be a bit abusable)

#define SKIN_FLESHCRAFTS_LIST
drakeskin,saurianskin,trollskin,yetiskin#enddef

[event]
    name=prestart
    id=vampirism_define_fleshcraft_options
    first_time_only=no
    #reset the upgrade list every scenario
    {CLEAR_VARIABLE vampirism_fleshcrafting_options_list}

#rebalanced it from +30% to +20% and +8 flat, to make it more appealing to use on units with low max HP while being slightly weaker on units with really high HP (above 80)
    {ADD_FLESHCRAFTING_OPTION_TO_LIST bulky 20 _"Bulky" _"+20% max hitpoints
+8 max hitpoints (applied AFTER percentage)" _"-20% movement" icons/amla-default.png (
        incompatible_fleshcrafts=lightweight
        incompatible_fleshcrafts_reason=_"This modification is incompatible with Lightweight"
    )}
#TODO: make it re-applied for new attacks too, maybe by swapping the damage debuff from [object] to an ability that multiplies damage, then I can remove the "to existing attacks" part
    {ADD_FLESHCRAFTING_OPTION_TO_LIST lightweight 20 _"Lightweight" _"+25% movement" _"-10% max hitpoints
-10% damage to all attacks" icons/sandals.png (
        incompatible_fleshcrafts=bulky
        incompatible_fleshcrafts_reason=_"This modification is incompatible with Bulky"
    )}

#TODO: make it re-applied for new attacks too, maybe by swapping the damage buff from [object] to an ability that multiplies damage, then I can remove the "to existing attacks" part
    {ADD_FLESHCRAFTING_OPTION_TO_LIST aggression 20 _"Reckless Aggression" _"+30% damage to all existing attacks" _"-10% defense on all terrain types" attacks/frenzy.png ()}

#TODO: make it re-applied for new attacks too, maybe by swapping the damage buff from [object] to an ability that multiplies damage, then I can remove the "to existing attacks" part
    {ADD_FLESHCRAFTING_OPTION_TO_LIST limbs 20 _"Extra Limbs" _"+100% strikes to all attacks (except those which already had swarm)" _"swarm special on all attacks
-15% damage to all attacks (except those which already had swarm)" attacks/fist-human.png ()}

#TODO: make the damage debuff re-applied for new attacks too, maybe by swapping the damage buff from [object] to an ability that multiplies damage, then I can remove the "to existing attacks" part
    {ADD_FLESHCRAFTING_OPTION_TO_LIST claws 20 _"Claws" _"new attack: claws
deals 3x3 damage, melee, blade
plus 3 damage per level" _"-25% ranged damage" attacks/claws-drake.png ()}

#TODO: make the damage debuff re-applied for new attacks too, maybe by swapping the damage buff from [object] to an ability that multiplies damage, then I can remove the "to existing attacks" part
    {ADD_FLESHCRAFTING_OPTION_TO_LIST tentacles 20 _"Tentacles" _"new attack: tentacle
deals 1x9 damage, melee, impact, swarm
plus 1 damage and 1 strike per level" _"-25% ranged damage" attacks/tentacle.png ()}

#TODO: make the damage debuff re-applied for new attacks too, maybe by swapping the damage buff from [object] to an ability that multiplies damage, then I can remove the "to existing attacks" part
    {ADD_FLESHCRAFTING_OPTION_TO_LIST poisonspit 20 _"Poison Glands" _"new attack: poison spit
deals 3x1 damage, ranged, impact, with poison special
plus 1 damage and 1 strike per level" _"-15% melee damage
-15% max hitpoints
-10% cold resistance" icons/fireball-acid-1.png ()}

#TODO: make the damage debuff re-applied for new attacks too, maybe by swapping the damage buff from [object] to an ability that multiplies damage, then I can remove the "to existing attacks" part
    {ADD_FLESHCRAFTING_OPTION_TO_LIST firebreath 20 _"Fire Breath" _"new attack: fire breath
deals 3x3 damage, ranged, fire
plus 1 damage and 1 strike per level" _"-25% melee damage
-20% cold resistance" attacks/fire-breath-drake.png ()}

#incompatible races is to avoid stacking a race feature onto a race that already has it, like putting drake skin on a drake, etc.
    {ADD_FLESHCRAFTING_OPTION_TO_LIST drakeskin 20 _"Drake Skin" _"+40% fire resistance
set sand movement cost to 1" _"-30% cold resistance" attacks/slam-drake.png (
        incompatible_races=drake
        incompatible_fleshcrafts={SKIN_FLESHCRAFTS_LIST}
        incompatible_fleshcrafts_reason=_"Cannot have multiple different skin modifications on the same unit at once"
    )}
    {ADD_FLESHCRAFTING_OPTION_TO_LIST saurianskin 20 _"Saurian Skin" _"skirmisher ability
+20% pierce resistance
set sand and swamp movement cost to 1" _"-10% blade, impact, fire and cold resistances
-10% max hitpoints" attacks/tekko.png (
        incompatible_races=lizard
        incompatible_fleshcrafts={SKIN_FLESHCRAFTS_LIST}
        incompatible_fleshcrafts_reason=_"Cannot have multiple different skin modifications on the same unit at once"
    )}

#TODO: make it re-applied for new attacks too, maybe by swapping the damage buff from [object] to an ability that multiplies damage, then I can remove the "to existing attacks" part
    {ADD_FLESHCRAFTING_OPTION_TO_LIST trollskin 20 _"Troll Skin" _"regenerates ability
+10% blade and pierce resistance
set cave movement cost to 1" _"-10% arcane resistance
-10% village/castle/forest defense
-10% damage to all attacks" attacks/fist-troll.png (
        incompatible_races=troll
        incompatible_fleshcrafts={SKIN_FLESHCRAFTS_LIST}
        incompatible_fleshcrafts_reason=_"Cannot have multiple different skin modifications on the same unit at once"
    )}

    {ADD_FLESHCRAFTING_OPTION_TO_LIST yetiskin 20 _"Yeti Fur" _"+40% cold resistance
set frozen movement cost to 1" _"-30% fire resistance" attacks/fist-yeti.png (
        incompatible_fleshcrafts={SKIN_FLESHCRAFTS_LIST}
        incompatible_fleshcrafts_reason=_"Cannot have multiple different skin modifications on the same unit at once"
    )}

    {ADD_FLESHCRAFTING_OPTION_TO_LIST aquaticbody 20 _"Aquatic Body" _"set movement cost to 1 on shallow water, deep water, swamp and reef terrain
Set shallow water, deep water and swamp defense to 50%, set reef defense to 60%" _"-10% defense on all non-water terrain types
movement cost in hills and mountains increased by 1" attacks/tail-merman.png (
        incompatible_races=merman,naga
    )}

#TODO: maybe implement this later?
#    {ADD_FLESHCRAFTING_OPTION_TO_LIST unnaturalblood 20 _"Unnatural Blood" _"immune to drain
#" _"-15% max hitpoints" icons/blood-magic-1.png ()}

    #I intentionally made fleshcraft removal more expensive than applying, to encourage players to not switch modifications too often
    {ADD_FLESHCRAFTING_OPTION_TO_LIST removefleshcraft 40 _"Undo Fleshcrafting" _"<span color='#ffffff'>Removes all fleshcrafting modifications from this unit</span>" "" icons/heal-royal-1.png ()}
[/event]
[event]
    id=vampire_fleshcrafting_effect_event
    first_time_only=no
    [switch]
        variable=tmp_current_fleshcrafting_option_id
        [case]
            value=bulky
            [object]
                silent=yes
                duration=forever
                id=vampire_fleshcraft_bulky
                take_only_once=no
                [filter]
                    id=$tmp_fleshcrafted_unit_id
                [/filter]
                [effect]
                    apply_to=hitpoints
                    increase=20%
                    increase_total=20%
                [/effect]
                [effect]
                    apply_to=hitpoints
                    increase=8
                    increase_total=8
                [/effect]
                [effect]
                    apply_to=movement
                    increase=-20%
                [/effect]
                {FLESHCRAFT_ADD_DUMMY_ABILITY bulky}
            [/object]
        [/case]
        [case]
            value=lightweight
            [object]
                silent=yes
                duration=forever
                id=vampire_fleshcraft_lightweight
                take_only_once=no
                [filter]
                    id=$tmp_fleshcrafted_unit_id
                [/filter]
                [effect]
                    apply_to=movement
                    increase=25%
                [/effect]
                [effect]
                    apply_to=hitpoints
                    increase=-15%
                    increase_total=-15%
                [/effect]
                [effect]
                    apply_to=attack
                    increase_damage=-10%
                [/effect]
                {FLESHCRAFT_ADD_DUMMY_ABILITY lightweight}
            [/object]
        [/case]
        [case]
            value=aggression
            [object]
                silent=yes
                duration=forever
                id=vampire_fleshcraft_aggression
                take_only_once=no
                [filter]
                    id=$tmp_fleshcrafted_unit_id
                [/filter]
                [effect]
                    apply_to=attack
                    increase_damage=30%
                [/effect]
                [effect]
                    apply_to=defense
                    replace=no
                    [defense]
                      deep_water=10
                      shallow_water=10
                      swamp_water=10
                      reef=10
                      flat=10
                      sand=10
                      forest=10
                      hills=10
                      mountains=10
                      village=10
                      castle=10
                      cave=10
                      frozen=10
                      unwalkable=10
                      fungus=10
                    [/defense]
                [/effect]
                {FLESHCRAFT_ADD_DUMMY_ABILITY aggression}
            [/object]
        [/case]
        [case]
            value=limbs
            [object]
                silent=yes
                duration=forever
                id=vampire_fleshcraft_limbs
                take_only_once=no
                [filter]
                    id=$tmp_fleshcrafted_unit_id
                [/filter]
                [effect]
                    apply_to=attack
                    [not]
                        special_id=swarm
                    [/not]
                    increase_attacks=100%
                    increase_damage=-15%
                    [set_specials]
                        mode=append
                        {WEAPON_SPECIAL_SWARM}
                    [/set_specials]
                [/effect]
                {FLESHCRAFT_ADD_DUMMY_ABILITY limbs}
            [/object]
        [/case]
        [case]
            value=drakeskin
            [object]
                silent=yes
                duration=forever
                id=vampire_fleshcraft_drakeskin
                take_only_once=no
                [filter]
                    id=$tmp_fleshcrafted_unit_id
                [/filter]
                [effect]
                    apply_to=resistance
                    replace=no
                    [resistance]
                        fire=-40
                        cold=30
                    [/resistance]
                [/effect]
                #mainline drakes have 1 MP cost on sand, probably due to being able to handle hot temperatures better, so decided to put it in the fleshcraft upgrade (other 1 MP costs like hills/mountains are NOT included to not make it OP)
                [effect]
                    apply_to=movement_costs
                    replace=yes
                    [movement_costs]
                        sand=1
                    [/movement_costs]
                [/effect]
                {FLESHCRAFT_ADD_DUMMY_ABILITY drakeskin}
            [/object]
        [/case]
        [case]
            value=saurianskin
            [object]
                silent=yes
                duration=forever
                id=vampire_fleshcraft_saurianskin
                take_only_once=no
                [filter]
                    id=$tmp_fleshcrafted_unit_id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_SKIRMISHER}
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=resistance
                    replace=no
                    [resistance]
                        pierce=-20
                        blade=10
                        impact=10
                        fire=10
                        cold=10
                    [/resistance]
                [/effect]
                [effect]
                    apply_to=movement_costs
                    replace=yes
                    [movement_costs]
                        sand=1
                        swamp_water=1
                    [/movement_costs]
                [/effect]
                [effect]
                    apply_to=hitpoints
                    increase=-10%
                    increase_total=-10%
                [/effect]
                {FLESHCRAFT_ADD_DUMMY_ABILITY saurianskin}
            [/object]
        [/case]
        [case]
            value=trollskin
            [object]
                silent=yes
                duration=forever
                id=vampire_fleshcraft_trollskin
                take_only_once=no
                [filter]
                    id=$tmp_fleshcrafted_unit_id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_REGENERATES}
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=resistance
                    replace=no
                    [resistance]
                        pierce=-10
                        blade=-10
                        arcane=10
                    [/resistance]
                [/effect]
                [effect]
                    apply_to=movement_costs
                    replace=yes
                    [movement_costs]
                        cave=1
                    [/movement_costs]
                [/effect]
                [effect]
                    apply_to=defense
                    replace=no
                    [defense]
                      forest=10
                      village=10
                      castle=10
                    [/defense]
                [/effect]
                [effect]
                    apply_to=attack
                    increase_damage=-10%
                [/effect]
                {FLESHCRAFT_ADD_DUMMY_ABILITY trollskin}
            [/object]
        [/case]
        [case]
            value=yetiskin
            [object]
                silent=yes
                duration=forever
                id=vampire_fleshcraft_yetiskin
                take_only_once=no
                [filter]
                    id=$tmp_fleshcrafted_unit_id
                [/filter]
                [effect]
                    apply_to=resistance
                    replace=no
                    [resistance]
                        cold=-40
                        fire=30
                    [/resistance]
                [/effect]
                [effect]
                    apply_to=movement_costs
                    replace=yes
                    [movement_costs]
                        frozen=1
                    [/movement_costs]
                [/effect]
                {FLESHCRAFT_ADD_DUMMY_ABILITY yetiskin}
            [/object]
        [/case]
        [case]
            value=aquaticbody
            [object]
                silent=yes
                duration=forever
                id=vampire_fleshcraft_aquaticbody
                take_only_once=no
                [filter]
                    id=$tmp_fleshcrafted_unit_id
                [/filter]
                [effect]
                    apply_to=defense
                    replace=no
                    [defense]
#water is excluded from defense reduction
#                      deep_water=10
#                      shallow_water=10
#                      swamp_water=10
#                      reef=10
                      flat=10
                      sand=10
                      forest=10
                      hills=10
                      mountains=10
                      village=10
                      castle=10
                      cave=10
                      frozen=10
                      unwalkable=10
                      fungus=10
                    [/defense]
                [/effect]
                [effect]
                    apply_to=defense
                    replace=yes
                    [defense]
                      deep_water=50
                      shallow_water=50
                      swamp_water=50
                      reef=40
                    [/defense]
                [/effect]
                [effect]
                    apply_to=movement_costs
                    replace=yes
                    [movement_costs]
                      deep_water=1
                      shallow_water=1
                      swamp_water=1
                      reef=1
                    [/movement_costs]
                [/effect]
                #units with aquatic body especially struggle moving in hills/mountains
                [effect]
                    apply_to=movement_costs
                    replace=no
                    [movement_costs]
                      hills=1
                      mountains=1
                    [/movement_costs]
                [/effect]
                {FLESHCRAFT_ADD_DUMMY_ABILITY aquaticbody}
            [/object]
        [/case]
        [case]
            value=claws
            {VAMPIRISM_UPDATE_RESET_LEVEL_BEFORE_UPGRADE $tmp_fleshcrafted_unit_id}
            [object]
                silent=yes
                duration=forever
                id=vampire_fleshcraft_claws
                take_only_once=no
                [filter]
                    id=$tmp_fleshcrafted_unit_id
                [/filter]
                [effect]
                    apply_to=new_attack
                    name=fleshcraft_claws#to avoid overlap with any existing attacks
                    description=_"claws"
                    icon=attacks/claws-drake.png
                    type=blade
                    range=melee
                    damage=3
                    number=3
                [/effect]
                [effect]
                    apply_to=attack
                    name=fleshcraft_claws
                    increase_damage=3
                    times=per level
                [/effect]
                #ranged damage debuff
                [effect]
                    apply_to=attack
                    range=ranged
                    increase_damage=-25%
                [/effect]
                [effect]
                    apply_to=new_animation
                    [attack_anim]
                        [filter_attack]
                            name=fleshcraft_claws
                        [/filter_attack]
        
                        start_time=-200
        
                        [frame]
                            duration=300
                        [/frame]
        
                        {SOUND:HIT_AND_MISS claws.ogg {SOUND_LIST:MISS} -100}
                    [/attack_anim]
                [/effect]
                {FLESHCRAFT_ADD_DUMMY_ABILITY claws}
            [/object]
            {VAMPIRISM_UPDATE_ACTUAL_LEVEL $tmp_fleshcrafted_unit_id}
            #update strength bonus after adding the drain attack
            {APPLY_VAMPIRE_STRENGTH_BONUS id=$tmp_fleshcrafted_unit_id}
        [/case]
        [case]
            value=tentacles
            {VAMPIRISM_UPDATE_RESET_LEVEL_BEFORE_UPGRADE $tmp_fleshcrafted_unit_id}
            [object]
                silent=yes
                duration=forever
                id=vampire_fleshcraft_tentacles
                take_only_once=no
                [filter]
                    id=$tmp_fleshcrafted_unit_id
                [/filter]
                [effect]
                    apply_to=new_attack
                    name=fleshcraft_tentacles#to avoid overlap with any existing attacks
                    description=_"tentacle"
                    icon=attacks/tentacle.png
                    type=impact
                    range=melee
                    damage=1
                    number=9
                    [specials]
                        {WEAPON_SPECIAL_SWARM}
                    [/specials]
                [/effect]
                [effect]
                    apply_to=attack
                    name=fleshcraft_tentacles
                    increase_damage=1
                    increase_attacks=1
                    times=per level
                [/effect]
                #ranged damage debuff
                [effect]
                    apply_to=attack
                    range=ranged
                    increase_damage=-25%
                [/effect]
                [effect]
                    apply_to=new_animation
                    [attack_anim]
                        [filter_attack]
                            name=fleshcraft_tentacles
                        [/filter_attack]
        
                        start_time=-200
        
                        [frame]
                            duration=300
                        [/frame]
        
                        {SOUND:HIT_AND_MISS squishy-hit.wav {SOUND_LIST:MISS} -100}
                    [/attack_anim]
                [/effect]
                {FLESHCRAFT_ADD_DUMMY_ABILITY tentacles}
            [/object]
            {VAMPIRISM_UPDATE_ACTUAL_LEVEL $tmp_fleshcrafted_unit_id}
            #update strength bonus after adding the drain attack
            {APPLY_VAMPIRE_STRENGTH_BONUS id=$tmp_fleshcrafted_unit_id}
        [/case]
        [case]
            value=poisonspit
            {VAMPIRISM_UPDATE_RESET_LEVEL_BEFORE_UPGRADE $tmp_fleshcrafted_unit_id}
            [object]
                silent=yes
                duration=forever
                id=vampire_fleshcraft_poisonspit
                take_only_once=no
                [filter]
                    id=$tmp_fleshcrafted_unit_id
                [/filter]
                [effect]
                    apply_to=new_attack
                    name=fleshcraft_poisonspit#to avoid overlap with any existing attacks
                    description=_"poison spit"
                    icon=icons/fireball-acid-1.png
                    type=impact
                    range=ranged
                    damage=3
                    number=1
                    [specials]
                        {WEAPON_SPECIAL_POISON}
                    [/specials]
                [/effect]
                [effect]
                    apply_to=attack
                    name=fleshcraft_poisonspit
                    increase_damage=1
                    increase_attacks=1
                    times=per level
                [/effect]
                [effect]
                    apply_to=resistance
                    replace=no
                    [resistance]
                        cold=10
                    [/resistance]
                [/effect]
                [effect]
                    apply_to=hitpoints
                    increase=-15%
                    increase_total=-15%
                [/effect]
                #melee damage debuff
                [effect]
                    apply_to=attack
                    range=melee
                    increase_damage=-15%
                [/effect]
                [effect]
                    apply_to=new_animation
                    [attack_anim]
                        [filter_attack]
                            name=fleshcraft_poisonspit
                        [/filter_attack]
                        start_time=-420

                        missile_start_time=-165
                        [missile_frame]
                            duration=165
                            image="projectiles/water-spray.png"
                            image_diagonal="projectiles/water-spray.png"
                            image_mod="~CS(0,128,-128)"
                        [/missile_frame]

                        [frame]
                            duratio=200
                        [/frame]
                        [frame]
                            duratio=300
                            sound=water-blast.wav
                        [/frame]
                    [/attack_anim]
                [/effect]
                {FLESHCRAFT_ADD_DUMMY_ABILITY poisonspit}
            [/object]
            {VAMPIRISM_UPDATE_ACTUAL_LEVEL $tmp_fleshcrafted_unit_id}
            #update strength bonus after adding the drain attack
            {APPLY_VAMPIRE_STRENGTH_BONUS id=$tmp_fleshcrafted_unit_id}
        [/case]
        [case]
            value=firebreath
            {VAMPIRISM_UPDATE_RESET_LEVEL_BEFORE_UPGRADE $tmp_fleshcrafted_unit_id}
            [object]
                silent=yes
                duration=forever
                id=vampire_fleshcraft_firebreath
                take_only_once=no
                [filter]
                    id=$tmp_fleshcrafted_unit_id
                [/filter]
                [effect]
                    apply_to=new_attack
                    name=fleshcraft_firebreath#to avoid overlap with any existing attacks
                    description=_"fire breath"
                    icon=attacks/fire-breath-drake.png
                    type=fire
                    range=ranged
                    damage=3
                    number=3
                [/effect]
                [effect]
                    apply_to=attack
                    name=fleshcraft_firebreath
                    increase_damage=1
                    increase_attacks=1
                    times=per level
                [/effect]
                [effect]
                    apply_to=resistance
                    replace=no
                    [resistance]
                        cold=20
                    [/resistance]
                [/effect]
                #melee damage debuff
                [effect]
                    apply_to=attack
                    range=melee
                    increase_damage=-25%
                [/effect]
                [effect]
                    apply_to=new_animation
                    [attack_anim]
                        [filter_attack]
                            name=fleshcraft_firebreath
                        [/filter_attack]
                        {MISSILE_FRAME_FIRE_BREATH 8,-50 8,50 35,-20 35,40}
                        start_time=-480
                        [frame]
                            duration=600
                        [/frame]
                        {SOUND:HIT_AND_MISS flame-big.ogg flame-big-miss.ogg -480}
                    [/attack_anim]
                [/effect]
                {FLESHCRAFT_ADD_DUMMY_ABILITY firebreath}
            [/object]
            {VAMPIRISM_UPDATE_ACTUAL_LEVEL $tmp_fleshcrafted_unit_id}
            #update strength bonus after adding the drain attack
            {APPLY_VAMPIRE_STRENGTH_BONUS id=$tmp_fleshcrafted_unit_id}
        [/case]
        [case]
            value=removefleshcraft
            [foreach]
                array=vampirism_fleshcrafting_options_list
                index_var=e
                [do]
                    [remove_object]
                        id=$tmp_fleshcrafted_unit_id
                        object_id=vampire_fleshcraft_$this_item.id
                    [/remove_object]
                [/do]
            [/foreach]
        [/case]
    [/switch]
    {CLEAR_VARIABLE tmp_current_fleshcrafting_option_id}
    {CLEAR_VARIABLE tmp_fleshcrafted_unit_id}
[/event]
