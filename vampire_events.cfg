#textdomain wesnoth-vampirism



#define ABILITY_VAMPIRISM
    [dummy]
        id=vampirism
        name= _ "vampirism"
        female_name= _ "female^vampirism"
        description= _ "This unit is a vampire, with the following advantages and downsides:

TODO
-at day, take damage from sunlight every turn unless you are in a castle or village tile
-deals an additional 25% less damage at day, on top of the normal ToD damage reduction"
    [/dummy]
    [leadership]
        id=vampirism_day_debuff
        sub=25
        affect_self=yes
        [filter]
            [filter_location]
                time_of_day=lawful
            [/filter_location]
        [/filter]
    [/leadership]
#enddef

#define ABILITY_VAMPIRE_HUNGER
    [dummy]
        id=vampire_hunger
        name= _ "hungry"
        female_name= _ "female^hungry"
        description= _ "This vampire is hungry from not having drank enough blood (Blood reached 0). This applies the following effects while active:

-66% damage to all non-draining attacks

bite attack gains +50% damage but loses backstab

bite attack gains berserk special

arcane resistance is reduced by an additional 20%

Hunger is removed when your blood is at least 40% of max blood."
    [/dummy]
    [leadership]
        id=vampirism_hunger_bitebuff
        add=50
        affect_self=yes
        [filter_weapon]
            name=vampire_bite
        [/filter_weapon]
    [/leadership]
    [leadership]
        id=vampirism_hunger_debuff
        sub=66
        affect_self=yes
        [filter_weapon]
            [not]
                special_id=drains
            [/not]
        [/filter_weapon]
    [/leadership]
    [resistance]
        id=vampirism_hunger_arcane_debuff
        sub=20
        max_value=100
        apply_to=arcane
        affect_self=yes
        affect_allies=no
    [/resistance]
    #berserk is applied directly via object
#enddef


#define TRAIT_VAMPIRE
    # Units with trait Vampire cannot be poisoned, or plagued, but can still be drained
    [trait]
        id=vampire
        availability="musthave"
        male_name= _ "vampire"
        female_name= _ "female^vampire"
        description= _ "Immune to poison, and plague"
        help_text= _ "<italic>text='Vampire'</italic> units are immune to poison and plague, and have access to various vampire powers. However, they require 80% more experience to advance normally."
        #added the XP increase to ensure vampires don't just quickly rush to level 3-4 while still having a low level of vampirism. It is also meant to reflect vampires being generally more stagnant.
        [effect]
            apply_to=max_experience
            increase=80%
        [/effect]
        [effect]
            apply_to=status
            add=unpoisonable
        [/effect]
#        [effect]
#            apply_to=status
#            add=undrainable
#        [/effect]
        [effect]
            apply_to=status
            add=unplagueable
        [/effect]
    [/trait]
#enddef

#define APPLY_VAMPIRE_STRENGTH_BONUS FILTER
    #foreach loop to be able to affect multiple vampires at once
    [store_unit]
        [filter]
            {FILTER}
            [and]
                ability=vampirism
            [/and]
        [/filter]
        variable=vampirism_buffed
        kill=no
    [/store_unit]
    [foreach]
        array=vampirism_buffed
        variable=this_item_strength#so this can be more safely included inside other foreach loops
        index_var=e
        [do]
            #reset the old buff
            [remove_object]
                id=$this_item_strength.id
                object_id=vampire_strength_bonus
            [/remove_object]

            {VARIABLE tmp_vampire_hp_buff "$($this_item_strength.variables.vampirism_strength_bonus_level * 15)"}
            {VARIABLE tmp_vampire_dmg_buff "$($this_item_strength.variables.vampirism_strength_bonus_level * 10)"}

            [object]
                silent=yes
                duration=forever
                id=vampire_strength_bonus
                take_only_once=no
                [filter]
                    id=$this_item_strength.id
                [/filter]
                [effect]
                    apply_to=hitpoints
                    increase=$tmp_vampire_hp_buff|%
                    increase_total=$tmp_vampire_hp_buff|%
                [/effect]
                [effect]
                    apply_to=attack
                    increase_damage=$tmp_vampire_dmg_buff|%
                [/effect]
            [/object]    
        [/do]
    [/foreach]
    {CLEAR_VARIABLE vampirism_buffed}
    {CLEAR_VARIABLE tmp_vampire_hp_buff}
    {CLEAR_VARIABLE tmp_vampire_dmg_buff}
#enddef

#define TURN_INTO_VAMPIRE FILTER
	#foreach loop to be able to turn multiple units into vampires at once
    [store_unit]
        [filter]
        	{FILTER}
            [not]
                ability=vampirism#prevent duplication
            [/not]
        [/filter]
        variable=vampirism_converted
        kill=no
    [/store_unit]
    [foreach]
        array=vampirism_converted
        index_var=i
        [do]
        	{VARIABLE this_item.variables.vampirism_level 1}
        	{VARIABLE this_item.variables.vampirism_max_blood 20}#vampires start with 20 blood capacity, and gain 5 each levelup
        	{VARIABLE this_item.variables.vampirism_blood "$($this_item.variables.vampirism_max_blood| / 2)"}
        	{VARIABLE this_item.variables.vampirism_xp 0}
        	{VARIABLE this_item.variables.vampirism_max_xp "$($this_item.variables.vampirism_level| * 50)"}
            {VARIABLE this_item.variables.vampirism_strength_bonus_level 1}#equal to vampire level by default. TO AVOID SKILLS AND LEVELUPS, CONFLICTING DO NOT SET IT ON LEVELUP, ONLY ADD IT
            {VARIABLE this_item.variables.vampirism_skillpoints 2}#used for buying vampire powers
            [unstore_unit]
                variable=this_item
                find_vacant=no
            [/unstore_unit]
            [object]
                silent=yes
                duration=forever
                id=vampire_initial_object
                take_only_once=no
                [filter]
                    id=$this_item.id
                [/filter]
                [effect]
                    apply_to=image_mod
                    #slight tint, to make vampires more distinct
                    #TODO: make tints optional and toggleable
                    add="~BLEND(128,64,128,0.3)"
                [/effect]
                [effect]
                    apply_to=alignment
                    set=chaotic
                [/effect]
           		[effect]
           		    apply_to=new_ability
           		    [abilities]
           		    	{ABILITY_VAMPIRISM}
           		    [/abilities]
           		[/effect]
                #become more resistant to cold, but weaker to arcane/fire
                [effect]
                    apply_to=resistance
                    replace=no
                    [resistance]
                        arcane=20
                        fire=10
                        cold=-20
                    [/resistance]
                [/effect]
                [effect]
                    apply_to=new_attack
                    name=vampire_bite#to avoid overlap with any existing bite attacks
                    description= _ "bite"
                    icon=attacks/fangs.png
                    type=pierce
                    range=melee
                    [specials]
			            {WEAPON_SPECIAL_DRAIN}
			            {WEAPON_SPECIAL_BACKSTAB}
                    [/specials]
                    damage=3
                    number=2
                    attack_weight=2#make the bite attack used/recommended more often, since blood is very important for vampires
                [/effect]
                [effect]
                    apply_to=attack
                    name=vampire_bite
                    increase_damage=2
                    times=per level
                [/effect]
       			[effect]
       			    apply_to=new_animation
    				[attack_anim]
    				    [filter_attack]
    				        name=vampire_bite
    				    [/filter_attack]
    				    start_time=-250
    				    [frame]
    				        duration=400
    				    [/frame]
    				    {SOUND:HIT_AND_MISS bite.ogg {SOUND_LIST:MISS} -100}
    				[/attack_anim]
       			[/effect]
                [effect]
                    apply_to=new_animation
                    [extra_anim]
                        flag=sunlight_damage
                        [missile_frame]
                            halo="halo/holy/light-beam-[1~7,6~1].png:[30*6,130,70*6]"
                            offset=0.0
                            auto_vflip=no
                        [/missile_frame]
                        [frame]
                            duration=200
                            sound={SOUND_LIST:HOLY}
                        [/frame]
                        [frame]
                            duration=200
                            sound=fire.wav
                        [/frame]
                    [/extra_anim]
                [/effect]
            [/object]           
            #bonus bite damage if a unit starts as melee-only (doesn't cover cases with a weak ranged attack like spearman, but better than nothing)
            [object]
                silent=yes
                duration=forever
                [filter]
                    id=$this_item.id
                    [not]
                    	[has_attack]
                    		range=ranged
                    	[/has_attack]
                    [/not]
                [/filter]
                [effect]
                    apply_to=attack
                    name=vampire_bite
                    increase_damage=1
                    times=per level
                [/effect]
            [/object]
    		[modify_unit]
    		    [filter]
    		    	id=$this_item.id
    		    [/filter]
                {TRAIT_VAMPIRE}
    		[/modify_unit]
            #apply vampirism strength bonus
            {APPLY_VAMPIRE_STRENGTH_BONUS id=$this_item.id}
        [/do]
    [/foreach]

    {CLEAR_VARIABLE vampirism_converted}
#enddef

#decided to tie the "xp from gaining blood" to the floating text macro, so that stuff like "quietly fully refill all blood" doesn't give XP. maybe change that later
#define VAMPIRISM_GAIN_BLOOD_FLOATTEXT_AND_XP UNITVAR X Y AMOUNT
    #logic to ensure the blood text shows only the correct number of blood gained when it's close to max, and doesn't show anything when already full
    {VARIABLE tmp_blood_visible_amount {AMOUNT}}

    {IF_VAR tmp_blood_visible_amount greater_than "$(${UNITVAR}.variables.vampirism_max_blood - ${UNITVAR}.variables.vampirism_blood)" (
    [then]
        {VARIABLE tmp_blood_visible_amount "$(${UNITVAR}.variables.vampirism_max_blood - ${UNITVAR}.variables.vampirism_blood)"}
    [/then]
    )}
    {IF_VAR tmp_blood_visible_amount greater_than 0 (
    [then]

    [floating_text]
       x,y={X},{Y}
       text=_"<span color='#ff0000'>+$tmp_blood_visible_amount| blood</span>"
    [/floating_text]

    #gain a bit of vampire xp every time you gain blood
    [modify_unit]
        [filter]
            id=${UNITVAR}.id
        [/filter]
        {VARIABLE_OP vampirism_xp add "$($tmp_blood_visible_amount| * 0.2)"}
        {VARIABLE vampirism_xp_recently_modified yes}#needed for levelups
    [/modify_unit]
    {VAMPIRE_CHECK_XP_OF_ALL_VAMPIRES_FOR_LEVELUP}
    [/then]
    )}
    {CLEAR_VARIABLE tmp_blood_visible_amount}
#enddef

#define VAMPIRISM_GAIN_BLOOD FILTER AMOUNT
    #foreach loop to be able to affect multiple vampires at once
    [store_unit]
        [filter]
            {FILTER}
        [/filter]
        variable=vampirism_fed
        kill=no
    [/store_unit]
    [foreach]
        array=vampirism_fed
        index_var=i
        [do]
            {VARIABLE_OP this_item.variables.vampirism_blood add {AMOUNT}}

            {IF_VAR this_item.variables.vampirism_blood greater_than $this_item.variables.vampirism_max_blood (
            [then]
                {VARIABLE this_item.variables.vampirism_blood $this_item.variables.vampirism_max_blood}
            [/then]
            )}
            [unstore_unit]
                variable=this_item
                find_vacant=no
            [/unstore_unit]

            #remove hunger if you are at or above 40% blood capacity:

            {IF_VAR this_item.variables.vampirism_blood greater_than_equal_to "$($this_item.variables.vampirism_max_blood * 0.4)" (
            [then]
                [remove_object]
                    id=$this_item.id
                    object_id=vampire_hunger
                [/remove_object]
            [/then]
            )}
        [/do]
    [/foreach]
    {CLEAR_VARIABLE vampirism_fed}
#enddef

#define VAMPIRE_LEVELUP FILTER
    #foreach loop to be able to affect multiple vampires at once
    [store_unit]
        [filter]
            {FILTER}
        [/filter]
        variable=vampirism_levelup
        kill=no
    [/store_unit]
    [foreach]
        array=vampirism_levelup
        variable=this_item_levelup#so this can be more safely included inside other foreach loops, just in case
        index_var=l
        [do]
            [if]
            {VARIABLE_CONDITIONAL this_item_levelup.variables.vampirism_level less_than 10}#10 is max level
            [then]
            {VARIABLE_OP this_item_levelup.variables.vampirism_level add 1}

            {VARIABLE_OP this_item_levelup.variables.vampirism_max_blood add 5}
            {VARIABLE_OP this_item_levelup.variables.vampirism_xp sub $this_item_levelup.variables.vampirism_max_xp}
            {VARIABLE this_item_levelup.variables.vampirism_max_xp "$($this_item_levelup.variables.vampirism_level| * 50)"}
            {VARIABLE_OP this_item_levelup.variables.vampirism_strength_bonus_level add 1}#equal to vampire level by default. TO AVOID SKILLS AND LEVELUPS, CONFLICTING DO NOT SET IT ON LEVELUP, ONLY ADD IT

            #gain <1 + new vampire level / 2, rounded up> skill points with each vampire level
            {VARIABLE_OP this_item_levelup.variables.vampirism_skillpoints add "$(1 + $this_item_levelup.variables.vampirism_level| / 2)"}#used for buying vampire powers
            {VARIABLE_OP this_item_levelup.variables.vampirism_skillpoints round ceil}

            [unstore_unit]
                variable=this_item_levelup
                find_vacant=no
            [/unstore_unit]

            #apply vampirism strength bonus
            {APPLY_VAMPIRE_STRENGTH_BONUS id=$this_item_levelup.id}

            #extra effects based on new level

            [switch]
                variable=this_item_levelup.variables.vampirism_level
                [case]
                    value=1
                    #none, vampires already start at lvl1
                [/case]
                [case]
                    value=2
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level2_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                        [effect]
                            apply_to=resistance
                            replace=no
                            [resistance]
                                arcane=10
                                cold=-10
                            [/resistance]
                        [/effect]
                    [/object]
                [/case]
                [case]
                    value=3
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level3_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                    [/object]                    
                [/case]
                [case]
                    value=4
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level4_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                        [effect]
                            apply_to=resistance
                            replace=no
                            [resistance]
                                arcane=10
                                fire=10
                                cold=-10
                            [/resistance]
                        [/effect]
                    [/object]
                [/case]
                [case]
                    value=5
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level5_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                    [/object]                    
                [/case]
                [case]
                    value=6
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level6_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                        [effect]
                            apply_to=level
                            increase=1
                        [/effect]
                        [effect]
                            apply_to=resistance
                            replace=no
                            [resistance]
                                arcane=10
                                cold=-10
                            [/resistance]
                        [/effect]
                    [/object]
                [/case]
                [case]
                    value=7
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level7_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                    [/object]
                [/case]
                [case]
                    value=8
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level8_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                        [effect]
                            apply_to=resistance
                            replace=no
                            [resistance]
                                arcane=10
                                fire=10
                                cold=-10
                            [/resistance]
                        [/effect]
                    [/object]
                [/case]
                [case]
                    value=9
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level9_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                    [/object]
                [/case]
                [case]
                    value=10
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level10_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                        [effect]
                            apply_to=level
                            increase=1
                        [/effect]
                        [effect]
                            apply_to=resistance
                            replace=no
                            [resistance]
                                arcane=10
                                cold=-10
                            [/resistance]
                        [/effect]
                    [/object]
                [/case]
            [/switch]
        [/then]
        [/if]
        [/do]
    [/foreach]
    {CLEAR_VARIABLE vampirism_levelup}
#enddef

#define VAMPIRE_CHECK_HUNGER UNITVAR
            [if]
            [have_unit]
                id=${UNITVAR}.id
                ability=vampirism
                [and]
                    formula="self.wml_vars.vampirism_blood = 0"
                [/and]
                [not]
                    ability=vampire_hunger
                [/not]
            [/have_unit]
            [then]

            [sound]
                name={SOUND_LIST:DRAKE_HIT}
            [/sound]
            [floating_text]
               x,y=${UNITVAR}.x,${UNITVAR}.y
               text=_"<span color='#ff0000'>Hunger!</span>"
            [/floating_text]

            [object]
                silent=yes
                duration=forever
                id=vampire_hunger
                take_only_once=no
                [filter]
                    id=${UNITVAR}.id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_VAMPIRE_HUNGER}
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=attack
                    name=vampire_bite
                    remove_specials=backstab
                    [set_specials]
                        mode=append
                        {WEAPON_SPECIAL_BERSERK}
                    [/set_specials]
                [/effect]
            [/object]

            [/then]
            [/if]
#enddef

#unused macro
##define VAMPIRE_CHECK_XP_FOR_LEVELUP UNITVAR
#            [if]
#            [have_unit]
#                id=${UNITVAR}.id
#                ability=vampirism
#                [and]
#                    formula="self.wml_vars.vampirism_xp >= self.wml_vars.vampirism_max_xp"
#                [/and]
#                [and]
#                    formula="self.wml_vars.vampirism_max_xp > 0"
#                [/and]
#            [/have_unit]
#            [then]
#
#            #delay to avoid overlap with blood floating text
#
#            [delay]
#                time=50
#            [/delay]
#
#            [sound]
#                name={SOUND_LIST:LICH_HIT}
#            [/sound]
#            [floating_text]
#               x,y=${UNITVAR}.x,${UNITVAR}.y
#               text=_"<span color='#ff0000'>Level up!</span>"
#            [/floating_text]
#
#            {VAMPIRE_LEVELUP id=${UNITVAR}.id}
#
#            [/then]
#            [/if]
##enddef

#define VAMPIRE_CHECK_XP_OF_ALL_VAMPIRES_FOR_LEVELUP
#    [chat]
#        message=_"trying to store vampires for levelup comparison"
#    [/chat]
    [store_unit]
        [filter]
            ability=vampirism
            [filter_wml]
                [variables]
                    vampirism_xp_recently_modified=yes
                [/variables]
            [/filter_wml]
        [/filter]
        variable=vampirism_check_levelup
        kill=no
    [/store_unit]
    [foreach]
        array=vampirism_check_levelup
        index_var=f
        [do]
#            [chat]
#                message=_"comparing $this_item.variables.vampirism_xp| / $this_item.variables.vampirism_max_xp|"
#            [/chat]
            [if]
            {VARIABLE_CONDITIONAL this_item.variables.vampirism_xp greater_than_equal_to $this_item.variables.vampirism_max_xp}
            [then]
            #delay to avoid overlap with blood floating text

            [delay]
                time=50
            [/delay]

            [sound]
                name={SOUND_LIST:LICH_HIT}
            [/sound]
            [floating_text]
               x,y=$this_item.x,$this_item.y
               text=_"<span color='#ff0000'>Level up!</span>"
            [/floating_text]

            {VAMPIRE_LEVELUP id=$this_item.id}
            [/then]
            [/if]

            #clear the recently-modified xp variable to avoid the event triggering more than necessary

            [modify_unit]
                [filter]
                    id=$this_item.id
                [/filter]
                {CLEAR_VARIABLE vampirism_xp_recently_modified}
            [/modify_unit]
            
        [/do]
    [/foreach]
#enddef

[event]
	name=start
	id=vampirism_start
	first_time_only=no
	{TURN_INTO_VAMPIRE canrecruit=yes}
[/event]

[event]
	name=side turn
	id=vampirism_sunlight_damage
	first_time_only=no
	[store_unit]
		[filter]
			side=$side_number
			ability=vampirism
            [filter_location]
                time_of_day=lawful
                [not]
                	#castles, keeps, and villages provide shelter from the sun
                	terrain=C*^*,K*^*,*^V*
                [/not]
            [/filter_location]
			[not]
				[filter_wml]
					[status]
						petrified=yes
					[/status]
				[/filter_wml]
			[/not]
		[/filter]
		variable=burned_vampires
		kill=no
	[/store_unit]
    [foreach]
        array=burned_vampires
        index_var=i
        [do]
        	{VARIABLE tmp_vampire_sun_damage "$(5 + $this_item.variables.vampirism_level| * 5)"}
            [animate_unit]
                flag=sunlight_damage
                [filter]
                    id=$this_item.id
                [/filter]
            [/animate_unit] 
			[harm_unit]
				[filter]
					id=$this_item.id
				[/filter]
				amount=$tmp_vampire_sun_damage
				experience=no
				fire_event=yes
				animate=yes
			[/harm_unit] 
        [/do]
    [/foreach]
    {CLEAR_VARIABLE burned_vampires}
    {CLEAR_VARIABLE tmp_vampire_sun_damage}
[/event]


[event]
    name=side turn
    id=vampirism_hunger
    first_time_only=no
    [store_unit]
        [filter]
            side=$side_number
            ability=vampirism
            #TODO: add a "not in day sleep" check for hunger!!!
            [filter_location]
                [not]
                    #vampires can feed in villages each turn, so remove the hunger penalty there
                    terrain=*^V*
                    [not]
                        #vampires cannot feed in villages at day because of sunlight, so they will still go hungry in a village, but at least they can hide from the sun. This is to encourage the Day Sleep mechanic to conserve blood instead of being able to just farm villages for blood at daytime
                        time_of_day=lawful
                    [/not]
                [/not]
            [/filter_location]
            [not]
                [filter_wml]
                    [status]
                        petrified=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter]
        variable=hungry_vampires
        kill=no
    [/store_unit]
    [foreach]
        array=hungry_vampires
        index_var=i
        [do]
            {VARIABLE_OP this_item.variables.vampirism_blood sub 1}
            {IF_VAR this_item.variables.vampirism_blood less_than 0 (
            [then]
                {VARIABLE this_item.variables.vampirism_blood 0}
            [/then]
            )}
            [unstore_unit]
                variable=this_item
                find_vacant=no
            [/unstore_unit]
            {VAMPIRE_CHECK_HUNGER this_item}
        [/do]
    [/foreach]
    {CLEAR_VARIABLE hungry_vampires}
[/event]

[event]
    name=side turn
    id=vampirism_feeding
    first_time_only=no
    [store_unit]
        [filter]
            side=$side_number
            ability=vampirism
            #TODO: add a "not in day sleep" check for feeding!!!
            [filter_location]
                terrain=*^V*
                [not]
                    #vampires cannot feed in villages at day because of sunlight
                    time_of_day=lawful
                [/not]
            [/filter_location]
            [not]
                [filter_wml]
                    [status]
                        petrified=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter]
        variable=feeding_vampires
        kill=no
    [/store_unit]
    [foreach]
        array=feeding_vampires
        index_var=i
        [do]
            [sound]
                name=bite.ogg
            [/sound]
            {VAMPIRISM_GAIN_BLOOD id=$this_item.id 4}
            {VAMPIRISM_GAIN_BLOOD_FLOATTEXT_AND_XP this_item $this_item.x $this_item.y 4}
        [/do]
    [/foreach]
    {CLEAR_VARIABLE hungry_vampires}
[/event]

#TODO: maybe make it so that the drained blood is limited by how much HP the enemy has left (otherwise you can farm blood a bit too quickly by insta killing weak wounded enemies)

[event]
    name=attacker_hits
    id=vampirism_blood_drain
    first_time_only=no
    [filter_attack]
        special_id=drains
    [/filter_attack]
    [filter]
        ability=vampirism
    [/filter]
    [filter_second]
        [not]
            status=undrainable
        [/not]
    [/filter_second]
    {VARIABLE tmp_blood_drained $damage_inflicted}
    #COMMENTED OUT FOR NOW, THE "100% blood drain if at full hp" mechanic MIGHT COMPLICATE BALANCING THE MOD, THINK LATER ABOUT WHETHER TO RE-ADD IT
    ##if vampire is at full HP, all drained HP is converted to blood, otherwise it's half drain healing, half blood
    #{IF_VAR unit.hitpoints less_than unit.max_hitpoints (
    #[then]
        {VARIABLE_OP tmp_blood_drained divide 2}
    #[/then]
    #)}
    {VARIABLE_OP tmp_blood_drained round floor}
    {VAMPIRISM_GAIN_BLOOD id=$unit.id $tmp_blood_drained}
    {VAMPIRISM_GAIN_BLOOD_FLOATTEXT_AND_XP unit $unit.x $unit.y $tmp_blood_drained}
    {CLEAR_VARIABLE tmp_blood_drained}
[/event]

[event]
    name=defender_hits
    id=vampirism_blood_drain2
    first_time_only=no
    [filter_second_attack]
        special_id=drains
    [/filter_second_attack]
    [filter_second]
        ability=vampirism
    [/filter_second]
    [filter]
        [not]
            status=undrainable
        [/not]
    [/filter]
    {VARIABLE tmp_blood_drained $damage_inflicted}
    #COMMENTED OUT FOR NOW, THE "100% blood drain if at full hp" mechanic MIGHT COMPLICATE BALANCING THE MOD, THINK LATER ABOUT WHETHER TO RE-ADD IT
    ##if vampire is at full HP, all drained HP is converted to blood, otherwise it's half drain healing, half blood
    #{IF_VAR unit.hitpoints less_than unit.max_hitpoints (
    #[then]
        {VARIABLE_OP tmp_blood_drained divide 2}
    #[/then]
    #)}
    {VARIABLE_OP tmp_blood_drained round floor}
    {VAMPIRISM_GAIN_BLOOD id=$second_unit.id $tmp_blood_drained}
    {VAMPIRISM_GAIN_BLOOD_FLOATTEXT_AND_XP second_unit $second_unit.x $second_unit.y $tmp_blood_drained}
    {CLEAR_VARIABLE tmp_blood_drained}
[/event]

#vampires get some vampire XP when killing anything

[event]
    name=die
    id=vampirism_kill_xp_nondrain
    first_time_only=no
    [filter_second]
        ability=vampirism
    [/filter_second]
    {IF_VAR unit.level equals 0 (
    [then]
    [modify_unit]
        [filter]
            id=$second_unit.id
        [/filter]
        {VARIABLE_OP vampirism_xp add 2}
    [/modify_unit]
    [/then]
    [else]
    [modify_unit]
        [filter]
            id=$second_unit.id
        [/filter]
        {VARIABLE_OP vampirism_xp add "$($unit.level| * 4)"}
        {VARIABLE vampirism_xp_recently_modified yes}#needed for levelups
    [/modify_unit]
    {VAMPIRE_CHECK_XP_OF_ALL_VAMPIRES_FOR_LEVELUP}

    [/else]
    )}
[/event]

#if a vampire kills a living enemy while using a draining attack, they gain additional vampire XP on top of the guaranteed vampire XP

#killing without drain gives half the normal kill XP worth of vampire XP, killing with drain gives 1.5x the normal XP worth of vampire XP

[event]
    name=die
    id=vampirism_kill_xp_drain
    first_time_only=no
    [filter_second_attack]
        special_id=drains
    [/filter_second_attack]
    [filter_second]
        ability=vampirism
    [/filter_second]
    [filter]
        [not]
            status=undrainable
        [/not]
    [/filter]
    {IF_VAR unit.level equals 0 (
    [then]
    [modify_unit]
        [filter]
            id=$second_unit.id
        [/filter]
        {VARIABLE_OP vampirism_xp add 4}
    [/modify_unit]
    [/then]
    [else]
    [modify_unit]
        [filter]
            id=$second_unit.id
        [/filter]
        {VARIABLE_OP vampirism_xp add "$($unit.level| * 8)"}
        {VARIABLE vampirism_xp_recently_modified yes}#needed for levelups
    [/modify_unit]
    {VAMPIRE_CHECK_XP_OF_ALL_VAMPIRES_FOR_LEVELUP}

    [/else]
    )}
[/event]
