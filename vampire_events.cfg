#textdomain wesnoth-vampirism



#define ABILITY_VAMPIRISM
    #the [vampirism] tag is used for the lua code to check ability by tag
    [vampirism]
        id=vampirism
        name= _ "vampirism"
        female_name= _ "female^vampirism"
        description= _ "This unit is a vampire, with the following advantages and downsides:

-more hitpoints and damage
-access to the vampire menu via rightclicking on the unit
-can gain Blood by attacking enemies with a drain attack (gives Blood equal to half the damage dealt)
-can gain Blood by standing in villages, since you will drink blood from villagers (however, blood gain from villages is halved at daytime, as sunlight makes it harder to hunt, unless you have Daywalker upgrade)
-Blood is needed for vampire powers, and you passively lose a bit of Blood each turn. if your Blood reaches 0, you gain the 'hunger' ability, which makes your bite attack have berserk, makes non-draining attacks very weak, and has some other downsides.
-If you start a turn with 0 Blood, you take damage proportional to your hunger rate (how much Blood you lose each turn). Like poison, this cannot reduce HP below 1.
-increased cold resistance but reduced arcane/fire resistances
-at day, take damage from sunlight (daytime ToD) every turn unless you are in a castle or village tile, or have Slumber active (and the higher your vampire level, the more sunlight damage you take)
-your attacks deal an additional 25% less damage at day, on top of the normal ToD damage reduction (unless you have the Daywalker upgrade)"
    [/vampirism]
    [leadership]
        id=vampirism_day_debuff
        sub=25
        affect_self=yes
        [filter]
            [filter_location]
                time_of_day=lawful
            [/filter_location]
            [not]
                ability=vampire_daywalker
            [/not]
        [/filter]
    [/leadership]
#enddef

#define ABILITY_VAMPIRE_HUNGER
    [dummy]
        id=vampire_hunger
        name= _ "hungry"
        female_name= _ "female^hungry"
        description= _ "This vampire is hungry and frenzied from not having drank enough blood (Blood reached 0). This applies the following effects while active:
-66% damage to all non-draining attacks (unless you have the Controlled Rage upgrade, in which case the penalty is reduced by 25%)
bite attack gains berserk special
if bite had backstab, bite attack loses backstab, but gains +25% damage
If you start a turn with 0 Blood, you take damage proportional to your hunger rate (how much Blood you lose each turn). Like poison, this cannot reduce HP below 1.
arcane resistance is reduced by 30%
Hunger is removed when your blood is at least 40% of max blood."
    [/dummy]
    [leadership]
        id=vampirism_hunger_bitebuff
        add=25#50
        affect_self=yes
        [filter_weapon]
            name=vampire_bite,batform_fangs
            special_id=vampirism_bite_had_backstab
        [/filter_weapon]
    [/leadership]
#removed due to no longer being used
#    [leadership]
#        id=vampirism_hunger_bitebuff
#        add=25
#        affect_self=yes
#        [filter_weapon]
#            name=vampire_bite,batform_fangs
#            [not]
#                special_id=backstab
#            [/not]
#        [/filter_weapon]
#    [/leadership]
    [leadership]
        id=vampirism_hunger_debuff
        sub=66
        affect_self=yes
        [filter_self]
            [not]
                ability=vampirism_frenzy2
            [/not]
        [/filter_self]
        [filter_weapon]
            [not]
                special_id=drains
            [/not]
        [/filter_weapon]
    [/leadership]
    [leadership]
        id=vampirism_hunger_debuff
        sub=25
        affect_self=yes
        [filter_self]
            ability=vampirism_frenzy2
        [/filter_self]
        [filter_weapon]
            [not]
                special_id=drains
            [/not]
        [/filter_weapon]
    [/leadership]
    [resistance]
        id=vampirism_hunger_arcane_debuff
        sub=30
        max_value=100
        apply_to=arcane
        affect_self=yes
        affect_allies=no
    [/resistance]
    #berserk is applied directly via object
#enddef

#vampirism_vampire instead of vampire is intentionally, to avoid id overlap with War of Legends vampires

#define TRAIT_VAMPIRISM_VAMPIRE
    # Units with trait Vampire cannot be poisoned, or plagued, but can still be drained
    [trait]
        id=vampirism_vampire
        availability="musthave"
        male_name= _ "vampire"
        female_name= _ "female^vampire"
        description= _ "Immune to poison, and plague"
        help_text= _ "<italic>text='Vampire'</italic> units are immune to poison and plague, and have access to various vampire powers. However, they require 100% more experience to advance normally."
        #added the XP increase to ensure vampires don't just quickly rush to level 3-4 while still having a low level of vampirism. It is also meant to reflect vampires being generally more stagnant.
        [effect]
            apply_to=max_experience
            increase=100%
        [/effect]
        [effect]
            apply_to=status
            add=unpoisonable
        [/effect]
#        [effect]
#            apply_to=status
#            add=undrainable
#        [/effect]
        [effect]
            apply_to=status
            add=unplagueable
        [/effect]
    [/trait]
#enddef

#define APPLY_VAMPIRE_STRENGTH_BONUS FILTER
    #foreach loop to be able to affect multiple vampires at once
    [store_unit]
        [filter]
            {FILTER}
            [and]
                ability=vampirism
            [/and]
        [/filter]
        variable=vampirism_buffed
        kill=no
    [/store_unit]
    [foreach]
        array=vampirism_buffed
        variable=this_item_strength#so this can be more safely included inside other foreach loops
        index_var=e
        [do]
            #reset the old buff
            [remove_object]
                id=$this_item_strength.id
                object_id=vampire_strength_bonus
            [/remove_object]

            {VARIABLE tmp_vampire_hp_buff "$($this_item_strength.variables.vampirism_strength_bonus_level * 5)"}
            {VARIABLE tmp_vampire_dmg_buff "$($this_item_strength.variables.vampirism_strength_bonus_level * 5)"}

            [object]
                silent=yes
                duration=forever
                id=vampire_strength_bonus
                take_only_once=no
                [filter]
                    id=$this_item_strength.id
                [/filter]
                [effect]
                    apply_to=hitpoints
                    increase=$tmp_vampire_hp_buff|%
                    increase_total=$tmp_vampire_hp_buff|%
                [/effect]
                [effect]
                    apply_to=attack
                    increase_damage=$tmp_vampire_dmg_buff|%
                [/effect]
            [/object]

            #if the unit stats are strong enough, increase level accordingly. right now it's set to "+1 normal level every 10 vampire strength"
            [if]
            {VARIABLE_CONDITIONAL this_item_strength.variables.vampirism_strength_bonus_level greater_than_equal_to 10}
            [then]
            [modify_unit]
                [filter]
                    id=$this_item_strength.id
                [/filter]
                {VARIABLE vampirism_unitlevel_bonus $this_item_strength.variables.vampirism_strength_bonus_level}
                {VARIABLE_OP vampirism_unitlevel_bonus divide 10}
                {VARIABLE_OP vampirism_unitlevel_bonus round floor}
            [/modify_unit]
            {VAMPIRISM_UPDATE_ACTUAL_LEVEL $this_item_strength.id}
            [/then]
            [/if]
        [/do]
    [/foreach]
    {CLEAR_VARIABLE vampirism_buffed}
    {CLEAR_VARIABLE tmp_vampire_hp_buff}
    {CLEAR_VARIABLE tmp_vampire_dmg_buff}
#enddef

#define TURN_INTO_VAMPIRE FILTER
	#foreach loop to be able to turn multiple units into vampires at once
    [store_unit]
        [filter]
        	{FILTER}
            [not]
                {VAMPIRE_EXCLUDED_FILTER}
            [/not]
        [/filter]
        variable=vampirism_converted
        kill=no
    [/store_unit]
    [foreach]
        array=vampirism_converted
        index_var=i
        [do]
        	{VARIABLE this_item.variables.vampirism_level 1}
        	{VARIABLE this_item.variables.vampirism_max_blood 20}#vampires start with 20 blood capacity, and gain 5 each levelup
#        	{VARIABLE this_item.variables.vampirism_blood "$($this_item.variables.vampirism_max_blood| / 2)"}
#start vampires at 20 Blood initially - full for a lvl1 vampire, not full for higher-level vampire starts or Siring II and above
#TODO: maybe make newly-made vampires start at full blood even if having a high level?
            {VARIABLE this_item.variables.vampirism_blood 20}
        	{VARIABLE this_item.variables.vampirism_xp 0}
        	{VARIABLE this_item.variables.vampirism_max_xp "$($this_item.variables.vampirism_level| * 50 * $vampirism_xp_modifier_mult|)"}
            {VARIABLE_OP this_item.variables.vampirism_max_xp round floor}#vampirism_xp_modifier_mult turns the number into a float which takes up UI space, so we round it down
            {VARIABLE this_item.variables.vampirism_strength_bonus_level 1}#equal to vampire level by default. TO AVOID SKILLS AND LEVELUPS, CONFLICTING DO NOT SET IT ON LEVELUP, ONLY ADD IT
            {VARIABLE this_item.variables.vampirism_skillpoints 2}#used for buying vampire powers

            {VARIABLE this_item.variables.vampirism_blood_from_village 6}#blood gained from standing in a village for a turn. can be upgraded
            {VARIABLE this_item.variables.vampirism_blood_from_village_greatfeast 36}#blood gained from the Great Feast power. upgraded at the same time as you upgrade Great Feast
            {VARIABLE this_item.variables.vampirism_hunger_rate 1}#how much Blood you lose per turn automatically (increases with vampire level, so it's not something you can ignore TOO easily even when you have high blood capacity)

            [unstore_unit]
                variable=this_item
                find_vacant=no
            [/unstore_unit]
            [object]
                silent=yes
                duration=forever
                id=vampire_initial_object
                take_only_once=no
                [filter]
                    id=$this_item.id
                [/filter]
                [effect]
                    apply_to=alignment
                    set=chaotic
                [/effect]
           		[effect]
           		    apply_to=new_ability
           		    [abilities]
           		    	{ABILITY_VAMPIRISM}
           		    [/abilities]
           		[/effect]
                #become more resistant to cold, but weaker to arcane/fire
                [effect]
                    apply_to=resistance
                    replace=no
                    [resistance]
                        arcane=20
                        fire=10
                        cold=-20
                    [/resistance]
                [/effect]
                [effect]
                    apply_to=new_attack
                    name=vampire_bite#to avoid overlap with any existing bite attacks
                    description= _ "bite"
                    icon=attacks/fangs.png
                    type=pierce
                    range=melee
                    [specials]
			            {WEAPON_SPECIAL_DRAIN}
			            {WEAPON_SPECIAL_BACKSTAB}
                    [/specials]
                    damage=3
                    number=2
                    attack_weight=2#make the bite attack used/recommended more often, since blood is very important for vampires
                [/effect]
                [effect]
                    apply_to=attack
                    name=vampire_bite
                    increase_damage=2
                    times=per level
                [/effect]
       			[effect]
       			    apply_to=new_animation
    				[attack_anim]
    				    [filter_attack]
    				        name=vampire_bite
    				    [/filter_attack]
    				    start_time=-250
    				    [frame]
    				        duration=400
    				    [/frame]
    				    {SOUND:HIT_AND_MISS bite.ogg {SOUND_LIST:MISS} -100}
    				[/attack_anim]
       			[/effect]
                [effect]
                    apply_to=new_animation
                    [extra_anim]
                        flag=sunlight_damage
                        [missile_frame]
                            halo="halo/holy/light-beam-[1~7,6~1].png:[30*6,130,70*6]"
                            offset=0.0
                            auto_vflip=no
                        [/missile_frame]
                        [frame]
                            duration=200
                            sound={SOUND_LIST:HOLY}
                        [/frame]
                        [frame]
                            duration=200
                            sound=fire.wav
                        [/frame]
                    [/extra_anim]
                [/effect]
            [/object]
            #slight tint, to make vampires more distinct
            #TODO: make tints optional and toggleable
            [object]
                silent=yes
                duration=forever
                id=vampire_tint
                take_only_once=no
                [filter]
                    id=$this_item.id
                [/filter]
                [effect]
                    apply_to=image_mod
                    add="~BLEND(128,64,128,0.3)"
                [/effect]
            [/object]
            #UPD: this has been scrapped for now, instead bite now has always "+3 damage per level" instead of +2 (melee-only units now get the advantage of Drain Life ranged attack upgrade being more useful to them)   
            ##bonus bite damage if a unit starts as melee-only (doesn't cover cases with a weak ranged attack like spearman, but better than nothing)
            #[object]
            #    silent=yes
            #    duration=forever
            #    [filter]
            #        id=$this_item.id
            #        [not]
            #        	[has_attack]
            #        		range=ranged
            #        	[/has_attack]
            #        [/not]
            #    [/filter]
            #    [effect]
            #        apply_to=attack
            #        name=vampire_bite
            #        increase_damage=1
            #        times=per level
            #    [/effect]
            #[/object]
    		[modify_unit]
    		    [filter]
    		    	id=$this_item.id
    		    [/filter]
                {TRAIT_VAMPIRISM_VAMPIRE}
    		[/modify_unit]
            #apply vampirism strength bonus
            {APPLY_VAMPIRE_STRENGTH_BONUS id=$this_item.id}
        [/do]
    [/foreach]

    {CLEAR_VARIABLE vampirism_converted}
#enddef

#decided to tie the "xp from gaining blood" to the floating text macro, so that stuff like "quietly fully refill all blood" doesn't give XP. maybe change that later
#define VAMPIRISM_GAIN_BLOOD_FLOATTEXT_AND_XP UNITVAR X Y AMOUNT
    #logic to ensure the blood text shows only the correct number of blood gained when it's close to max, and doesn't show anything when already full
    {VARIABLE tmp_blood_visible_amount {AMOUNT}}

    {IF_VAR tmp_blood_visible_amount greater_than "$(${UNITVAR}.variables.vampirism_max_blood - ${UNITVAR}.variables.vampirism_blood)" (
    [then]
        {VARIABLE tmp_blood_visible_amount "$(${UNITVAR}.variables.vampirism_max_blood - ${UNITVAR}.variables.vampirism_blood)"}
    [/then]
    )}
    {IF_VAR tmp_blood_visible_amount greater_than 0 (
    [then]

    [floating_text]
       x,y={X},{Y}
       text=_"<span color='#ff0000'>+$tmp_blood_visible_amount| blood</span>"
    [/floating_text]

    #gain a bit of vampire xp every time you gain blood
    [modify_unit]
        [filter]
            id=${UNITVAR}.id
        [/filter]
        {VARIABLE_OP vampirism_xp add "$($tmp_blood_visible_amount| * 0.3)"}
        {VARIABLE vampirism_xp_recently_modified yes}#needed for levelups
    [/modify_unit]
    {VAMPIRE_CHECK_XP_OF_ALL_VAMPIRES_FOR_LEVELUP}
    [/then]
    )}
    {CLEAR_VARIABLE tmp_blood_visible_amount}
#enddef

#define VAMPIRISM_GAIN_BLOOD FILTER AMOUNT
    #foreach loop to be able to affect multiple vampires at once
    [store_unit]
        [filter]
            {FILTER}
        [/filter]
        variable=vampirism_fed
        kill=no
    [/store_unit]
    [foreach]
        array=vampirism_fed
        index_var=i
        [do]
            {VARIABLE_OP this_item.variables.vampirism_blood add {AMOUNT}}

            {IF_VAR this_item.variables.vampirism_blood greater_than $this_item.variables.vampirism_max_blood (
            [then]
                {VARIABLE this_item.variables.vampirism_blood $this_item.variables.vampirism_max_blood}
            [/then]
            )}
            [unstore_unit]
                variable=this_item
                find_vacant=no
            [/unstore_unit]

            #remove hunger if you are at or above 40% blood capacity:

            {IF_VAR this_item.variables.vampirism_blood greater_than_equal_to "$($this_item.variables.vampirism_max_blood * 0.4)" (
            [then]
                [remove_object]
                    id=$this_item.id
                    object_id=vampire_hunger
                [/remove_object]
            [/then]
            )}
        [/do]
    [/foreach]
    {CLEAR_VARIABLE vampirism_fed}
#enddef

#define VAMPIRISM_UPDATE_ACTUAL_LEVEL ID
    [remove_object]
        id={ID}
        object_id=vampire_levelbonus
    [/remove_object]                
    [store_unit]
        [filter]
            id={ID}
            [and]
                ability=vampirism
            [/and]
        [/filter]
        variable=tmp_vamp_actuallevel_unit
        kill=no
    [/store_unit]
    [object]
        silent=yes
        duration=forever
        id=vampire_levelbonus
        take_only_once=no
        [filter]
            id={ID}
            [and]
                ability=vampirism
            [/and]
        [/filter]
        [effect]
            apply_to=level
            increase=$tmp_vamp_actuallevel_unit.variables.vampirism_unitlevel_bonus
        [/effect]
    [/object]
    {CLEAR_VARIABLE tmp_vamp_actuallevel_unit}
#enddef

#used for upgrades like Drain Life that have a times=per level effect that I want to scale with base level

#define VAMPIRISM_UPDATE_RESET_LEVEL_BEFORE_UPGRADE ID
    [remove_object]
        id={ID}
        object_id=vampire_levelbonus
    [/remove_object]
#enddef


#define VAMPIRE_LEVELUP FILTER
    #foreach loop to be able to affect multiple vampires at once
    [store_unit]
        [filter]
            {FILTER}
        [/filter]
        variable=vampirism_levelup
        kill=no
    [/store_unit]
    [foreach]
        array=vampirism_levelup
        variable=this_item_levelup#so this can be more safely included inside other foreach loops, just in case
        index_var=l
        [do]
            #until vampire level 10, vampire leveling happens as normal, past that point you get "vampire AMLA"
            #TODO: make it clearer to players how vampire AMLA works, maybe make the vampire XP menu turn purple after hitting max level


            #shared code for both normal and AMLA levelups:

            {IF_VAR tmp_vampire_no_xp_loss_on_levelup not_equals yes (
            [then]
                {VARIABLE_OP this_item_levelup.variables.vampirism_xp sub $this_item_levelup.variables.vampirism_max_xp}
            [/then]
            )}

            [if]
            {VARIABLE_CONDITIONAL this_item_levelup.variables.vampirism_level greater_than_equal_to 10}#10 is max level
            [then]

            #vampire AMLA

            #AMLA gives a slight bonus to max blood capacity

            {VARIABLE_OP this_item_levelup.variables.vampirism_max_blood add 5}

            #vampire AMLA gives 8 skillpoints per AMLA for now

            {VARIABLE_OP this_item_levelup.variables.vampirism_skillpoints add 8}

            #vampire AMLA increases max vampire XP by 20%, instead of a flat +50, to make it scale slower and more similarly to normal AMLA

            {VARIABLE this_item_levelup.variables.vampirism_max_xp "$($this_item_levelup.variables.vampirism_max_xp| * 1.2)"}
            {VARIABLE_OP this_item_levelup.variables.vampirism_max_xp round floor}#vampirism_xp_modifier_mult turns the number into a float which takes up UI space, so we round it down

            [unstore_unit]
                variable=this_item_levelup
                find_vacant=no
            [/unstore_unit]
            [/then]
            [else]

            {VARIABLE_OP this_item_levelup.variables.vampirism_level add 1}

            {VARIABLE_OP this_item_levelup.variables.vampirism_max_blood add 5}
            {VARIABLE this_item_levelup.variables.vampirism_max_xp "$($this_item_levelup.variables.vampirism_level| * 50 * $vampirism_xp_modifier_mult|)"}
            {VARIABLE_OP this_item_levelup.variables.vampirism_max_xp round floor}#vampirism_xp_modifier_mult turns the number into a float which takes up UI space, so we round it down
            {VARIABLE_OP this_item_levelup.variables.vampirism_xp round floor}#round down the normal xp when leveling up, just in case
            {VARIABLE_OP this_item_levelup.variables.vampirism_strength_bonus_level add 1}#equal to vampire level by default. TO AVOID SKILLS AND LEVELUPS, CONFLICTING DO NOT SET IT ON LEVELUP, ONLY ADD IT

            #gain <2 + new vampire level / 2, rounded up> skill points with each vampire level
            {VARIABLE_OP this_item_levelup.variables.vampirism_skillpoints add "$(2 + $this_item_levelup.variables.vampirism_level| / 2)"}#used for buying vampire powers
            {VARIABLE_OP this_item_levelup.variables.vampirism_skillpoints round ceil}

            [unstore_unit]
                variable=this_item_levelup
                find_vacant=no
            [/unstore_unit]

            #apply vampirism strength bonus
            {APPLY_VAMPIRE_STRENGTH_BONUS id=$this_item_levelup.id}

            #extra effects based on new level

            [switch]
                variable=this_item_levelup.variables.vampirism_level
                [case]
                    value=1
                    #none, vampires already start at lvl1
                [/case]
                [case]
                    value=2
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level2_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                        [effect]
                            apply_to=resistance
                            replace=no
                            [resistance]
                                arcane=10
                                cold=-10
                            [/resistance]
                        [/effect]
                    [/object]
                [/case]
                [case]
                    value=3
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level3_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                    [/object]                    
                [/case]
                [case]
                    value=4
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level4_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                        [effect]
                            apply_to=resistance
                            replace=no
                            [resistance]
                                arcane=10
                                fire=10
                                cold=-10
                            [/resistance]
                        [/effect]
                    [/object]
                    #becoming a stronger vampire also makes you hungrier for blood
                    [modify_unit]
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                        {VARIABLE_OP vampirism_hunger_rate add 1}
                    [/modify_unit]
                [/case]
                [case]
                    value=5
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level5_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                    [/object]                    
                [/case]
                [case]
                    value=6
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level6_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
#now handled by vampirism_unitlevel_bonus
#                        [effect]
#                            apply_to=level
#                            increase=1
#                        [/effect]
                        [effect]
                            apply_to=resistance
                            replace=no
                            [resistance]
                                arcane=10
                                cold=-10
                            [/resistance]
                        [/effect]
                    [/object]
#now actual level is handled directly in "vampire strength" instead of tied to vampire level
#                    [modify_unit]
#                        [filter]
#                            id=$this_item_levelup.id
#                        [/filter]
#                        {VARIABLE_OP vampirism_unitlevel_bonus add 1}
#                    [/modify_unit]
#                    {VAMPIRISM_UPDATE_ACTUAL_LEVEL $this_item_levelup.id}
                [/case]
                [case]
                    value=7
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level7_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                    [/object]
                    #becoming a stronger vampire also makes you hungrier for blood
                    [modify_unit]
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                        {VARIABLE_OP vampirism_hunger_rate add 1}
                    [/modify_unit]
                [/case]
                [case]
                    value=8
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level8_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                        [effect]
                            apply_to=resistance
                            replace=no
                            [resistance]
                                arcane=10
                                fire=10
                                cold=-10
                            [/resistance]
                        [/effect]
                    [/object]
                [/case]
                [case]
                    value=9
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level9_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                    [/object]
                [/case]
                [case]
                    value=10
                    [object]
                        silent=yes
                        duration=forever
                        id=vampire_level10_effects
                        take_only_once=no
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
#now handled by vampirism_unitlevel_bonus
#                        [effect]
#                            apply_to=level
#                            increase=1
#                        [/effect]
                        [effect]
                            apply_to=resistance
                            replace=no
                            [resistance]
                                arcane=10
                                cold=-10
                            [/resistance]
                        [/effect]
                    [/object]
                    #becoming a stronger vampire also makes you hungrier for blood
                    [modify_unit]
                        [filter]
                            id=$this_item_levelup.id
                        [/filter]
                        {VARIABLE_OP vampirism_hunger_rate add 1}
                    [/modify_unit]
#now actual level is handled directly in "vampire strength" instead of tied to vampire level
#                    [modify_unit]
#                        [filter]
#                            id=$this_item_levelup.id
#                        [/filter]
#                        {VARIABLE_OP vampirism_unitlevel_bonus add 1}
#                    [/modify_unit]
#                    {VAMPIRISM_UPDATE_ACTUAL_LEVEL $this_item_levelup.id}
                [/case]
            [/switch]
        [/else]
        [/if]
        [/do]
    [/foreach]
    {CLEAR_VARIABLE vampirism_levelup}
#enddef

#define VAMPIRE_CHECK_HUNGER UNITVAR
            [if]
            [have_unit]
                id=${UNITVAR}.id
                ability=vampirism
                [and]
                    formula="self.wml_vars.vampirism_blood = 0"
                [/and]
                [not]
                    ability=vampire_hunger
                [/not]
            [/have_unit]
            [then]

            [sound]
                name={SOUND_LIST:DRAKE_HIT}
            [/sound]
            [floating_text]
               x,y=${UNITVAR}.x,${UNITVAR}.y
               text=_"<span color='#ff0000'>Hunger!</span>"
            [/floating_text]

            [object]
                silent=yes
                duration=forever
                id=vampire_hunger
                take_only_once=no
                [filter]
                    id=${UNITVAR}.id
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_VAMPIRE_HUNGER}
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=attack
                    name=vampire_bite,batform_fangs
                    special_id=backstab
                    remove_specials=backstab
                    [set_specials]
                        mode=append
                        #dummy special, needed to differentiate between bite attacks that had backstab before, and ones that didn't have backstab before removal (for hunger damage buff)
                        [dummy]
                            id=vampirism_bite_had_backstab
                        [/dummy]
                    [/set_specials]
                [/effect]
                [effect]
                    apply_to=attack
                    name=vampire_bite,batform_fangs
                    [set_specials]
                        mode=append
                        {WEAPON_SPECIAL_BERSERK}
                    [/set_specials]
                [/effect]
            [/object]

            [/then]
            [/if]
#enddef

#unused macro
##define VAMPIRE_CHECK_XP_FOR_LEVELUP UNITVAR
#            [if]
#            [have_unit]
#                id=${UNITVAR}.id
#                ability=vampirism
#                [and]
#                    formula="self.wml_vars.vampirism_xp >= self.wml_vars.vampirism_max_xp"
#                [/and]
#                [and]
#                    formula="self.wml_vars.vampirism_max_xp > 0"
#                [/and]
#            [/have_unit]
#            [then]
#
#            #delay to avoid overlap with blood floating text
#
#            [delay]
#                time=50
#            [/delay]
#
#            [sound]
#                name={SOUND_LIST:LICH_HIT}
#            [/sound]
#            [floating_text]
#               x,y=${UNITVAR}.x,${UNITVAR}.y
#               text=_"<span color='#ff0000'>Level up!</span>"
#            [/floating_text]
#
#            {VAMPIRE_LEVELUP id=${UNITVAR}.id}
#
#            [/then]
#            [/if]
##enddef

#define VAMPIRE_CHECK_XP_OF_ALL_VAMPIRES_FOR_LEVELUP
#    [chat]
#        message=_"trying to store vampires for levelup comparison"
#    [/chat]
    [store_unit]
        [filter]
            ability=vampirism
            [filter_wml]
                [variables]
                    vampirism_xp_recently_modified=yes
                [/variables]
            [/filter_wml]
        [/filter]
        variable=vampirism_check_levelup
        kill=no
    [/store_unit]
    [foreach]
        array=vampirism_check_levelup
        index_var=f
        [do]
#            [chat]
#                message=_"comparing $this_item.variables.vampirism_xp| / $this_item.variables.vampirism_max_xp|"
#            [/chat]
            [if]
            {VARIABLE_CONDITIONAL this_item.variables.vampirism_xp greater_than_equal_to $this_item.variables.vampirism_max_xp}
            [then]
            #delay to avoid overlap with blood floating text

            [delay]
                time=50
            [/delay]

            [sound]
                name={SOUND_LIST:LICH_HIT}
            [/sound]
            [floating_text]
               x,y=$this_item.x,$this_item.y
               text=_"<span color='#ff0000'>Level up!</span>"
            [/floating_text]

            {VAMPIRE_LEVELUP id=$this_item.id}
            [/then]
            [/if]

            #clear the recently-modified xp variable to avoid the event triggering more than necessary

            [modify_unit]
                [filter]
                    id=$this_item.id
                [/filter]
                {CLEAR_VARIABLE vampirism_xp_recently_modified}
            [/modify_unit]
            
        [/do]
    [/foreach]
#enddef

#non-living units, vampires, status, or bats cannot be turned into vampires (bats are excluded because they would make Batform meaningless as there's no humanoid (or at least not-bat) form for the vampire)

#define VAMPIRE_EXCLUDED_FILTER
    race=bats
    [or]
        status=unplagueable
    [/or]
    [or]
        status=petrified
    [/or]
    [or]
        ability=vampirism
    [/or]
#enddef

#define VAMPIRISM_CHECK_IF_CURRENT_SIDE_IS_AI
    [lua]
        code=<<
local result = wesnoth.sync.evaluate_single(
  function()
    return { value = "no" }
  end,
  function()
    -- Called only on the client handling the current side, if it is an AI.
    return { value = "yes" }
  end)
wml.variables["vampirism_is_ai"..wesnoth.current.side] = result.value
        >>
    [/lua]
#enddef

#define CONVERT_UMC_VAMPIRE_TO_VAMPIRISM_VAMPIRE ID
#unfortunately didn't seem to work, maybe it's because those traits were musthave
#    #remove undead/vampire traits from converted vampires so that they can pass the check and are drainable
#    [remove_trait]
#        id=$unit.id
#        trait_id=undead
#    [/remove_trait]
#    #War of Legends vampires:
#    [remove_trait]
#        id=$unit.id
#        trait_id=vampire
#    [/remove_trait]
#    #Era of Myth vampires:
#    [remove_trait]
#        id=$unit.id
#        trait_id=undrainable
#    [/remove_trait]

    [object]
        silent=yes
        duration=forever
        id=vampirism_compatibility_removestatuses
        take_only_once=no
        [filter]
            id={ID}
            [not]
                ability=vampirism
            [/not]
        [/filter]
        [effect]
            apply_to=status
            remove=undrainable,unplagueable,unpoisonable
        [/effect]
    [/object]

    #remove old bite attacks to avoid duplication, if setting is enabled

    {IF_VAR vampirism_umc_compatibility_removefangs equals yes (
    [then]
    [object]
        silent=yes
        duration=forever
        id=vampirism_compatibility_remove_old_bites
        take_only_once=no
        [filter]
            id={ID}
            [not]
                ability=vampirism
            [/not]
        [/filter]
        [effect]
            apply_to=remove_attacks
            name=bite,fangs
        [/effect]
    [/object]

    [/then]
    )}

    {IF_VAR vampirism_umc_compatibility_proportional_vampirelevel equals yes (
    [and]
        [have_unit]
            id={ID}
            [not]
                ability=vampirism
            [/not]
        [/have_unit]
    [/and]
    [then]
    [store_unit]
        [filter]
            id={ID}
        [/filter]
        variable=vampirism_compatibility_unit
        kill=no
    [/store_unit]
    {IF_VAR vampirism_compatibility_unit.level equals 2 (
    [then]
        {VARIABLE tmp_vampirism_convert_levelup_times 2}#how many times to level up from 1, not resulting level
    [/then]
    )}
    {IF_VAR vampirism_compatibility_unit.level equals 3 (
    [then]
        {VARIABLE tmp_vampirism_convert_levelup_times 4}
    [/then]
    )}
    {IF_VAR vampirism_compatibility_unit.level equals 4 (
    [then]
        {VARIABLE tmp_vampirism_convert_levelup_times 7}
    [/then]
    )}
    {IF_VAR vampirism_compatibility_unit.level greater_than_equal_to 5 (
    [then]
        {VARIABLE tmp_vampirism_convert_levelup_times 9}
    [/then]
    )}

    {CLEAR_VARIABLE vampirism_compatibility_unit}
    [/then]
    )}
    


    {TURN_INTO_VAMPIRE (
        id={ID}
    )}

    #remove vampire tint for converted vampires, because unlike with formerly-living units, here it's redundant

    [remove_object]
        id={ID}
        object_id=vampire_tint
    [/remove_object]    

    {IF_VAR tmp_vampirism_convert_levelup_times greater_than 0 (
    [then]
        {REPEAT $tmp_vampirism_convert_levelup_times (
            {VARIABLE tmp_vampire_no_xp_loss_on_levelup yes}
            {VAMPIRE_LEVELUP id={ID}}
            {CLEAR_VARIABLE tmp_vampire_no_xp_loss_on_levelup}
        )}
    [/then]
    )}
    {CLEAR_VARIABLE tmp_vampirism_convert_levelup_times}
#enddef


[event]
	name=side turn 1#cannot do a start event due to the AI check, has to be turn 1 of each side
	id=vampirism_start
	first_time_only=no
    {VAMPIRISM_CHECK_IF_CURRENT_SIDE_IS_AI}

    [if]
    {VARIABLE_CONDITIONAL vampirism_start_vampires equals allleaders}
    [or]
    {VARIABLE_CONDITIONAL vampirism_start_vampires equals playerleaders}
    [and]
    {VARIABLE_CONDITIONAL vampirism_is_ai$side_number equals no}
    [/and]
    [/or]
    [then]

    [store_unit]
        [filter]
            side=$side_number
            canrecruit=yes
            [not]
                ability=vampirism
            [/not]
#now checked inside the loop
#            [not]
#                {VAMPIRE_EXCLUDED_FILTER}
#            [/not]
        [/filter]
        variable=vampirism_leader_candidates
        kill=no
    [/store_unit]
    [foreach]
        array=vampirism_leader_candidates
        index_var=i
        [do]
            [if]
            [have_unit]
                id=$this_item.id
                [not]
                    {VAMPIRE_EXCLUDED_FILTER}
                [/not]
            [/have_unit]
            [then]
            {TURN_INTO_VAMPIRE (
                id=$this_item.id
            )}

            #if starting level is higher than 1, level up the vampire leader upon converting

            {REPEAT "$($vampirism_starting_level - 1)" (
                {VARIABLE tmp_vampire_no_xp_loss_on_levelup yes}
                {VAMPIRE_LEVELUP id=$this_item.id}
                {CLEAR_VARIABLE tmp_vampire_no_xp_loss_on_levelup}
            )}
            [/then]
            [else]
            [message]
                speaker=narrator
                caption=_"Vampirism Warning!!!"
                side_for=$side_number
                message=_"Your leader type is incompatible with the Vampirism mod! Undead, other non-living units, and bats (since that wouldn't make sense with Bat Form turning a bat into a bat) cannot be vampires."
            [/message]
            [/else]
            [/if]
        [/do]
    [/foreach]
    {CLEAR_VARIABLE vampirism_leader_candidates}
    [/then]
    [/if]
[/event]

#define VAMPIRISM_UMC_VAMPIRE_FILTER
    race=vampire,EOM_vampire,steppevampire
    #some weaker vampires and half-vampires don't automatically become vampirism-compatible
    [not]
        type=Bloodborn,Malborn,EOM_Bloodborn,EOM_Malborn
        [or]
            type_adv_tree=Thin Blood,EOM_Thin_Blood
        [/or]
    [/not]
#enddef

#prevent potential bugs caused by turning UMC vampires into normal vampires before turn 1 fully starts (maybe some bugs related to prestart/start not having triggered yet?)
[event]
    name=turn 1
    id=vampirism_UMC_compatibility_avoid_instant_vampires
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL vampirism_umc_compatibility equals yes}
    [/filter_condition]
    {VARIABLE vampirism_UMC_can_convert_vampires yes}

    [store_unit]
        [filter]
            {VAMPIRISM_UMC_VAMPIRE_FILTER}
            [not]
                ability=vampirism
            [/not]
        [/filter]
        variable=vampirism_existing_unconverted_vampires
        kill=no
    [/store_unit]
    [foreach]
        array=vampirism_existing_unconverted_vampires
        index_var=v
        variable=this_existing_vampire#to avoid conflict with $this_item inside turn_vampire
        [do]
            {CONVERT_UMC_VAMPIRE_TO_VAMPIRISM_VAMPIRE $this_existing_vampire.id}
        [/do]
    [/foreach]
    {CLEAR_VARIABLE vampirism_existing_unconverted_vampires}
[/event]
[event]
    name=scenario_end
    id=vampirism_UMC_compatibility_avoid_instant_vampires2
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL vampirism_umc_compatibility equals yes}
    [/filter_condition]
    {CLEAR_VARIABLE vampirism_UMC_can_convert_vampires}
[/event]
[event]
    name=unit placed,post advance
    id=vampirism_UMC_compatibility
    first_time_only=no
    [filter]
        {VAMPIRISM_UMC_VAMPIRE_FILTER}
        [not]
            ability=vampirism
        [/not]
    [/filter]
    [filter_condition]
        {VARIABLE_CONDITIONAL vampirism_umc_compatibility equals yes}
        [and]
            {VARIABLE_CONDITIONAL vampirism_UMC_can_convert_vampires equals yes}
        [/and]
    [/filter_condition]
    {CONVERT_UMC_VAMPIRE_TO_VAMPIRISM_VAMPIRE $unit.id}
[/event]

[event]
	name=side turn
	id=vampirism_sunlight_damage
	first_time_only=no
	[store_unit]
		[filter]
			side=$side_number
			ability=vampirism
            [filter_location]
                time_of_day=lawful
                [not]
                	#castles, keeps, and villages provide shelter from the sun
                	terrain=C*^*,K*^*,*^V*
                [/not]
            [/filter_location]
			[not]
				[filter_wml]
					[status]
						petrified=yes
					[/status]
				[/filter_wml]
			[/not]
            #Slumber gives immunity to sunlight damage, and is intentionally a way to avoid sunlight when there's no castles or villages nearby
            [not]
                ability=vampire_slumber
            [/not]
		[/filter]
		variable=burned_vampires
		kill=no
	[/store_unit]
    [foreach]
        array=burned_vampires
        index_var=i
        [do]
        	{VARIABLE tmp_vampire_sun_damage "$(10 + $this_item.variables.vampirism_level| * 5)"}
            #Blood Shield II upgrade reduces sun damage
            [if]
            [have_unit]
                id=$this_item.id
                ability=vampire_sun_resistance
            [/have_unit]
            [then]
            {VARIABLE_OP tmp_vampire_sun_damage multiply $this_item.variables.vampirism_sunlight_resistance_damagemult}
            [/then]
            [/if]

            [if]
            [have_unit]
                id=$this_item.id
                ability=vampire_blood_shield2
            [/have_unit]
            [then]
            {VARIABLE_OP tmp_vampire_sun_damage multiply 0.65}
            [/then]
            [/if]
            {VARIABLE_OP tmp_vampire_sun_damage round floor}
            [animate_unit]
                flag=sunlight_damage
                [filter]
                    id=$this_item.id
                [/filter]
            [/animate_unit] 
            [if]
            {VARIABLE_CONDITIONAL this_item.variables.vampirism_sunlight_resistance_nokill equals yes}
            [then]
            [harm_unit]
                [filter]
                    id=$this_item.id
                [/filter]
                amount=$tmp_vampire_sun_damage
                experience=no
                fire_event=yes
                animate=yes
                kill=no#high Sun Resistance makes it so sunlight damage acts like poison, instead of being able to kill
            [/harm_unit] 
            [/then]
            [else]
			[harm_unit]
				[filter]
					id=$this_item.id
				[/filter]
				amount=$tmp_vampire_sun_damage
				experience=no
				fire_event=yes
				animate=yes
			[/harm_unit] 
            [/else]
            [/if]
        [/do]
    [/foreach]
    {CLEAR_VARIABLE burned_vampires}
    {CLEAR_VARIABLE tmp_vampire_sun_damage}
[/event]


[event]
    name=side turn
    id=vampirism_hunger
    first_time_only=no
    [store_unit]
        [filter]
            side=$side_number
            ability=vampirism
            [filter_location]
                [not]
                    #vampires can feed in villages each turn, so remove the hunger penalty there
                    terrain=*^V*
#rebalanced vampires so they can still feed in villages at day
#                    [not]
#                        #vampires cannot feed in villages at day because of sunlight, so they will still go hungry in a village, but at least they can hide from the sun. This is to encourage the Day Sleep mechanic to conserve blood instead of being able to just farm villages for blood at daytime
#                        time_of_day=lawful
#                    [/not]
                [/not]
            [/filter_location]
            #while in Slumber, you do not lose Blood points each turn
            [not]
                ability=vampire_slumber
            [/not]
            [not]
                [filter_wml]
                    [status]
                        petrified=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter]
        variable=hungry_vampires
        kill=no
    [/store_unit]
    [foreach]
        array=hungry_vampires
        index_var=i
        [do]
            {IF_VAR this_item.variables.vampirism_blood equals 0 (
            [then]
                {VARIABLE tmp_vampire_hunger_damage yes}
            [/then]
            )}

            {VARIABLE_OP this_item.variables.vampirism_blood sub $this_item.variables.vampirism_hunger_rate}
            {IF_VAR this_item.variables.vampirism_blood less_than 0 (
            [then]
                {VARIABLE this_item.variables.vampirism_blood 0}
            [/then]
            )}
            [unstore_unit]
                variable=this_item
                find_vacant=no
            [/unstore_unit]
            {VAMPIRE_CHECK_HUNGER this_item}

            {IF_VAR tmp_vampire_hunger_damage equals yes (
            [then]
                [harm_unit]
                    [filter]
                        id=$this_item.id
                    [/filter]
                    amount="$(3 + $this_item.variables.vampirism_hunger_rate * 3)"
                    fire_event=yes
                    animate=yes
                    experience=no
                    kill=no
                [/harm_unit]
            [/then]
            )}
            {CLEAR_VARIABLE tmp_vampire_hunger_damage}
        [/do]
    [/foreach]
    {CLEAR_VARIABLE hungry_vampires}
[/event]

[event]
    name=side turn
    id=vampirism_feeding
    first_time_only=no
    [store_unit]
        [filter]
            side=$side_number
            ability=vampirism
            [not]
                [filter_wml]
                    [status]
                        petrified=yes
                    [/status]
                [/filter_wml]
            [/not]
            #while in Slumber, you cannot feed on villages
            [not]
                ability=vampire_slumber
            [/not]
            [and]
                [filter_location]
                    terrain=*^V*
                    #now vampires CAN feed during daytime, but simply get half as much blood (this is to make design more intuitive and further reinforce the "put vampire in a village at day" design.)
                    #[not]
                    #    #vampires cannot feed in villages at day because of sunlight
                    #    time_of_day=lawful
                    #[/not]
                [/filter_location]
                [or]
                    #if you have the Drain Minions upgrade, you can gain Blood by standing in a crowd of your units, instead of standing in a village
                    ability=vampirism_drain_minions
                    [filter_adjacent]
                        side=$side_number
                        count=3-6
                        [not]
                            status=undrainable
                        [/not]                        
                        [not]
                            ability=vampirism
                        [/not]
                    [/filter_adjacent]
                [/or]
            [/and]
        [/filter]
        variable=feeding_vampires
        kill=no
    [/store_unit]
    [foreach]
        array=feeding_vampires
        index_var=i
        [do]
            [sound]
                name=bite.ogg
            [/sound]
            [if]
            [have_location]
                x,y=$this_item.x,$this_item.y
                terrain=*^V*
                #sunlight makes it harder for vampires to hunt mortals to feed on, so blood gain is halved
                time_of_day=lawful
            [/have_location]
            #Daywalker upgrade removes the daylight penalty from drinking blood from villages
            [not]
            [have_unit]
                id=$this_item.id
                ability=vampire_daywalker
            [/have_unit]
            [/not]
            [then]
            {VAMPIRISM_GAIN_BLOOD id=$this_item.id "$($this_item.variables.vampirism_blood_from_village / 2 )"}
            {VAMPIRISM_GAIN_BLOOD_FLOATTEXT_AND_XP this_item $this_item.x $this_item.y "$($this_item.variables.vampirism_blood_from_village / 2)"}
            [/then]
            [else]
            {VAMPIRISM_GAIN_BLOOD id=$this_item.id $this_item.variables.vampirism_blood_from_village}
            {VAMPIRISM_GAIN_BLOOD_FLOATTEXT_AND_XP this_item $this_item.x $this_item.y $this_item.variables.vampirism_blood_from_village}
            [/else]
            [/if]
        [/do]
    [/foreach]
    {CLEAR_VARIABLE hungry_vampires}
[/event]
[event]
    name=attacker_hits
    id=vampirism_blood_drain
    first_time_only=no
    [filter_attack]
        special_id=drains
    [/filter_attack]
    [filter]
        ability=vampirism
    [/filter]
    [filter_second]
        [not]
            status=undrainable
        [/not]
    [/filter_second]
    {VARIABLE tmp_blood_drained $damage_inflicted}
    #COMMENTED OUT FOR NOW, THE "100% blood drain if at full hp" mechanic MIGHT COMPLICATE BALANCING THE MOD, THINK LATER ABOUT WHETHER TO RE-ADD IT
    ##if vampire is at full HP, all drained HP is converted to blood, otherwise it's half drain healing, half blood
    #{IF_VAR unit.hitpoints less_than unit.max_hitpoints (
    #[then]
        {VARIABLE_OP tmp_blood_drained divide 2}
    #[/then]
    #)}
    {VARIABLE_OP tmp_blood_drained round floor}
    {VAMPIRISM_GAIN_BLOOD id=$unit.id $tmp_blood_drained}
    {VAMPIRISM_GAIN_BLOOD_FLOATTEXT_AND_XP unit $unit.x $unit.y $tmp_blood_drained}
    {CLEAR_VARIABLE tmp_blood_drained}
[/event]

[event]
    name=defender_hits
    id=vampirism_blood_drain2
    first_time_only=no
    [filter_second_attack]
        special_id=drains
    [/filter_second_attack]
    [filter_second]
        ability=vampirism
    [/filter_second]
    [filter]
        [not]
            status=undrainable
        [/not]
    [/filter]
    {VARIABLE tmp_blood_drained $damage_inflicted}
    #COMMENTED OUT FOR NOW, THE "100% blood drain if at full hp" mechanic MIGHT COMPLICATE BALANCING THE MOD, THINK LATER ABOUT WHETHER TO RE-ADD IT
    ##if vampire is at full HP, all drained HP is converted to blood, otherwise it's half drain healing, half blood
    #{IF_VAR unit.hitpoints less_than unit.max_hitpoints (
    #[then]
        {VARIABLE_OP tmp_blood_drained divide 2}
    #[/then]
    #)}
    {VARIABLE_OP tmp_blood_drained round floor}
    {VAMPIRISM_GAIN_BLOOD id=$second_unit.id $tmp_blood_drained}
    {VAMPIRISM_GAIN_BLOOD_FLOATTEXT_AND_XP second_unit $second_unit.x $second_unit.y $tmp_blood_drained}
    {CLEAR_VARIABLE tmp_blood_drained}
[/event]


[event]
    name=attacker_hits
    id=vampirism_blood_drain_bloodreaper
    first_time_only=no
    [filter_attack]
        [not]
            special_id=drains
        [/not]
    [/filter_attack]
    [filter]
        ability=vampirism
        [and]
            ability=vampirism_blood_reaper
        [/and]
    [/filter]
    [filter_second]
        [not]
            status=undrainable
        [/not]
    [/filter_second]
    {VARIABLE tmp_blood_drained $damage_inflicted}

    {VARIABLE_OP tmp_blood_drained divide 4}

    {VARIABLE_OP tmp_blood_drained round floor}
    {VAMPIRISM_GAIN_BLOOD id=$unit.id $tmp_blood_drained}
    {VAMPIRISM_GAIN_BLOOD_FLOATTEXT_AND_XP unit $unit.x $unit.y $tmp_blood_drained}
    {CLEAR_VARIABLE tmp_blood_drained}
[/event]

[event]
    name=defender_hits
    id=vampirism_blood_drain_bloodreaper2
    first_time_only=no
    [filter_second_attack]
        [not]
            special_id=drains
        [/not]
    [/filter_second_attack]
    [filter_second]
        ability=vampirism
        [and]
            ability=vampirism_blood_reaper
        [/and]
    [/filter_second]
    [filter]
        [not]
            status=undrainable
        [/not]
    [/filter]
    {VARIABLE tmp_blood_drained $damage_inflicted}

    {VARIABLE_OP tmp_blood_drained divide 4}

    {VARIABLE_OP tmp_blood_drained round floor}
    {VAMPIRISM_GAIN_BLOOD id=$second_unit.id $tmp_blood_drained}
    {VAMPIRISM_GAIN_BLOOD_FLOATTEXT_AND_XP second_unit $second_unit.x $second_unit.y $tmp_blood_drained}
    {CLEAR_VARIABLE tmp_blood_drained}
[/event]



#vampires get some vampire XP when killing anything, similar to the normal "8 xp per level" from normal kills

[event]
    name=die
    id=vampirism_kill_xp_nondrain
    first_time_only=no
    [filter_second]
        ability=vampirism
    [/filter_second]

    {IF_VAR unit.level equals 0 (
    [then]
    [modify_unit]
        [filter]
            id=$second_unit.id
        [/filter]
        {VARIABLE_OP vampirism_xp add 4}
        {VARIABLE vampirism_xp_recently_modified yes}#needed for levelups
    [/modify_unit]
    #Thrill of Battle upgrade gives a 50% bonus to normal vampire kill xp
    [modify_unit]
        [filter]
            id=$second_unit.id
            ability=vampirism_thrill_of_battle
        [/filter]
        {VARIABLE_OP vampirism_xp add 2}
        {VARIABLE vampirism_xp_recently_modified yes}#needed for levelups
    [/modify_unit]
    [/then]
    [else]
    [modify_unit]
        [filter]
            id=$second_unit.id
        [/filter]
        {VARIABLE_OP vampirism_xp add "$($unit.level| * 8)"}
        {VARIABLE vampirism_xp_recently_modified yes}#needed for levelups
    [/modify_unit]
    #Thrill of Battle upgrade gives a 50% bonus to normal vampire kill xp
    [modify_unit]
        [filter]
            id=$second_unit.id
            ability=vampirism_thrill_of_battle
        [/filter]
        {VARIABLE_OP vampirism_xp add "$($unit.level| * 4)"}
        {VARIABLE vampirism_xp_recently_modified yes}#needed for levelups
    [/modify_unit]
    {VAMPIRE_CHECK_XP_OF_ALL_VAMPIRES_FOR_LEVELUP}

    [/else]
    )}
[/event]

#if a vampire kills a living enemy while using a draining attack, they gain additional vampire XP on top of the guaranteed vampire XP

#killing without drain gives half the normal kill XP worth of vampire XP, killing with drain gives 1.5x the normal XP worth of vampire XP

[event]
    name=die
    id=vampirism_kill_xp_drain
    first_time_only=no
    [filter_second_attack]
        special_id=drains
    [/filter_second_attack]
    [filter_second]
        ability=vampirism
    [/filter_second]
    [filter]
        [not]
            status=undrainable
        [/not]
    [/filter]

    {IF_VAR unit.level equals 0 (
    [then]
    [modify_unit]
        [filter]
            id=$second_unit.id
        [/filter]
        {VARIABLE_OP vampirism_xp add 2}
        {VARIABLE vampirism_xp_recently_modified yes}#needed for levelups
    [/modify_unit]
    [/then]
    [else]
    [modify_unit]
        [filter]
            id=$second_unit.id
        [/filter]
        {VARIABLE_OP vampirism_xp add "$($unit.level| * 4)"}
        {VARIABLE vampirism_xp_recently_modified yes}#needed for levelups
    [/modify_unit]
    [/else]
    )}

    {VAMPIRE_CHECK_XP_OF_ALL_VAMPIRES_FOR_LEVELUP}
[/event]
#draining an enemy leader while having the Refined Taste upgrade gives bonux Vampire XP and Max Blood
[event]
#due to some weirdness with events, having the event on name=die meant the effect did not trigger when killing the LAST enemy leader in a scenario and victory triggered
#    name=die
    name=last breath
    id=vampirism_refined_taste
    priority=10#happens earlier than normal last breath events, to ensure it triggers BEFORE any "victory by killing a leader" events
    first_time_only=no
    [filter_second_attack]
        special_id=drains
    [/filter_second_attack]
    [filter_second]
        ability=vampirism
        [and]
            ability=vampirism_refined_taste
        [/and]
    [/filter_second]
    [filter]
        canrecruit=yes
        [not]
            status=undrainable
        [/not]
    [/filter]

    [modify_unit]
        [filter]
            id=$second_unit.id
        [/filter]
        {VARIABLE_OP vampirism_xp add "$($unit.level| * 24)"}
        {VARIABLE_OP vampirism_max_blood add 2}
        {VARIABLE vampirism_xp_recently_modified yes}#needed for levelups
    [/modify_unit]
    {VAMPIRE_CHECK_XP_OF_ALL_VAMPIRES_FOR_LEVELUP}
[/event]

[event]
    #using turn refresh since that adds one more turn worth of healing
    name=turn refresh#side turn
    id=vampirism_slumber_time
    first_time_only=no
    [store_unit]
        [filter]
            side=$side_number
            ability=vampire_slumber
            [not]
                [filter_wml]
                    [status]
                        petrified=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter]
        variable=sleeping_vampires
        kill=no
    [/store_unit]
    [foreach]
        array=sleeping_vampires
        index_var=i
        [do]
            {VARIABLE_OP this_item.variables.vampirism_slumber_turns_left sub 1}
            [unstore_unit]
                variable=this_item
                find_vacant=no
            [/unstore_unit]
            {IF_VAR this_item.variables.vampirism_slumber_turns_left less_than_equal_to 0 (
            [then]
                [remove_object]
                    id=$this_item.id
                    object_id=vampire_slumber
                [/remove_object]
                [modify_unit]
                    [filter]
                        id=$this_item.id
                    [/filter]
                    moves=full
                [/modify_unit]
            [/then]
            )}
        [/do]
    [/foreach]
    {CLEAR_VARIABLE sleeping_vampires}
[/event]

[event]
    name=preload
    id=vampire_preload_UI
    first_time_only=no
    [lua]
       code = << wesnoth.require "~add-ons/Vampirism/lua/vampirism_lua_functions.lua"

       vampirism_attach_unit_status_renderer()

       >>
    [/lua]
[/event]

[event]
    name=prestart
    id=vampirism_define_xp_modifier
    first_time_only=no
    {VARIABLE vampirism_xp_modifier_mult $vampirism_xp_modifier}
    {VARIABLE_OP vampirism_xp_modifier_mult divide 100}
[/event]

#define VAMPIRISM_MICRO_AIS SIDE
[store_side]
side={SIDE}
variable=vampirism_ai_currentside
[/store_side]

[if]
#checks if the side exists
{VARIABLE_CONDITIONAL vampirism_ai_currentside.side not_equals $vampirism_nonexistent_variable}
#[have_unit]
#    side={SIDE}
#removed, as it does not work in multiplayer with ai sides
#    [filter_side]
#        controller=ai
#    [/filter_side]
#[/have_unit]
[then]
    [micro_ai]
        side={SIDE}
        ai_type=coward
        action=add
        [filter]
            ability=vampirism_terrified
            [filter_location]
                [filter]
                    [filter_side]
                        [enemy_of]
                            side={SIDE}
                        [/enemy_of]
                    [/filter_side]
                [/filter]
                radius=10#radius for standing in place
#TODO: maybe add a wall filter here later?
#                [filter_radius]
#                    terrain=!,{SPARTAN_WALL_TERRAIN}
#                [/filter_radius]
            [/filter_location]
        [/filter]
        attack_if_trapped=no#do not try to attack when attacks left are equal to 0
        distance=5
        ca_score=170000#set below 200k so that this is triggered after goto_x/goto_y
    [/micro_ai]
[/then]
[/if]
{CLEAR_VARIABLE vampirism_ai_currentside}
#enddef

[event]
    name=prestart
    id=vampirism_define_micro_ais
    first_time_only=no
    {VAMPIRISM_MICRO_AIS 1}
    {VAMPIRISM_MICRO_AIS 2}
    {VAMPIRISM_MICRO_AIS 3}
    {VAMPIRISM_MICRO_AIS 4}
    {VAMPIRISM_MICRO_AIS 5}
    {VAMPIRISM_MICRO_AIS 6}
    {VAMPIRISM_MICRO_AIS 7}
    {VAMPIRISM_MICRO_AIS 8}
    {VAMPIRISM_MICRO_AIS 9}
[/event]


[event]
    name=side turn
    id=vampire_drain_aura
    first_time_only=no
    [store_unit]
        [filter]
            side=$side_number
            ability=vampire_drainaura
        [not]
        [filter_wml]
        [status]
            petrified=yes
        [/status]
        [/filter_wml]
        [/not]
        [/filter]
        variable=lifestealer
        kill=no
    [/store_unit]
    [foreach]
        array=lifestealer
        index_var=i
        [do]
    [store_unit]
        [filter]
            [filter_adjacent]
                x,y=$this_item.x,$this_item.y
            [/filter_adjacent]
            [filter_side]
                [enemy_of]
                    side=$side_number
                [/enemy_of]
            [/filter_side]
            [not]
            [filter_wml]
            [status]
                petrified=yes
            [/status]
            [or]
            [status]
                undrainable=yes
            [/status]
            [/or]
            [/filter_wml]
            [/not]
        [/filter]
        variable=lifesteal_target
        kill=no
    [/store_unit]

    {VARIABLE tmp_lifesteal_heal 0}

    [foreach]
        array=lifesteal_target
        variable=this_item_target#to avoid overlap with main loop
        index_var=i
        [do]
#since the array number is offset by one from the length (if there are 2 units, the length is 2, but the units are [0] and [1])

    [animate_unit]
        flag=drain_anim
        [filter]
            id=$this_item.id
        [/filter]
        [facing]
            x,y=$this_item_target.x,$this_item_target.y
        [/facing]
        hits=yes
    [/animate_unit]
#    [chat]
#        message=_"target: $lifesteal_target[$random].id, facing: $this_item.facing, random $random, length: $lifesteal_target.length"
#    [/chat]
    [harm_unit]
        [filter]
            id=$this_item_target.id
        [/filter]
        [filter_second]
            id=$this_item.id
        [/filter_second]
        amount=$this_item.variables.vampirism_level
#        alignment=$this_item.alignment
#        damage_type=fire
        fire_event=yes
        animate=yes
        experience=no
        kill=no
    [/harm_unit]
    {VARIABLE_OP tmp_lifesteal_heal add $this_item.variables.vampirism_level}

    [/do]
    [/foreach]

    #half the drained HP is given as healing, half is given as Blood

    {VARIABLE_OP tmp_lifesteal_heal multiply 0.5}
    {VARIABLE_OP tmp_lifesteal_heal round floor}

        [heal_unit]
            [filter]
                id=$this_item.id
            [/filter]
            amount=$tmp_lifesteal_heal
            animate=yes
            restore_statuses=no
        [/heal_unit]

    [delay]
        time=100
    [/delay]

    {VAMPIRISM_GAIN_BLOOD id=$this_item.id $tmp_lifesteal_heal}
    {VAMPIRISM_GAIN_BLOOD_FLOATTEXT_AND_XP this_item $this_item.x $this_item.y $tmp_lifesteal_heal}

    [/do]
    [/foreach]

    {CLEAR_VARIABLE lifestealer}
    {CLEAR_VARIABLE lifesteal_target}
    {CLEAR_VARIABLE tmp_lifesteal_heal}
[/event]

[event]
    name=turn refresh
    id=vampirism_mentor
    first_time_only=no
#    [chat]
#        message=_"mentor event begin regardless of filters"
#    [/chat]
    [store_unit]
        [filter]
            side=$side_number
            [not]
                [filter_wml]
                    [status]
                        petrified=yes
                    [/status]
                [/filter_wml]
            [/not]
            [filter_adjacent]
                ability=vampirism_mentor_dummy
                [filter_side]
                    [allied_with]
                        side=$side_number
                    [/allied_with]
                [/filter_side]
            [/filter_adjacent]
        [/filter]
        variable=vampirism_taught_units
        kill=no
    [/store_unit]
    [foreach]
        array=vampirism_taught_units
        index_var=i
        [do]
#        [chat]
#            message=_"mentor event trying to teach $this_item.id|"
#        [/chat]

            #this is more convenient than messing with if/else statements for the different possibilities
            {VARIABLE vampirism_xp_popup_message ""}

#vampire_mentor1
            [if]
            [have_unit]
                id=$this_item.id
                ability=vampirism
                [filter_adjacent]
                    ability=vampirism_mentor1
                    formula="self.wml_vars.vampirism_level > $this_item.variables.vampirism_level|"
                    [filter_side]
                        [allied_with]
                            side=$side_number
                        [/allied_with]
                    [/filter_side]
                [/filter_adjacent]
            [/have_unit]
            [then]
                {VARIABLE tmp_vampire_mentor_vamp_xp 4}
            [/then]
            [/if]
            [if]
            [have_unit]
                id=$this_item.id
                ability=vampirism
                [filter_adjacent]
                    ability=vampirism_mentor2
                    formula="self.wml_vars.vampirism_level > $this_item.variables.vampirism_level|"
                    [filter_side]
                        [allied_with]
                            side=$side_number
                        [/allied_with]
                    [/filter_side]
                [/filter_adjacent]
            [/have_unit]
            [then]
                {VARIABLE tmp_vampire_mentor_vamp_xp 6}
            [/then]
            [/if]
            [if]
            [have_unit]
                id=$this_item.id
                ability=vampirism
                [filter_adjacent]
                    ability=vampirism_mentor3
                    formula="self.wml_vars.vampirism_level > $this_item.variables.vampirism_level|"
                    [filter_side]
                        [allied_with]
                            side=$side_number
                        [/allied_with]
                    [/filter_side]
                [/filter_adjacent]
            [/have_unit]
            [then]
                {VARIABLE tmp_vampire_mentor_vamp_xp 9}
            [/then]
            [/if]


#teaching non-vampires
            [if]
            [have_unit]
                id=$this_item.id
                [filter_adjacent]
                    ability=vampirism_mentor2
                    formula="self.level > $this_item.level|"
                    [filter_side]
                        [allied_with]
                            side=$side_number
                        [/allied_with]
                    [/filter_side]
                [/filter_adjacent]
            [/have_unit]
            [then]
                {VARIABLE tmp_vampire_mentor_normal_xp 2}
            [/then]
            [/if]
            [if]
            [have_unit]
                id=$this_item.id
                [filter_adjacent]
                    ability=vampirism_mentor3
                    formula="self.level > $this_item.level|"
                    [filter_side]
                        [allied_with]
                            side=$side_number
                        [/allied_with]
                    [/filter_side]
                [/filter_adjacent]
            [/have_unit]
            [then]
                {VARIABLE tmp_vampire_mentor_normal_xp 3}
            [/then]
            [/if]

#        [chat]
#            message=_"mentor xp value $tmp_vampire_mentor_vamp_xp|"
#        [/chat]
            [if]
            {VARIABLE_CONDITIONAL tmp_vampire_mentor_vamp_xp greater_than 0}
            [then]
            {VARIABLE vampirism_xp_popup_message _"$vampirism_xp_popup_message|$tmp_vampire_mentor_vamp_xp| vamp xp "}

#        [chat]
#            message=_"mentor event found valid teacher"
#        [/chat]

            #gain a bit of vampire xp
            [modify_unit]
                [filter]
                    id=$this_item.id
                [/filter]
                {VARIABLE_OP vampirism_xp add $tmp_vampire_mentor_vamp_xp}
                {VARIABLE vampirism_xp_recently_modified yes}#needed for levelups
            [/modify_unit]
            [/then]
            [/if]
            [if]
            {VARIABLE_CONDITIONAL tmp_vampire_mentor_normal_xp greater_than 0}
            [then]
            {VARIABLE vampirism_xp_popup_message _"$vampirism_xp_popup_message|$tmp_vampire_mentor_normal_xp| xp"}

#        [chat]
#            message=_"mentor event found valid teacher"
#        [/chat]

            #gain a bit of normal xp
            [modify_unit]
                [filter]
                    id=$this_item.id
                [/filter]
                experience="$($this_item.experience| + $tmp_vampire_mentor_normal_xp|)"
            [/modify_unit]

            [/then]
            [/if]
            [floating_text]
               x,y=$this_item.x,$this_item.y
               text=$vampirism_xp_popup_message|
            [/floating_text]

            {CLEAR_VARIABLE tmp_vampire_mentor_vamp_xp}
            {CLEAR_VARIABLE tmp_vampire_mentor_normal_xp}
        [/do]
    [/foreach]
    #doing this AFTER the main foreach instead of every time inside the loop, so the code is more effii
    {VAMPIRE_CHECK_XP_OF_ALL_VAMPIRES_FOR_LEVELUP}

    {CLEAR_VARIABLE vampirism_taught_units}
[/event]