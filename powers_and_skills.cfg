#textdomain wesnoth-vampirism

#define VAMPIRE_SPEND_BLOOD_ON_POWER AMOUNT SUCCESS_CODE
{IF_VAR this_vampire.variables.vampirism_blood greater_than_equal_to {AMOUNT} (
[then]
    {SUCCESS_CODE}
    [modify_unit]
        [filter]
            id=$this_vampire.id
        [/filter]
        {VARIABLE_OP vampirism_blood sub {AMOUNT}}
        #gain a bit of vampire xp by using vampire powers
        {VARIABLE_OP vampirism_xp add "$({AMOUNT} * 0.3)"}
        {VARIABLE vampirism_xp_recently_modified yes}#needed for levelups
    [/modify_unit]
    {VAMPIRE_CHECK_HUNGER this_vampire}
    #{VAMPIRE_CHECK_XP_FOR_LEVELUP this_vampire}
    {VAMPIRE_CHECK_XP_OF_ALL_VAMPIRES_FOR_LEVELUP}
[/then]
[else]
            [message]
                speaker=narrator
                caption=_"Vampirism Menu"
#TODO: find something else that fits
#                image="portraits/undead/draug.webp"
                side_for=$side_number
                message=_"Not enough blood for this power!"
            [/message]
[/else]
)}
#enddef

#macro to simplify and standardize [show_if] conditionals for the powers menu
#define IF_VAMPIRE_UPGRADE_UNLOCKED UPGRADE
    {VARIABLE_CONDITIONAL this_vampire.variables.vampire_upgrade_{UPGRADE}_unlocked equals yes}
#enddef

#define VAMPIRE_TRUE_DEBUG_CHECK
    [lua]
        code=<<

        if wesnoth.game_config.debug == true then
            return true;
        end

        if wesnoth.game_config.mp_debug == true then
            return true;
        end

            return false;

        >>
    [/lua]
#enddef

#macro for Powers that have an additional condition besides just having the upgrade unlocked and having enough blood (for example, Blood Heal is not usable at full hp, Great Feast is only usable in villages, etc.)

#define UPGRADE_POWER_MENU_CONDITIONALLY_GREYED UPGRADE_ID ICON NAME DESCR CONDITION CONDITION_NOT_MET_TEXT CODE
    [option]
        image={ICON}
        description="<span color='#ffff99'>"{NAME}+_"</span>: "+{DESCR}
        [show_if]
            {IF_VAMPIRE_UPGRADE_UNLOCKED {UPGRADE_ID}}
            [and]
                {CONDITION}
            [/and]
            [and]
                #structured in a way so it's possible to create "Can use power X in slumber or batform" while having some powers immediately be usable in batform/slumber by assigning the variable inside the upgrade [switch]
                {VARIABLE_CONDITIONAL this_vampire.variables.vampirism_can_use_power_in_slumber_{UPGRADE_ID} equals yes}
                [or]
                    [have_unit]
                        id=$this_vampire.id
                        [not]
                            ability=vampire_slumber
                        [/not]
                    [/have_unit]
                [/or]
            [/and]
            [and]
                #structured in a way so it's possible to create "Can use power X in slumber or batform" while having some powers immediately be usable in batform/slumber by assigning the variable inside the upgrade [switch]
                {VARIABLE_CONDITIONAL this_vampire.variables.vampirism_can_use_power_in_batform_{UPGRADE_ID} equals yes}
                [or]
                    [have_unit]
                        id=$this_vampire.id
                        [not]
                            ability=vampire_batform
                        [/not]
                    [/have_unit]
                [/or]
            [/and]
        [/show_if]
        [command]
            {CODE}
        [/command]
    [/option]
    [option]
        image={ICON}+"~GS()"
        description="<span color='#999999'>"{NAME}+_"</span>: "+{DESCR}+"
<span color='#ff9999'>"+{CONDITION_NOT_MET_TEXT}+"</span>"
        [show_if]
            {IF_VAMPIRE_UPGRADE_UNLOCKED {UPGRADE_ID}}
            [and]
                [not]
                    {CONDITION}
                [/not]
            [/and]
            [and]
                #structured in a way so it's possible to create "Can use power X in slumber or batform" while having some powers immediately be usable in batform/slumber by assigning the variable inside the upgrade [switch]
                {VARIABLE_CONDITIONAL this_vampire.variables.vampirism_can_use_power_in_slumber_{UPGRADE_ID} equals yes}
                [or]
                    [have_unit]
                        id=$this_vampire.id
                        [not]
                            ability=vampire_slumber
                        [/not]
                    [/have_unit]
                [/or]
            [/and]
            [and]
                #structured in a way so it's possible to create "Can use power X in slumber or batform" while having some powers immediately be usable in batform/slumber by assigning the variable inside the upgrade [switch]
                {VARIABLE_CONDITIONAL this_vampire.variables.vampirism_can_use_power_in_batform_{UPGRADE_ID} equals yes}
                [or]
                    [have_unit]
                        id=$this_vampire.id
                        [not]
                            ability=vampire_batform
                        [/not]
                    [/have_unit]
                [/or]
            [/and]
        [/show_if]
        [command]
        [/command]
    [/option]
    [option]
        image={ICON}+"~GS()"
        description="<span color='#999999'>"{NAME}+_"</span>: "+{DESCR}+"
<span color='#ff9999'>this power is not usable in bat form!</span>"
        [show_if]
            {IF_VAMPIRE_UPGRADE_UNLOCKED {UPGRADE_ID}}
            #main condition is irrelevant here, and keeping such a filter causes bugs by incorrectly hiding options
            #[and]
            #    [not]
            #        {CONDITION}
            #    [/not]
            #[/and]
            [and]
                [have_unit]
                    id=$this_vampire.id
                    ability=vampire_batform
                [/have_unit]
            [/and]
            [not]
                #structured in a way so it's possible to create "Can use power X in slumber or batform" while having some powers immediately be usable in batform/slumber by assigning the variable inside the upgrade [switch]
                {VARIABLE_CONDITIONAL this_vampire.variables.vampirism_can_use_power_in_batform_{UPGRADE_ID} equals yes}
            [/not]
        [/show_if]
        [command]
        [/command]
    [/option]    
#enddef

#macro for making sure the power condition in the [and] is technically not empty but always true (so there's no extra conditions, only slumber/batform ones)
#define VAMP_POWER_NOCONDITION
    {VARIABLE_CONDITIONAL vampire_nonexistent_var equals $vampire_nonexistent_var}
#enddef


#define VAMPIRISM_TARGET_SELECTION_SUBMENU TEXT SUFFIX_TEXT FILTER UNITVAR CODE
    [store_unit]
        [filter]
            {FILTER}
        [/filter]
        variable=tmp_vampirism_power_targets
        kill=no
    [/store_unit]
    [foreach]
        array=tmp_vampirism_power_targets
        index_var=i
        [do]
            {VARIABLE tmp_shown_target_name $this_item.name|}
            #for nameless units, like undead, show their type name instead of unit name in the selection menu
            {IF_VAR tmp_shown_target_name equals "" (
            [then]
                [store_unit_type]
                    type=$this_item.type
                    variable=tmp_target_type
                [/store_unit_type]
                {VARIABLE tmp_shown_target_name $tmp_target_type.name|}
            [/then]
            )}
            [set_variables]
                name=vampirism_power_target_options
                mode=append
                [value]
                    image="$this_item.image|~TC($this_item.side|, magenta)"
                    description="$tmp_shown_target_name|: $this_item.x|,$this_item.y|"+{SUFFIX_TEXT}
                    [command]
                        {VARIABLE tmp_power_target_id $this_item.id|}
                        {VARIABLE tmp_power_target_x $this_item.x|}
                        {VARIABLE tmp_power_target_y $this_item.y|}
                    [/command]
                [/value]
            [/set_variables]
            {CLEAR_VARIABLE tmp_shown_target_name}
            {CLEAR_VARIABLE tmp_target_type}
        [/do]
    [/foreach]
    [message]
        speaker=narrator
        caption=_"Select Target"
        message={TEXT}
        [option]
            image="attacks/blank-attack.png"
            description=_"Return to menu"
            [command]
                {CLEAR_VARIABLE tmp_power_target_id}
                {CLEAR_VARIABLE tmp_power_target_x}
                {CLEAR_VARIABLE tmp_power_target_y}
            [/command]
        [/option]
        [insert_tag]
            name=option
            variable=vampirism_power_target_options
        [/insert_tag]
    [/message]

    {IF_VAR tmp_power_target_id not_equals $vampire_emptyvar (
    [then]
#    [chat]
#        message=_"power target id $tmp_power_target_id|"
#    [/chat]
    {CODE}
    [/then]
    )}

    {CLEAR_VARIABLE tmp_power_target_id}
    {CLEAR_VARIABLE tmp_power_target_x}
    {CLEAR_VARIABLE tmp_power_target_y}


    {CLEAR_VARIABLE vampirism_power_target_options}
    {CLEAR_VARIABLE tmp_vampirism_power_targets}
#enddef


[event]
    name=start
    id=vampirism_menu
    first_time_only=no

        [set_menu_item]
            id=vampirism_mod_menu
            description= _ "Vampirism Menu"
            image="attacks/curse.png~SCALE(20,20)"
            [show_if]
                [have_unit]
                    x,y=$x1,$y1
                    side=$side_number
                    ability=vampirism
                [/have_unit]
            [/show_if]
            [command]
            {VARIABLE vampirism_menu_active yes}
            [while]
                [variable]
                    name=vampirism_menu_active
                    equals=yes
                [/variable]
                [do]
            #this_vampire variable is repeatedly cleared and stored again so that blood/upgrade values stay up-to-date
            {CLEAR_VARIABLE this_vampire}
            [store_unit]
                [filter]
                    x,y=$x1,$y1
                [/filter]
                variable=this_vampire
                kill=no
            [/store_unit]

            [message]
                speaker=narrator
                caption=_"Vampirism Menu"
#TODO: find something else that fits
#                image="portraits/undead/draug.webp"
                side_for=$side_number
                message=_"Current stats:

Blood: <span color='#ff0000'>$this_vampire.variables.vampirism_blood|/$this_vampire.variables.vampirism_max_blood|</span>
Vampire level: <span color='#ff0000'>$this_vampire.variables.vampirism_level|</span>
Vampire XP: <span color='#ff0000'>$this_vampire.variables.vampirism_xp|/$this_vampire.variables.vampirism_max_xp|</span>
Vampire skill points: <span color='#ff0000'>$this_vampire.variables.vampirism_skillpoints|</span>"
                [option]
                    image="attacks/blank-attack.png"
                    description=_"Return to game"
                    [command]
                        {CLEAR_VARIABLE vampirism_menu_active}
                    [/command]
                [/option]
                [option]
                    image="icons/book2.png"
                    description=_"Information (guide, current upgrades, etc.)"
                    [command]
                        {VAMPIRISM_INFO_SUBMENU}
                    [/command]
                [/option]
                [option]
                    image="attacks/fist.png"
                    description=_"Choose vampire upgrades"
                    [command]
                        {VAMPIRISM_UPGRADE_SUBMENU}
                    [/command]
                [/option]
                [option]
                    image="icons/horror-redalt-2.png"
                    description=_"Debug Menu"
                    [show_if]
                        {VAMPIRE_TRUE_DEBUG_CHECK}
                    [/show_if]
                    [command]
                        {VAMPIRISM_DEBUG_SUBMENU}
                    [/command]
                [/option]
                [option]
                    image="icons/rest.png"
                    description=_"Slumber: for the next 2 turns: 
-you are immune to sunlight damage and don't lose blood each turn
-you regenerate HP every turn equal to 8, plus 2 times your vampire level (max 28)
but
-you are unable to move, attack, feed, or use most of your powers
-slumber can be ended early at the cost of 5 blood points, but you wake up Slowed."
                    [show_if]
                        [have_unit]
                            id=$this_vampire.id
                            [not]
                                ability=vampire_slumber
                            [/not]
                        [/have_unit]
                    [/show_if]
                    [command]
                        [sound]
                            name=magic-dark-big.ogg
                        [/sound]
                        [object]
                            silent=yes
                            #has to be manually turned off or the timer runs out
                            duration=scenario
                            id=vampire_slumber
                            take_only_once=no
                            [filter]
                                id=$this_vampire.id
                            [/filter]
                            [effect]
                                apply_to=image_mod
                                add="~ROTATE(-90)"#to imitate "vampire lying down"
                            [/effect]
                            #make a slumbering vampire unable to move, retaliate, and have his defense be reduced by 30%, making them easy prey to enemies if not guarded
                            [effect]
                                apply_to=movement
                                set=0
                            [/effect]
                            [effect]
                                apply_to=defense
                                replace=no
                                [defense]
                                  deep_water=30
                                  shallow_water=30
                                  swamp_water=30
                                  reef=30
                                  flat=30
                                  sand=30
                                  forest=30
                                  hills=30
                                  mountains=30
                                  village=30
                                  castle=30
                                  cave=30
                                  frozen=30
                                  unwalkable=30
                                  fungus=30
                                [/defense]
                            [/effect]
                            #temporarily hugely increase movement costs to avoid edge cases where a vampire gains movement points while asleep and becomes able to move
                            [effect]
                                apply_to=movement_costs
                                replace=no
                                [movement_costs]
                                  deep_water=99
                                  shallow_water=99
                                  swamp_water=99
                                  reef=99
                                  flat=99
                                  sand=99
                                  forest=99
                                  hills=99
                                  mountains=99
                                  village=99
                                  castle=99
                                  cave=99
                                  frozen=99
                                  unwalkable=99
                                  fungus=99
                                [/movement_costs]
                            [/effect]
                            #TODO: make the slumber ability have a name/description to make it easier to see the effects!
                            [effect]
                                apply_to=new_ability
                                [abilities]
                                    #[vampire_slumber] tag used for the Lua UI ability checking
                                    [vampire_slumber]
                                        id=vampire_slumber
                                    [/vampire_slumber]
                                    [regenerate]
                                        value="(8 + 2 * self.wml_vars.vampirism_level)"
                                        id=vampire_slumber_regenerate
                                        affect_self=yes
                                        poison=cured
                                    [/regenerate]
                                [/abilities]
                            [/effect]
                            #disables all attacks
                            #TODO: maybe find some way to also disable newly-added attacks too? But for now it's not a critical bug. For now just make sure that powers that add attacks (and most powers really) are not usable during Slumber
                            [effect]
                                apply_to=attack
                                [set_specials]
                                    mode=append
                                    [disable]
                                        id=vampire_slumber_disable
                                    [/disable]
                                [/set_specials]
                            [/effect]
                        [/object]
                        [modify_unit]
                            [filter]
                                id=$this_vampire.id
                            [/filter]
                            {VARIABLE vampirism_slumber_turns_left 2}
                        [/modify_unit]
                        {CLEAR_VARIABLE vampirism_menu_active}
                    [/command]
                [/option]
                [option]
                    image="attacks/fist.png"
                    description=_"Wake up from Slumber early, but become slowed for a turn. Costs <span color='#ff0000'>5</span> Blood."
                    [show_if]
                        [have_unit]
                            id=$this_vampire.id
                            ability=vampire_slumber
                        [/have_unit]
                    [/show_if]
                    [command]
                        {VAMPIRE_SPEND_BLOOD_ON_POWER 5 (
                            [sound]
                                name=magic-dark-big.ogg
                            [/sound]
                            [remove_object]
                                id=$this_vampire.id
                                object_id=vampire_slumber
                            [/remove_object]
                            [modify_unit]
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                [status]
                                    slowed=yes
                                [/status]
                            [/modify_unit]
                            {CLEAR_VARIABLE vampirism_menu_active}
                        )}
                    [/command]
                [/option]

                [option]
                    image="icons/haste-fire-3.png"
                    description=_"Cancel Bat Form"
                    [show_if]
                        [have_unit]
                            id=$this_vampire.id
                            ability=vampire_batform
                            [not]
                                ability=vampire_batform_activated_thisturn
                            [/not]
                        [/have_unit]
                    [/show_if]
                    [command]
                        {TRANSFORM_UNIT id=$this_vampire.id $this_vampire.variables.vampirism_batform_orig_type}

                        [modify_unit]
                            [filter]
                                id=$this_vampire.id
                            [/filter]
                            {CLEAR_VARIABLE vampirism_batform_orig_type}
                        [/modify_unit]

                        [remove_object]
                            id=$this_vampire.id
                            object_id=vampirism_batform
                        [/remove_object]
                    [/command]
                [/option]


                [option]
                    image="icons/haste-fire-3.png~GS()"
                    description=_"Cancel Bat Form"
                    [show_if]
                        [have_unit]
                            id=$this_vampire.id
                            ability=vampire_batform
                            [and]
                                ability=vampire_batform_activated_thisturn
                            [/and]
                        [/have_unit]
                    [/show_if]
                    [command]
                        {TRANSFORM_UNIT id=$this_vampire.id $this_vampire.variables.vampirism_batform_orig_type}

                        [modify_unit]
                            [filter]
                                id=$this_vampire.id
                            [/filter]
                            {CLEAR_VARIABLE vampirism_batform_orig_type}
                        [/modify_unit]

                        [remove_object]
                            id=$this_vampire.id
                            object_id=vampirism_batform
                        [/remove_object]
                    [/command]
                [/option]

                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED batform icons/haste-fire-3.png  _"Bat Form" _"Power: transform into a bat until manually toggled off. 
bat type depends on unit level (not vampire level)
Costs <span color='#ff0000'>10</span> Blood." {VAMP_POWER_NOCONDITION} "" (
                        {VAMPIRE_SPEND_BLOOD_ON_POWER 10 (
                            [sound]
                                name={SOUND_LIST:BAT_HIT}
                            [/sound]

                            #lvl0 is default, other forms are "bat of one level lower than your real level"

                            {VARIABLE tmp_bat_type "Vampire Bat"}

                            {IF_VAR this_vampire.level equals 2 (
                            [then]
                                {VARIABLE tmp_bat_type "Blood Bat"}
                            [/then]
                            )}

                            {IF_VAR this_vampire.level greater_than_equal_to 3 (
                            [then]
                                {VARIABLE tmp_bat_type "Dread Bat"}
                            [/then]
                            )}

                            #TODO: make "vampirism_batform_orig_type" more mod-compatible by making it automatically reset (and also remove the batform object during the reset) if the unit's type (do a types check instead of race, probably type_adv_tree=Vampire Bat) has been changed into something that isn't a bat by story events

                            [modify_unit]
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                {VARIABLE vampirism_batform_orig_type $this_vampire.type}
                            [/modify_unit]

                            {TRANSFORM_UNIT id=$this_vampire.id $tmp_bat_type|}

                            [object]
                                silent=yes
                                duration=forever
                                id=vampirism_batform
                                take_only_once=no
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=vampire_batform
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                                #intentionally set xp to a near-unreachable value to ensure XP is not wasted by advancements done in batform
                                #TODO: make the anti-advancement method a bit more robust
                                [effect]
                                    apply_to=max_experience
                                    set=99999
                                [/effect]
                            [/object]

                            [floating_text]
                               x,y=$this_vampire.x,$this_vampire.y
                               text=_"<span color='#ff00ff'>Bat Form</span>"
                            [/floating_text]

                            {CLEAR_VARIABLE vampirism_menu_active}
                            {CLEAR_VARIABLE tmp_bat_type}
                        )}
                )}

                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED bloodsurge "attacks/fist.png" _"Blood Surge" _"Gain +33% damage to all attacks until your next turn. 
Costs <span color='#ff0000'>8</span> Blood." (
                    [have_unit]
                        id=$this_vampire.id
                        [not]
                            ability=vampire_blood_surge_active
                        [/not]
                    [/have_unit]
                ) _"This Power is already active. You can only activate it again after the duration ends." (
                        {VAMPIRE_SPEND_BLOOD_ON_POWER 8 (
                            [sound]
                                name=magic-dark-big.ogg
                            [/sound]
                            [object]
                                silent=yes
                                duration=turn
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                [effect]
                                    apply_to=attack
                                    increase_damage=33%
                                [/effect]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=vampire_blood_surge_active#to prevent stacking
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                            [/object]

                            [floating_text]
                               x,y=$this_vampire.x,$this_vampire.y
                               text=_"<span color='#ff00ff'>Blood Surge</span>"
                            [/floating_text]

                            {CLEAR_VARIABLE vampirism_menu_active}
                        )}
                )}

                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED bloodshield icons/protect-red-1.png "Blood Shield" _"Power: Gain +20% to most resistances (except arcane) until your next turn. 
Costs <span color='#ff0000'>8</span> Blood." (
                    [have_unit]
                        id=$this_vampire.id
                        [not]
                            ability=vampire_blood_shield
                        [/not]
                    [/have_unit]
                ) _"This Power is already active. You can only activate it again after the duration ends." (
                        {VAMPIRE_SPEND_BLOOD_ON_POWER 8 (
                            [sound]
                                name=magic-dark-big.ogg
                            [/sound]
                            [object]
                                silent=yes
                                duration=turn
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                [effect]
                                    apply_to=attack
                                    increase_damage=33%
                                [/effect]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [resistance]
                                            id=vampire_blood_shield
                                            add=20
                                            max_value=60
                                            [filter_base_value]
                                                less_than=60
                                            [/filter_base_value]
                                            apply_to=blade,pierce,impact,fire,cold
                                            affect_self=yes
                                            affect_allies=no
                                        [/resistance]
                                    [/abilities]
                                [/effect]
                            [/object]
                            [floating_text]
                               x,y=$this_vampire.x,$this_vampire.y
                               text=_"<span color='#ff00ff'>Blood Shield</span>"
                            [/floating_text]
                            {CLEAR_VARIABLE vampirism_menu_active}
                        )}
                )}


                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED greatfeast "icons/horror-redalt-3.png" _"Great Feast" _"permanently destroy the village you are standing on 
to gain <span color='#ff0000'>$this_vampire.variables.vampirism_blood_from_village_greatfeast|</span> Blood and heal 25 HP.
(cannot feast during daytime)" (
                    [have_unit]
                        id=$this_vampire.id
                        [filter_location]
                            terrain=*^V*
                            [not]
                                #vampires cannot feed in villages at day because of sunlight
                                time_of_day=lawful
                            [/not]
                        [/filter_location]
                    [/have_unit]
                ) _"This Power is only available if standing in a village but NOT at daytime." (
                        [sound]
                            name=bite.ogg
                        [/sound]
                        [delay]
                            time=100
                        [/delay]
                        [sound]
                            name={SOUND_LIST:HUMAN_DIE}
                        [/sound]
                        [delay]
                            time=100
                        [/delay]
                        [sound]
                            name=bite.ogg
                        [/sound]
                        [delay]
                            time=100
                        [/delay]
                        [sound]
                            name={SOUND_LIST:HUMAN_FEMALE_DIE}
                        [/sound]
                        [delay]
                            time=100
                        [/delay]
                        [sound]
                            name=bite.ogg
                        [/sound]
                        [delay]
                            time=100
                        [/delay]
                        [sound]
                            name={SOUND_LIST:HUMAN_DIE}
                        [/sound]
                        [delay]
                            time=100
                        [/delay]
                        [sound]
                            name=bite.ogg
                        [/sound]
                        [delay]
                            time=100
                        [/delay]
                        [sound]
                            name={SOUND_LIST:HUMAN_FEMALE_DIE}
                        [/sound]
                        [delay]
                            time=100
                        [/delay]
                        [sound]
                            name=bite.ogg
                        [/sound]
                        [delay]
                            time=100
                        [/delay]
                        [sound]
                            name={SOUND_LIST:HUMAN_DIE}
                        [/sound]                        
                        [delay]
                            time=100
                        [/delay]
                        [sound]
                            name=wose-die.ogg
                        [/sound]
                        #remove the village layer
                        [terrain]
                            terrain=^
                            x,y=$x1,$y1
                            layer=overlay
                        [/terrain]
                        #add village ruins
                        {RANDOM 1..4}
                        [item]
                            x,y=$x1,$y1
                            name=vampire_destroyedvillage
                            image=scenery/village-human-burned$random|.png
                        [/item]                        
                        [heal_unit]
                            [filter]
                                id=$this_vampire.id
                            [/filter]
                            amount=25
                            animate=yes
                            restore_statuses=no
                        [/heal_unit]
                        {VAMPIRISM_GAIN_BLOOD id=$this_vampire.id $this_vampire.variables.vampirism_blood_from_village_greatfeast|}
                        {VAMPIRISM_GAIN_BLOOD_FLOATTEXT_AND_XP this_vampire $this_vampire.x $this_vampire.y $this_vampire.variables.vampirism_blood_from_village_greatfeast|}
                        {CLEAR_VARIABLE vampirism_menu_active}
                )}

                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED carnage "icons/astralblade-red.png" _"Carnage" _"Attack 1 more time this turn
attacks only consume 4 MP instead of all MP until the end of the turn
Gain skirmisher until the end of the turn
Costs <span color='#ff0000'>40</span> Blood." (
                    [have_unit]
                        id=$this_vampire.id
                        [not]
                            ability=vampire_carnage_active
                        [/not]
                    [/have_unit]
                ) _"This Power is already active. You can only activate it again after the duration ends." (
                        {VAMPIRE_SPEND_BLOOD_ON_POWER 40 (
                            [sound]
                                name=magic-dark-big.ogg
                            [/sound]
                            [object]
                                silent=yes
                                duration=turn
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                [effect]
                                    apply_to=max_attacks
                                    increase=1
                                [/effect]
                                [effect]
                                    apply_to=attack
                                    set_movement_used=4
                                [/effect]                                
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=vampire_carnage_active#to prevent stacking
                                        [/dummy]
                                        {ABILITY_SKIRMISHER}
                                    [/abilities]
                                [/effect]
                            [/object]

                            [modify_unit]
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                attacks_left="$($this_vampire.attacks_left + 1)"
                            [/modify_unit]

                            [floating_text]
                               x,y=$this_vampire.x,$this_vampire.y
                               text=_"<span color='#ff00ff'>Carnage</span>"
                            [/floating_text]

                            {CLEAR_VARIABLE vampirism_menu_active}
                        )}
                )}

                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED cloakofdarkness icons/fog-magenta-1.png _"Cloak of Darkness" _"gain nightstalk and skirmisher until your next turn
Costs <span color='#ff0000'>10</span> Blood." (
                    [have_unit]
                        id=$this_vampire.id
                        [not]
                            ability=vampire_cloak_of_darkness_active
                        [/not]
                    [/have_unit]
                ) _"This Power is already active. You can only activate it again after the duration ends." (
                        {VAMPIRE_SPEND_BLOOD_ON_POWER 10 (
                            [sound]
                                name=magic-dark-big.ogg
                            [/sound]
                            [object]
                                silent=yes
                                duration=turn
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=vampire_cloak_of_darkness_active
                                        [/dummy]
                                        {ABILITY_NIGHTSTALK}
                                        {ABILITY_SKIRMISHER}
                                    [/abilities]
                                [/effect]
                            [/object]
                            #floating text is hidden on purpose since the power is supposed to be sneaky
                            #[floating_text]
                            #   x,y=$this_vampire.x,$this_vampire.y
                            #   text=_"<span color='#ff00ff'>Cloak of Darkness</span>"
                            #[/floating_text]
                            {CLEAR_VARIABLE vampirism_menu_active}
                        )}
                )}

                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED corrupt icons/evil-eye-eerie-2.png _"Corrupt" _"make an adjacent ally Chaotic
(lasts permanently)
Costs <span color='#ff0000'>20</span> Blood." {VAMP_POWER_NOCONDITION} "" (
                        {VAMPIRISM_TARGET_SELECTION_SUBMENU _"Corrupt: Permanently make the target Chaotic" _"" (
                            [filter_side]
                                [allied_with]
                                    side=$side_number
                                [/allied_with]
                            [/filter_side]
                            [filter_location]
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                radius=1
                            [/filter_location]
                            [not]
                                [filter_wml]
                                    alignment=chaotic
                                [/filter_wml]
                            [/not]
                            [not]
                                [filter_wml]
                                [status]
                                    petrified=yes
                                [/status]
                                [/filter_wml]
                            [/not]
                        ) this_vampire (
                            {VAMPIRE_SPEND_BLOOD_ON_POWER 20 (
                                [sound]
                                    name=magic-dark-big.ogg
                                [/sound]
                                [object]
                                    silent=yes
                                    duration=forever
                                    id=vampirism_corrupt
                                    take_only_once=no
                                    [filter]
                                        id=$tmp_power_target_id
                                    [/filter]
                                    [effect]
                                        apply_to=alignment
                                        set=chaotic
                                    [/effect]
                                [/object]

                                [floating_text]
                                   x,y=$tmp_power_target_x,$tmp_power_target_y
                                   text=_"<span color='#ff00ff'>Corrupt</span>"
                                [/floating_text]

                                {CLEAR_VARIABLE vampirism_menu_active}
                            )}
                        )}
                )}

                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED curseofmisfortune icons/horror-eerie-1.png _"Curse of Misfortune" _"Select an enemy in a 2-tile range
Target has 10% less defense and chance to hit until the end of their next turn
Costs <span color='#ff0000'>6</span> Blood." {VAMP_POWER_NOCONDITION} "" (
                        {VAMPIRISM_TARGET_SELECTION_SUBMENU _"Curse of Misfortune: Target enemy has 10% less defense and chance to hit until the end of their next turn" _"" (
                            [filter_side]
                                [enemy_of]
                                    side=$side_number
                                [/enemy_of]
                            [/filter_side]
                            [filter_location]
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                radius=2
                            [/filter_location]
                            [not]
                                ability=vampirism_curse_of_misfortune
                            [/not]
                            [not]
                                [filter_wml]
                                [status]
                                    petrified=yes
                                [/status]
                                [/filter_wml]
                            [/not]
                        ) this_vampire (
                            {VAMPIRE_SPEND_BLOOD_ON_POWER 6 (
                                [sound]
                                    name=magic-dark-big.ogg
                                [/sound]
                                [object]
                                    silent=yes
                                    duration=turn end
                                    id=vampirism_curse_of_misfortune
                                    take_only_once=no
                                    [filter]
                                        id=$tmp_power_target_id
                                    [/filter]
                                    [effect]
                                        apply_to=new_ability
                                        [abilities]
                                            [chance_to_hit]
                                                id=vampirism_curse_of_misfortune
                                                name=_"curse of misfortune"
                                                description=_"This unit's defense and chance to hit of all attacks are reduced by 10% until the end of their turn."
                                                sub=10
                                                cumulative=yes
                                            [/chance_to_hit]
                                        [/abilities]
                                    [/effect]
                                    [effect]
                                        apply_to=defense
                                        replace=no
                                        [defense]
                                          deep_water=10
                                          shallow_water=10
                                          swamp_water=10
                                          reef=10
                                          flat=10
                                          sand=10
                                          forest=10
                                          hills=10
                                          mountains=10
                                          village=10
                                          castle=10
                                          cave=10
                                          frozen=10
                                          unwalkable=10
                                          fungus=10
                                        [/defense]
                                    [/effect]
                                [/object]

                                [floating_text]
                                   x,y=$tmp_power_target_x,$tmp_power_target_y
                                   text=_"<span color='#ff00ff'>Curse of Misfortune</span>"
                                [/floating_text]
    
                                {CLEAR_VARIABLE vampirism_menu_active}
                            )}
                        )}
                )}

                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED darkens icons/vampire-darken-aura.png _"Engulf in Darkness" _"gain darkens ability until your next turn.
Costs <span color='#ff0000'>20</span> Blood." (
                    [have_unit]
                        id=$this_vampire.id
                        [not]
                            ability=vampire_darkens
                        [/not]
                    [/have_unit]
                ) _"This Power is already active. You can only activate it again after the duration ends." (
                        {VAMPIRE_SPEND_BLOOD_ON_POWER 20 (
                            [sound]
                                name=magic-dark-big.ogg
                            [/sound]
                            [object]
                                silent=yes
                                duration=turn
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                [effect]
                                    apply_to=halo
                                    halo="halo/darkens-aura.png"
                                [/effect]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [illuminates]
                                            id=vampire_darkens
                                            value=-25
                                            min_value=-25
                                            max_value=25
                                            cumulative=no
                                            affect_self=yes
                                            name=_"darkens"
                                            description=_"This unit darkens the surrounding area, making chaotic units fight better, and lawful units fight worse.
                                    
Any units adjacent to this unit will fight as if it were dusk when it is day, and as if it were night when it is dusk."
                                        [/illuminates]
                                    [/abilities]
                                [/effect]
                            [/object]
                            [floating_text]
                               x,y=$this_vampire.x,$this_vampire.y
                               text=_"<span color='#ff00ff'>Engulf in Darkness</span>"
                            [/floating_text]
                            {CLEAR_VARIABLE vampirism_menu_active}
                        )}
                )}

#BLOODHEAL IS AN UNUSED POWER FOR NOW, I TEMPORARILY COMMENTED OUT THE UPGRADE in the upgrade file!!!
#(the code works, it's just that I decided to make players need drain or Slumber heal well, and bloodheal messes with that balance)
                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED bloodheal "icons/potion_red_medium.png" _"Blood Heal" _"spend as much Blood as possible to heal yourself
at a cost of 1 Blood per 1 hitpoint." (
                    [have_unit]
                        id=$this_vampire.id
                        formula="hitpoints < max_hitpoints"
                    [/have_unit]
                ) _"Can only use this Power when wounded (hitpoints are below max hitpoints)" (

                        {VARIABLE tmp_bloodheal_missing_hp "$($this_vampire.max_hitpoints - $this_vampire.hitpoints)"}
                        {VARIABLE tmp_healed_amount $tmp_bloodheal_missing_hp}
#                        {VARIABLE tmp_heal_blood_cost "$($tmp_healed_amount / 2)"}
                        {VARIABLE tmp_heal_blood_cost $tmp_healed_amount}

#                        [chat]
#                            message="pre check: amount $tmp_healed_amount| cost $tmp_heal_blood_cost|"
#                        [/chat]

                        {IF_VAR tmp_heal_blood_cost greater_than $this_vampire.variables.vampirism_blood (
                        [then]
                            {VARIABLE tmp_heal_blood_cost $this_vampire.variables.vampirism_blood}
                            #{VARIABLE tmp_healed_amount "$($tmp_heal_blood_cost * 2)"}
                            {VARIABLE tmp_healed_amount $tmp_heal_blood_cost}
                        [/then]
                        )}

#                        [chat]
#                            message="post check: amount $tmp_healed_amount| cost $tmp_heal_blood_cost|"
#                        [/chat]

                        {VAMPIRE_SPEND_BLOOD_ON_POWER $tmp_heal_blood_cost (
                            [heal_unit]
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                amount=$tmp_healed_amount
                                animate=yes
                                restore_statuses=no
                            [/heal_unit]

                            {CLEAR_VARIABLE vampirism_menu_active}
                        )}
                        {CLEAR_VARIABLE tmp_healed_amount}
                        {CLEAR_VARIABLE tmp_heal_blood_cost}
                )}

                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED predatorvision "icons/evil-eye-eerie-1.png" _"Predator Vision" _"In a 10-tile radius, reveal invisible enemies and clear fog/shroud
(works even through walls)
Costs <span color='#ff0000'>10</span> Blood." {VAMP_POWER_NOCONDITION} () (
                        {VAMPIRE_SPEND_BLOOD_ON_POWER 10 (
                            [sound]
                                name=magic-dark-big.ogg
                            [/sound]
                            [modify_unit]
                                [filter]
                                    [filter_location]
                                        [filter]
                                            id=$this_vampire.id
                                        [/filter]
                                        radius=10
                                    [/filter_location]
                                    [filter_side]
                                        [enemy_of]
                                            side=$side_number
                                        [/enemy_of]
                                    [/filter_side]
                                [/filter]
                                [status]
                                    uncovered=yes
                                [/status]
                            [/modify_unit]
                            [lift_fog]
                                side=$side_number
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                radius=10
                            [/lift_fog]
                            [remove_shroud]
                                side=$side_number
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                radius=10
                            [/remove_shroud]
                            {CLEAR_VARIABLE vampirism_menu_active}
                        )}
                )}


                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED blood_bolt "icons/blood-explosion.png" _"Blood Bolt" _"gain a magical fire ranged attack until the end of the turn
(Blood Bolt gains bonus damage if you already have a ranged attack with the 'magical' special
EXCEPT for other vampire magical attacks)"  (
                    [have_unit]
                        id=$this_vampire.id
                        [not]
                            ability=vampire_blood_bolt_active
                        [/not]
                    [/have_unit]
                ) _"This Power is already active. You can only activate it again after the duration ends."  (
                        {VAMPIRE_SPEND_BLOOD_ON_POWER 10 (
                            [sound]
                                name=magic-dark-big.ogg
                            [/sound]
                            [object]
                                silent=yes
                                duration=turn
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                [effect]
                                    apply_to=new_attack
                                    name=vampire_bloodbolt#to avoid overlap with any existing attacks
                                    description=_"blood bolt"
                                    icon=icons/blood-explosion.png
                                    type=fire
                                    range=ranged
                                    damage=3
                                    number=3
                                    [specials]
                                        {WEAPON_SPECIAL_MAGICAL}
                                    [/specials]
                                    attack_weight=2#make the draining attack used/recommended more often, since blood is very important for vampires
                                [/effect]
                                [effect]
                                    apply_to=attack
                                    name=vampire_bloodbolt
                                    increase_damage=3
                                    times=per level
                                [/effect]
                                [effect]
                                    apply_to=new_animation
                                    [attack_anim]
                                        [filter_attack]
                                            name=vampire_bloodbolt
                                        [/filter_attack]
                                
                                        magic_missile_start_time=-750
                                    
                                        magic_missile_trail_1_start_time=-350
                                        magic_missile_trail_2_start_time=-350
                                        magic_missile_trail_3_start_time=-350
                                    
                                        [magic_missile_frame]
                                            duration=400
                                            halo=halo/mage-halo[1~5].png
                                            halo_x=0~0
                                            halo_y=0~-54
                                            offset=0.001~-0.083,-0.083~-0.25,-0.25~-0.5
                                            halo_mod="~GS()~BLEND(200,0,0,0.8)"
                                        [/magic_missile_frame]
                                        [magic_missile_frame]
                                            duration=350
                                            halo=halo/mage-halo[1~5].png
                                            halo_y=-54~-45,-45~-27,-27~0
                                            offset=-0.5~-0.25,-0.25~0.25,0.25~1.0
                                            halo_mod="~GS()~BLEND(200,0,0,0.8)"
                                        [/magic_missile_frame]
                                    
                                        [magic_missile_trail_1_frame]
                                            duration=350
                                            halo=misc/blank-hex.png:40,halo/mage-preparation-halo[1~7].png
                                            halo_y=-54:40,-54~-45,-45~-27,-27~0
                                            offset=0.001:40,-0.5~-0.25,-0.25~0.25,0.25~1.0
                                            halo_mod="~GS()~BLEND(200,0,0,0.8)"
                                        [/magic_missile_trail_1_frame]
                                        [magic_missile_trail_2_frame]
                                            duration=350
                                            halo=misc/blank-hex.png:80,halo/mage-preparation-halo[1~7].png
                                            halo_y=-54:80,-54~-45,-45~-27,-27~0
                                            offset=0.001:80,-0.5~-0.25,-0.25~0.25,0.25~1.0
                                            halo_mod="~GS()~BLEND(200,0,0,0.8)"
                                        [/magic_missile_trail_2_frame]
                                        [magic_missile_trail_3_frame]
                                            duration=350
                                            halo=misc/blank-hex.png:120,halo/mage-preparation-halo[1~7].png
                                            halo_y=-54:120,-54~-45,-45~-27,-27~0
                                            offset=0.001:120,-0.5~-0.25,-0.25~0.25,0.25~1.0
                                            halo_mod="~GS()~BLEND(200,0,0,0.8)"
                                        [/magic_missile_trail_3_frame]                                
                                        start_time=-800
                                        offset=0
                                        [frame]
                                            duration=1000
                                        [/frame]
                                        # wmlscope: start ignoring
                                        {SOUND:HIT_AND_MISS magic-missile-[1~3].ogg magic-missile-[1~3]-miss.ogg -350}
                                    [/attack_anim]
                                [/effect]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=vampire_blood_bolt_active#to prevent stacking
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                            [/object]
                            #bonus blood bolt damage to units who were already mages
                            [object]
                                silent=yes
                                duration=turn
                                [filter]
                                    id=$this_vampire.id
                                    [has_attack]
                                        range=ranged
                                        special_id=magical
                                        #vampire magic attacks don't count
                                        [not]
                                            name=vampire_bloodbolt
                                            [or]
                                                name=vampire_drainlife
                                            [/or]
                                        [/not]
                                    [/has_attack]
                                [/filter]
                                [effect]
                                    apply_to=attack
                                    name=vampire_bloodbolt
                                    increase_damage=2
                                    times=per level
                                [/effect]
                            [/object]
                            #update strength bonus after adding the new attack
                            {APPLY_VAMPIRE_STRENGTH_BONUS id=$this_vampire.id}
                            [floating_text]
                               x,y=$this_vampire.x,$this_vampire.y
                               text=_"<span color='#ff00ff'>Blood Bolt</span>"
                            [/floating_text]

                            {CLEAR_VARIABLE vampirism_menu_active}
                        )}
                )}


                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED crimson_lightning icons/blood-lightning.png _"Crimson Lightning" _"Deal heavy damage to a target
range: 4 tiles
damage scales with unit level and vampire level
can only be used if you can still attack this turn
Costs <span color='#ff0000'>30</span> Blood." (
                    #only usable if you can still attack
                    [have_unit]
                        id=$this_vampire.id
                        formula="(attacks_left >= 1)"
                    [/have_unit]
                ) _"This Power is only usable if you can still attack this turn." (
                    {VARIABLE tmp_crimson_lightning_damage "$(6 + $this_vampire.level| * 6)"}

                    [chat]
                        message=$tmp_crimson_lightning_damage
                    [/chat]

                    {VARIABLE_OP tmp_crimson_lightning_damage add "$($tmp_crimson_lightning_damage| *  ($this_vampire.variables.vampirism_strength_bonus_level| * 10 ) / 100 )"}
                    {VARIABLE_OP tmp_crimson_lightning_damage round floor}

                    [chat]
                        message=$tmp_crimson_lightning_damage
                    [/chat]

                        {VAMPIRISM_TARGET_SELECTION_SUBMENU _"Crimson Lightning: deal $tmp_crimson_lightning_damage| fire damage to the target enemy" _"" (
                            [filter_side]
                                [enemy_of]
                                    side=$side_number
                                [/enemy_of]
                            [/filter_side]
                            [filter_location]
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                radius=4
                            [/filter_location]
                            [not]
                                [filter_wml]
                                [status]
                                    petrified=yes
                                [/status]
                                [/filter_wml]
                            [/not]
                        ) this_vampire (

                            {VAMPIRE_SPEND_BLOOD_ON_POWER 30 (
                                [sound]
                                    name=magic-dark-big.ogg
                                [/sound]
                                [modify_unit]
                                    [filter]
                                        id=$this_vampire.id
                                    [/filter]
                                    attacks_left="$($this_vampire.attacks_left - 1)"
                                [/modify_unit]

                                {RANDOM 1..3}

                                [object]
                                    silent=yes
                                    duration=turn
                                    [filter]
                                        id=$tmp_power_target_id
                                    [/filter]
                                    [effect]
                                        apply_to=new_animation
                                        [extra_anim]
                                            flag=hit_by_crimson_lightning
                                            [missile_frame]
                                                halo=halo/lightning-bolt-$random|-1.png:100,halo/lightning-bolt-$random|-2.png:100,halo/                                    lightning-bolt-$random|-3.png:100,halo/lightning-bolt-$random|-4.png:100
                                                halo_mod="~CS(200,-150,-200)"
                                                halo_y=-125
                                                auto_vflip=no
                                                offset=0.0
                                            [/missile_frame]
                                            [frame]
                                                sound=lightning.ogg
                                            [/frame]
                                        [/extra_anim]
                                    [/effect]
                                [/object]

                                [animate_unit]
                                    flag=hit_by_crimson_lightning
                                    [filter]
                                        id=$tmp_power_target_id
                                    [/filter]
                                [/animate_unit] 

                                [harm_unit]
                                    [filter]
                                        id=$tmp_power_target_id
                                    [/filter]
                                    [filter_second]
                                        id=$this_vampire.id
                                    [/filter_second]
                                    amount=$tmp_crimson_lightning_damage
                            #alignment is not factored in for Crimson Lightning for now
                            #        alignment=$this_item.alignment
                                    damage_type=fire
                                    experience=yes
                                    fire_event=yes
                                    animate=yes
                                    kill=yes
                                [/harm_unit]

                                #not really needed, the flashy red lightning is clear enough
                                #[floating_text]
                                #   x,y=$tmp_power_target_x,$tmp_power_target_y
                                #   text=_"<span color='#ff00ff'>Crimson Lightning</span>"
                                #[/floating_text]

                                {CLEAR_VARIABLE vampirism_menu_active}
                            )}
                        )}
                        {CLEAR_VARIABLE tmp_crimson_lightning_damage}
                )}

                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED raiseundead "attacks/touch-zombie.png" _"Raise Undead" _"summon 2 Walking Corpses. Costs <span color='#ff0000'>12</span> Blood." (
                    #most summon powers have a once-per-turn limit to discourge spamming the same power and encourage mixing and matching the summon powers
                    [have_unit]
                        id=$this_vampire.id
                        [not]
                            ability=vampire_used_this_turn_raiseundead
                        [/not]
                    [/have_unit]
                ) _"This Power is only usable once per turn." (
                        {VAMPIRE_SPEND_BLOOD_ON_POWER 12 (
                            [sound]
                                name=magic-dark-big.ogg
                            [/sound]
                            {REPEAT 2 (
                            [unit]
                                type=Walking Corpse
                                generate_name=yes
                                side=$this_vampire.side
                                x=$this_vampire.x
                                y=$this_vampire.y
                                placement=map
                                overwrite=no
                                attacks_left=0
                                moves=0
                                animate=yes
                            [/unit]
                            )}
                            [object]
                                silent=yes
                                duration=turn
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=vampire_used_this_turn_raiseundead
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                            [/object]
                            {CLEAR_VARIABLE vampirism_menu_active}
                        )}
                )}

                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED summonghost "attacks/wail.png" _"Bind Soul" _"summon a Ghost. Costs <span color='#ff0000'>19</span> Blood." (
                    [have_unit]
                        id=$this_vampire.id
                        [not]
                            ability=vampire_used_this_turn_summonghost
                        [/not]
                    [/have_unit]
                ) _"This Power is only usable once per turn." (
                        {VAMPIRE_SPEND_BLOOD_ON_POWER 19 (
                            [sound]
                                name=wail-long.wav
                            [/sound]
                            [unit]
                                type=Ghost
                                generate_name=yes
                                side=$this_vampire.side
                                x=$this_vampire.x
                                y=$this_vampire.y
                                placement=map
                                overwrite=no
                                attacks_left=0
                                moves=0
                                animate=yes
                            [/unit]
                            [object]
                                silent=yes
                                duration=turn
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=vampire_used_this_turn_summonghost
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                            [/object]
                            {CLEAR_VARIABLE vampirism_menu_active}
                        )}
                )}


                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED summonrevenant "attacks/axe-undead.png" _"Bone Guard" _"summon a Revenant. Costs <span color='#ff0000'>28</span> Blood." (
                    [have_unit]
                        id=$this_vampire.id
                        [not]
                            ability=vampire_used_this_turn_summonrevenant
                        [/not]
                    [/have_unit]
                ) _"This Power is only usable once per turn." (
                        {VAMPIRE_SPEND_BLOOD_ON_POWER 28 (
                            [sound]
                                name=magic-dark-big.ogg
                            [/sound]
                            [unit]
                                type=Revenant
                                generate_name=yes
                                side=$this_vampire.side
                                x=$this_vampire.x
                                y=$this_vampire.y
                                placement=map
                                overwrite=no
                                attacks_left=0
                                moves=0
                                animate=yes
                            [/unit]
                            [object]
                                silent=yes
                                duration=turn
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=vampire_used_this_turn_summonrevenant
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                            [/object]
                            {CLEAR_VARIABLE vampirism_menu_active}
                        )}
                )}

                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED summonundeadhorde "attacks/touch-zombie.png" _"Undead Horde" _"Power: Summon 4 Soulless and 4 Walking Corpses. Costs <span color='#ff0000'>65</span> Blood." (
                    #most summon powers have a once-per-turn limit to discourge spamming the same power and encourage mixing and matching the summon powers
                    [have_unit]
                        id=$this_vampire.id
                        [not]
                            ability=vampire_used_this_turn_summonundeadhorde
                        [/not]
                    [/have_unit]
                ) _"This Power is only usable once per turn." (
                        {VAMPIRE_SPEND_BLOOD_ON_POWER 65 (
                            [sound]
                                name=magic-dark-big.ogg
                            [/sound]
                            {REPEAT 3 (
                            [unit]
                                type=Soulless
                                generate_name=yes
                                side=$this_vampire.side
                                x=$this_vampire.x
                                y=$this_vampire.y
                                placement=map
                                overwrite=no
                                attacks_left=0
                                moves=0
                                animate=yes
                            [/unit]
                            )}
                            {REPEAT 5 (
                            [unit]
                                type=Walking Corpse
                                generate_name=yes
                                side=$this_vampire.side
                                x=$this_vampire.x
                                y=$this_vampire.y
                                placement=map
                                overwrite=no
                                attacks_left=0
                                moves=0
                                animate=yes
                            [/unit]
                            )}
                            [object]
                                silent=yes
                                duration=turn
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=vampire_used_this_turn_summonundeadhorde
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                            [/object]
                            {CLEAR_VARIABLE vampirism_menu_active}
                        )}
                )}

                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED batswarm "attacks/fangs-animal.png" _"Bat Swarm" _"summon 4 Vampire Bats. Costs <span color='#ff0000'>30</span> Blood."  (
                    [have_unit]
                        id=$this_vampire.id
                        [not]
                            ability=vampire_used_this_turn_batswarm
                        [/not]
                    [/have_unit]
                ) _"This Power is only usable once per turn." (
                        {VAMPIRE_SPEND_BLOOD_ON_POWER 30 (
                            [sound]
                                name={SOUND_LIST:BAT_HIT}
                            [/sound]
                            {REPEAT 4 (
                            [unit]
                                type=Vampire Bat
                                generate_name=yes
                                side=$this_vampire.side
                                x=$this_vampire.x
                                y=$this_vampire.y
                                placement=map
                                overwrite=no
                                attacks_left=0
                                moves=0
                                animate=yes
                            [/unit]
                            )}
                            [object]
                                silent=yes
                                duration=turn
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                [effect]
                                    apply_to=new_ability
                                    [abilities]
                                        [dummy]
                                            id=vampire_used_this_turn_batswarm
                                        [/dummy]
                                    [/abilities]
                                [/effect]
                            [/object]
                            {CLEAR_VARIABLE vampirism_menu_active}
                        )}
                )}


                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED terrify icons/horror-eerie-2.png _"Terrify" _"Select an enemy in a 2-tile range
Target's attacks become defend-only until the end of their next turn
AI-controlled targets will run away
Can only target enemies of a lower level than you
Costs <span color='#ff0000'>10</span> Blood multiplied by enemy level (5 for level 0 enemies)."  (
                    #usable once per turn to avoid it being spammable
                    [have_unit]
                        id=$this_vampire.id
                        [not]
                            ability=vampire_used_this_turn_terrify
                        [/not]
                    [/have_unit]
                ) _"This Power is only usable once per turn."  (
                        {VARIABLE tmp_vampire_terrify_costmult 10}

                        {VAMPIRISM_TARGET_SELECTION_SUBMENU _"Terrify: Target's attacks become defend-only until the end of their next turn
AI-controlled targets will run away
Can only target enemies of a lower level than you" _" - costs <span color='#ff0000'>$(max($this_item.level| * $tmp_vampire_terrify_costmult|, $tmp_vampire_terrify_costmult| / 2) )</span> blood" (
                            formula="level < $this_vampire.level"
                            [filter_side]
                                [enemy_of]
                                    side=$side_number
                                [/enemy_of]
                            [/filter_side]
                            [filter_location]
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                radius=2
                            [/filter_location]
                            [not]
                                ability=vampirism_terrified
                            [/not]
                            [not]
                                [filter_wml]
                                [status]
                                    petrified=yes
                                [/status]
                                [/filter_wml]
                            [/not]
                        ) this_vampire (

                            [store_unit]
                                [filter]
                                    id=$tmp_power_target_id
                                [/filter]
                                variable=tmp_terrify_target
                                kill=no
                            [/store_unit]

                            #max is to make sure the price for lvl0 units isn't 0 blood

                            {VARIABLE tmp_vampire_terrify_cost "$(max($tmp_terrify_target.level| * $tmp_vampire_terrify_costmult|, $tmp_vampire_terrify_costmult| / 2) )"}

                            {CLEAR_VARIABLE tmp_terrify_target}

                            {VAMPIRE_SPEND_BLOOD_ON_POWER $tmp_vampire_terrify_cost (
                                [sound]
                                    name=magic-dark-big.ogg
                                [/sound]
                                [object]
                                    silent=yes
                                    duration=turn end
                                    id=vampirism_curse_of_misfortune
                                    take_only_once=no
                                    [filter]
                                        id=$tmp_power_target_id
                                    [/filter]
                                    [effect]
                                        apply_to=new_ability
                                        [abilities]
                                            [dummy]
                                                id=vampirism_terrified
                                                name=_"terrified"
                                                description=_"This unit's attacks cannot be used in offense, only defense."
                                            [/dummy]
                                        [/abilities]
                                    [/effect]
                                    #disables all attacks on offense
                                    #TODO: maybe find some way to also disable newly-added attacks too? But for now it's not a critical bug. For now just make sure that powers that add attacks (and most powers really) are not usable during Slumber
                                    [effect]
                                        apply_to=attack
                                        [set_specials]
                                            mode=append
                                            [disable]
                                                id=vampire_terrify_disable
                                                name=_"terrified"
                                                description=_"This attack cannot be used in offense, only defense."
                                                active_on=offense
                                            [/disable]
                                        [/set_specials]
                                    [/effect]
                                [/object]

                                [floating_text]
                                   x,y=$tmp_power_target_x,$tmp_power_target_y
                                   text=_"<span color='#ff00ff'>Terrify</span>"
                                [/floating_text]
    
                                {CLEAR_VARIABLE vampirism_menu_active}
                            )}
                        )}
                        {CLEAR_VARIABLE tmp_vampire_terrify_costmult}
                )}

                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED enthrall icons/evil-eye-red-3.png _"Enthrall" _"Turn an adjacent enemy to your side
(does not work on leaders)
Costs <span color='#ff0000'>30</span> Blood multiplied by enemy level (15 for level 0 enemies)." (
                    #usable once per turn to avoid it being spammable
                    [have_unit]
                        id=$this_vampire.id
                        [not]
                            ability=vampire_used_this_turn_enthrall
                        [/not]
                    [/have_unit]
                ) _"This Power is only usable once per turn." (
                        {VARIABLE tmp_vampire_enthrall_costmult 30}

                        {VAMPIRISM_TARGET_SELECTION_SUBMENU _"Enthrall: Turn the target enemy to your side" _" - costs <span color='#ff0000'>$(max($this_item.level| * $tmp_vampire_enthrall_costmult|, $tmp_vampire_enthrall_costmult| / 2) )</span> blood" (
                            [filter_side]
                                [enemy_of]
                                    side=$side_number
                                [/enemy_of]
                            [/filter_side]
                            [filter_location]
                                [filter]
                                    id=$this_vampire.id
                                [/filter]
                                radius=1
                            [/filter_location]
                            #prevent enthralling leaders so it doesn't break campaigns TOO hard. it can still break them though
                            [not]
                                canrecruit=yes
                            [/not]
                            [not]
                                [filter_wml]
                                [status]
                                    petrified=yes
                                [/status]
                                [/filter_wml]
                            [/not]
                        ) this_vampire (

                            [store_unit]
                                [filter]
                                    id=$tmp_power_target_id
                                [/filter]
                                variable=tmp_enthrall_target
                                kill=no
                            [/store_unit]

                            #max is to make sure the price for lvl0 units isn't 0 blood

                            {VARIABLE tmp_vampire_enthrall_cost "$(max($tmp_enthrall_target.level| * $tmp_vampire_enthrall_costmult|, $tmp_vampire_enthrall_costmult| / 2) )"}

                            {CLEAR_VARIABLE tmp_enthrall_target}

                            {VAMPIRE_SPEND_BLOOD_ON_POWER $tmp_vampire_enthrall_cost (
                                [sound]
                                    name=magic-dark-big.ogg
                                [/sound]
                                [modify_unit]
                                    [filter]
                                        id=$tmp_power_target_id
                                    [/filter]
                                    side=$this_vampire.side
                                [/modify_unit]

                                [object]
                                    silent=yes
                                    duration=turn
                                    [filter]
                                        id=$this_vampire.id
                                    [/filter]
                                    [effect]
                                        apply_to=new_ability
                                        [abilities]
                                            [dummy]
                                                id=vampire_used_this_turn_enthrall
                                            [/dummy]
                                        [/abilities]
                                    [/effect]
                                [/object]

                                [floating_text]
                                   x,y=$tmp_power_target_x,$tmp_power_target_y
                                   text=_"<span color='#ff00ff'>Enthrall</span>"
                                [/floating_text]

                                {CLEAR_VARIABLE vampirism_menu_active}
                            )}
                        )}
                        {CLEAR_VARIABLE tmp_vampire_enthrall_costmult}
                )}

                {UPGRADE_POWER_MENU_CONDITIONALLY_GREYED siring attacks/touch-undead.png _"Siring" _"Permanently turn an adjacent ally
into a vampire
Costs <span color='#ff0000'>50</span> Blood." {VAMP_POWER_NOCONDITION} "" (
                        {VAMPIRISM_TARGET_SELECTION_SUBMENU _"Siring: Permanently turn the target into a vampire" _"" (
                            [filter_side]
                                [allied_with]
                                    side=$side_number
                                [/allied_with]
                            [/filter_side]
                            side=$side_number
                            [filter_adjacent]
                                id=$this_vampire.id
                            [/filter_adjacent]
                            [not]
                                {VAMPIRE_EXCLUDED_FILTER}
                            [/not]
                            [not]
                            [filter_wml]
                            [status]
                                petrified=yes
                            [/status]
                            [/filter_wml]
                            [/not]
                        ) this_vampire (
                            {VAMPIRE_SPEND_BLOOD_ON_POWER 20 (
                                [sound]
                                    name=magic-dark-big.ogg
                                [/sound]

                                {TURN_INTO_VAMPIRE id=$tmp_power_target_id}

                                [if]
                                {IF_VAMPIRE_UPGRADE_UNLOCKED siring2}
                                [then]
                                    {VARIABLE tmp_vampire_no_xp_loss_on_levelup yes}
                                    {VAMPIRE_LEVELUP id=$tmp_power_target_id}
                                    {CLEAR_VARIABLE tmp_vampire_no_xp_loss_on_levelup}
                                [/then]
                                [/if]

                                [if]
                                {IF_VAMPIRE_UPGRADE_UNLOCKED siring3}
                                [then]
                                    {VARIABLE tmp_vampire_no_xp_loss_on_levelup yes}
                                    {VAMPIRE_LEVELUP id=$tmp_power_target_id}
                                    {CLEAR_VARIABLE tmp_vampire_no_xp_loss_on_levelup}
                                [/then]
                                [/if]

                                [floating_text]
                                   x,y=$tmp_power_target_x,$tmp_power_target_y
                                   text=_"<span color='#ff00ff'>Siring</span>"
                                [/floating_text]

                                {CLEAR_VARIABLE vampirism_menu_active}
                            )}
                        )}
                )}
            [/message]
            [/do]
            [/while]
            {CLEAR_VARIABLE this_vampire}
            [/command]
        [/set_menu_item]
[/event]